"use strict";(self.webpackChunkvuepress_theme_hope_template=self.webpackChunkvuepress_theme_hope_template||[]).push([[5277],{7764(s,n,a){a.r(n),a.d(n,{comp:()=>l,data:()=>p});var i=a(43990);const e={},l=(0,a(24932).A)(e,[["render",function(s,n){return(0,i.uX)(),(0,i.CE)("div",null,[...n[0]||(n[0]=[(0,i.Fv)('<p>DNS外联恶意域名检测告警</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">   Image:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> C:</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\W</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">indows</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\S</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ystem32</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">vchost.exe</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">   ProcessId:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1112</span></span>\n<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">   QueryName:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 7ycb.com</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  微步情报：远控</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  远程控制工具</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-完整的windows启动进程链" tabindex="-1"><a class="header-anchor" href="#_1-完整的windows启动进程链"><span>1. <strong>完整的Windows启动进程链</strong></span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>System (PID 4) </span></span>\n<span class="line"><span>    → smss.exe (Session Manager)</span></span>\n<span class="line"><span>        → wininit.exe (Windows初始化进程)</span></span>\n<span class="line"><span>            → services.exe (服务控制管理器)</span></span>\n<span class="line"><span>                → svchost.exe (服务宿主进程)</span></span>\n<span class="line"><span>        → winlogon.exe (Windows登录进程)</span></span>\n<span class="line"><span>            → userinit.exe (用户初始化)</span></span>\n<span class="line"><span>                → explorer.exe (桌面外壳)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-各进程功能详解" tabindex="-1"><a class="header-anchor" href="#_2-各进程功能详解"><span>2. <strong>各进程功能详解</strong></span></a></h3><h4 id="_1-system-pid-4-系统内核空间进程" tabindex="-1"><a class="header-anchor" href="#_1-system-pid-4-系统内核空间进程"><span><strong>(1) System (PID 4) - 系统内核空间进程</strong></span></a></h4><ul><li><p>​<strong>作用</strong>：Windows内核的化身，运行在核心态（Ring 0）</p></li><li><p>​<strong>功能</strong>：管理硬件抽象层（HAL）、驱动程序、内存分页池</p></li><li><p>​<strong>特点</strong>：父进程为Idle进程（PID 0），所有用户态进程的最终源头</p></li><li><p>​<strong>应急响应关注点</strong>：</p><ul><li>正常情况下不应有子进程（除了smss.exe）</li><li>恶意软件可能注入或伪装为System进程</li></ul></li></ul><h4 id="_2-smss-exe-会话管理器子系统" tabindex="-1"><a class="header-anchor" href="#_2-smss-exe-会话管理器子系统"><span><strong>(2) smss.exe - 会话管理器子系统</strong></span></a></h4><ul><li><p>​<strong>作用</strong>：创建Windows会话环境</p></li><li><p>​<strong>启动时机</strong>：内核初始化完成后</p></li><li><p>​<strong>主要任务</strong>：<br> c</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>1. 创建系统环境变量</span></span>\n<span class="line"><span>2. 加载win32k.sys（Windows子系统内核模块）</span></span>\n<span class="line"><span>3. 启动csrss.exe（客户端/服务器运行时子系统）</span></span>\n<span class="line"><span>4. 启动wininit.exe（系统会话）和winlogon.exe（用户会话）</span></span>\n<span class="line"><span>5. 创建虚拟内存分页文件</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>​<strong>进程特点</strong>：</p><ul><li>第一个用户态进程</li><li>通常有两个实例：一个系统级，一个会话级</li><li>文件名固定为smss.exe，路径必须是System32</li></ul></li><li><p>​<strong>恶意利用场景</strong>：</p><ul><li>进程注入（如Metasploit的migrate）</li><li>持久化驻留（修改注册表启动项）</li></ul></li></ul><h4 id="_3-wininit-exe-windows初始化进程" tabindex="-1"><a class="header-anchor" href="#_3-wininit-exe-windows初始化进程"><span><strong>(3) wininit.exe - Windows初始化进程</strong></span></a></h4><ul><li><p>​<strong>作用</strong>：初始化系统会话（Session 0）</p></li><li><p><strong>主要任务</strong>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>1. 创建%SystemRoot%\\System32目录</span></span>\n<span class="line"><span>2. 启动services.exe（服务控制管理器）</span></span>\n<span class="line"><span>3. 启动lsass.exe（本地安全认证子系统）</span></span>\n<span class="line"><span>4. 启动lsm.exe（本地会话管理器）</span></span>\n<span class="line"><span>5. 初始化Windows服务</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>​<strong>安全特性</strong>：</p><ul><li>运行在Session 0（隔离会话）</li><li>父进程始终是smss.exe</li><li>权限：SYSTEM账户</li></ul></li><li><p><strong>应急检查</strong>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 检查wininit.exe的完整性</span></span>\n<span class="line"><span>Get-AuthenticodeSignature C:\\Windows\\System32\\wininit.exe</span></span>\n<span class="line"><span># 检查子进程是否异常</span></span>\n<span class="line"><span>Get-Process wininit | Select-Object -ExpandProperty Modules | Format-List</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_4-services-exe-服务控制管理器-scm" tabindex="-1"><a class="header-anchor" href="#_4-services-exe-服务控制管理器-scm"><span><strong>(4) services.exe - 服务控制管理器（SCM）</strong></span></a></h4><ul><li><p>​<strong>作用</strong>：Windows服务的&quot;总管家&quot;</p></li><li><p><strong>核心功能</strong>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>1. 维护服务数据库（注册表：HKLM\\SYSTEM\\CurrentControlSet\\Services）</span></span>\n<span class="line"><span>2. 启动、停止、暂停、恢复系统服务</span></span>\n<span class="line"><span>3. 管理服务依赖关系</span></span>\n<span class="line"><span>4. 处理服务控制请求</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>服务启动方式</strong>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>// 服务类型决定启动方式</span></span>\n<span class="line"><span>SERVICE_KERNEL_DRIVER       // 内核驱动</span></span>\n<span class="line"><span>SERVICE_FILE_SYSTEM_DRIVER  // 文件系统驱动</span></span>\n<span class="line"><span>SERVICE_WIN32_OWN_PROCESS   // 独立进程</span></span>\n<span class="line"><span>SERVICE_WIN32_SHARE_PROCESS // 共享进程（svchost）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>注册表结构</strong>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>HKLM\\SYSTEM\\CurrentControlSet\\Services\\&lt;ServiceName&gt;</span></span>\n<span class="line"><span>  ├── ImagePath    // 可执行文件路径</span></span>\n<span class="line"><span>  ├── Start        // 启动类型：2-自动，3-手动，4-禁用</span></span>\n<span class="line"><span>  ├── Type         // 服务类型</span></span>\n<span class="line"><span>  └── Parameters   // 服务参数</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="二、svchost-exe深度解析" tabindex="-1"><a class="header-anchor" href="#二、svchost-exe深度解析"><span>二、svchost.exe深度解析</span></a></h2><h3 id="_1-svchost架构设计原理" tabindex="-1"><a class="header-anchor" href="#_1-svchost架构设计原理"><span>1. <strong>svchost架构设计原理</strong></span></a></h3><h4 id="_1-设计目标" tabindex="-1"><a class="header-anchor" href="#_1-设计目标"><span><strong>(1) 设计目标</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>资源优化：多个服务共享同一进程，减少内存开销</span></span>\n<span class="line"><span>隔离性：不同组服务运行在不同svchost实例</span></span>\n<span class="line"><span>稳定性：一个服务崩溃不影响其他服务</span></span>\n<span class="line"><span>安全性：按权限分组，最小权限原则</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-分组机制" tabindex="-1"><a class="header-anchor" href="#_2-分组机制"><span><strong>(2) 分组机制</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>&lt;!-- 示例：netsvcs组配置 --&gt;</span></span>\n<span class="line"><span>HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Svchost</span></span>\n<span class="line"><span>    ├── netsvcs</span></span>\n<span class="line"><span>    │   ├── Schedule        // 任务计划</span></span>\n<span class="line"><span>    │   ├── Eventlog        // 事件日志</span></span>\n<span class="line"><span>    │   ├── Themes          // 桌面主题</span></span>\n<span class="line"><span>    │   └── ... (共约60个服务)</span></span>\n<span class="line"><span>    ├── LocalService</span></span>\n<span class="line"><span>    ├── NetworkService</span></span>\n<span class="line"><span>    └── LocalSystem</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-进程实例化过程" tabindex="-1"><a class="header-anchor" href="#_3-进程实例化过程"><span><strong>(3) 进程实例化过程</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 1. services.exe读取服务配置</span></span>\n<span class="line"><span># 2. 根据分组创建svchost实例</span></span>\n<span class="line"><span># 3. svchost加载对应服务DLL</span></span>\n<span class="line"><span># 4. 调用ServiceMain()入口函数</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 查看所有svchost分组</span></span>\n<span class="line"><span>Get-ItemProperty &#39;HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Svchost\\*&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-svchost启动参数详解" tabindex="-1"><a class="header-anchor" href="#_2-svchost启动参数详解"><span>2. <strong>svchost启动参数详解</strong></span></a></h3><h4 id="_1-标准启动参数" tabindex="-1"><a class="header-anchor" href="#_1-标准启动参数"><span><strong>(1) 标准启动参数</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 查看具体svchost实例的服务</span></span>\n<span class="line"><span>tasklist /svc /fi &quot;imagename eq svchost.exe&quot;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 对应命令行格式</span></span>\n<span class="line"><span>svchost.exe -k &lt;服务组名称&gt; [-s &lt;服务名称&gt;] [-p]</span></span>\n<span class="line"><span># -k: 指定服务组</span></span>\n<span class="line"><span># -s: 指定具体服务（Windows 10 1709+）</span></span>\n<span class="line"><span># -p: 使用特权减少（Windows 10 1703+）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-在您案例中的分析" tabindex="-1"><a class="header-anchor" href="#_2-在您案例中的分析"><span><strong>(2) 在您案例中的分析</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># PID 1112可能是以下服务组之一：</span></span>\n<span class="line"><span># 常见承载服务组：</span></span>\n<span class="line"><span># -k netsvcs      # 网络服务组（约60个服务）</span></span>\n<span class="line"><span># -k LocalService # 本地服务组</span></span>\n<span class="line"><span># -k NetworkService # 网络服务组</span></span>\n<span class="line"><span># -k LocalSystemNetworkRestricted # 受限系统服务</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 具体确认命令：</span></span>\n<span class="line"><span>wmic process where processid=1112 get commandline</span></span>\n<span class="line"><span># 或</span></span>\n<span class="line"><span>Get-WmiObject Win32_Process -Filter &quot;ProcessId=1112&quot; | Select-Object CommandLine</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-常见svchost承载服务示例" tabindex="-1"><a class="header-anchor" href="#_3-常见svchost承载服务示例"><span>3. <strong>常见svchost承载服务示例</strong></span></a></h3><table><thead><tr><th>服务组</th><th>典型服务</th><th>功能</th><th>应急关注点</th></tr></thead><tbody><tr><td><strong>netsvcs</strong></td><td>​<code>wuauserv</code></td><td>Windows更新</td><td>可能访问外部域名</td></tr><tr><td></td><td>​<code>BITS</code></td><td>后台智能传输</td><td>常用于C2通信</td></tr><tr><td></td><td>​<code>EventLog</code></td><td>事件日志</td><td>日志伪造</td></tr><tr><td><strong>LocalService</strong></td><td>​<code>Dhcp</code></td><td>DHCP客户端</td><td>网络配置异常</td></tr><tr><td></td><td>​<code>WinHttpAutoProxySvc</code></td><td>代理自动发现</td><td>代理劫持</td></tr><tr><td><strong>NetworkService</strong></td><td>​<code>Dnscache</code></td><td>DNS客户端缓存</td><td>DNS投毒</td></tr><tr><td></td><td>​<code>NlaSvc</code></td><td>网络位置感知</td><td>网络探测</td></tr></tbody></table><h2 id="三、应急响应中的进程链分析" tabindex="-1"><a class="header-anchor" href="#三、应急响应中的进程链分析"><span>三、应急响应中的进程链分析</span></a></h2><h3 id="_1-正常vs异常特征对比" tabindex="-1"><a class="header-anchor" href="#_1-正常vs异常特征对比"><span>1. <strong>正常vs异常特征对比</strong></span></a></h3><h4 id="​正常特征" tabindex="-1"><a class="header-anchor" href="#​正常特征"><span>​<strong>正常特征</strong>：</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>smss.exe:</span></span>\n<span class="line"><span>  - 父进程: System (PID 4)</span></span>\n<span class="line"><span>  - 子进程: csrss.exe, wininit.exe, winlogon.exe</span></span>\n<span class="line"><span>  - 数量: 通常2个（系统+会话）</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>wininit.exe:</span></span>\n<span class="line"><span>  - 会话: Session 0</span></span>\n<span class="line"><span>  - 子进程: services.exe, lsass.exe</span></span>\n<span class="line"><span>  - 权限: SYSTEM</span></span>\n<span class="line"><span>  </span></span>\n<span class="line"><span>services.exe:</span></span>\n<span class="line"><span>  - 子进程: 多个svchost.exe实例</span></span>\n<span class="line"><span>  - 无命令行参数</span></span>\n<span class="line"><span>  - 路径: System32\\services.exe</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="​异常特征-恶意指标" tabindex="-1"><a class="header-anchor" href="#​异常特征-恶意指标"><span>​<strong>异常特征（恶意指标）</strong> ：</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>1. 进程链断裂: services.exe -&gt; 未知进程 -&gt; svchost.exe</span></span>\n<span class="line"><span>2. 路径异常: svchost.exe不在System32或SysWOW64</span></span>\n<span class="line"><span>3. 命令行异常: 包含可疑参数或URL</span></span>\n<span class="line"><span>4. 网络连接: 连接非常用端口或恶意IP</span></span>\n<span class="line"><span>5. 签名异常: 无Microsoft签名或签名无效</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-针对您案例的深度分析框架" tabindex="-1"><a class="header-anchor" href="#_2-针对您案例的深度分析框架"><span>2. <strong>针对您案例的深度分析框架</strong></span></a></h3><h4 id="第一步-确认svchost实例细节" tabindex="-1"><a class="header-anchor" href="#第一步-确认svchost实例细节"><span><strong>第一步：确认svchost实例细节</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 1. 获取完整命令行</span></span>\n<span class="line"><span>$process = Get-Process -Id 1112</span></span>\n<span class="line"><span>$process.Path              # 文件路径</span></span>\n<span class="line"><span>$process.StartInfo.Arguments  # 启动参数</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 2. 查看承载服务</span></span>\n<span class="line"><span>$services = Get-WmiObject Win32_Service | Where-Object {</span></span>\n<span class="line"><span>    $_.ProcessId -eq 1112</span></span>\n<span class="line"><span>}</span></span>\n<span class="line"><span>$services | Format-Table Name, DisplayName, State, PathName</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 3. 检查网络连接</span></span>\n<span class="line"><span>Get-NetTCPConnection -OwningProcess 1112</span></span>\n<span class="line"><span>Get-NetUDPEndpoint -OwningProcess 1112</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第二步-dns请求来源追踪" tabindex="-1"><a class="header-anchor" href="#第二步-dns请求来源追踪"><span><strong>第二步：DNS请求来源追踪</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 使用Process Monitor过滤</span></span>\n<span class="line"><span># 筛选条件: </span></span>\n<span class="line"><span># Process Name: svchost.exe</span></span>\n<span class="line"><span># Operation: DNS Query</span></span>\n<span class="line"><span># Path: contains &quot;7ycb.com&quot;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 或使用ETW实时追踪</span></span>\n<span class="line"><span>logman create trace DNS_Trace -o dns.etl -p &quot;Microsoft-Windows-DNS-Client&quot;</span></span>\n<span class="line"><span>logman start DNS_Trace</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第三步-服务行为分析" tabindex="-1"><a class="header-anchor" href="#第三步-服务行为分析"><span><strong>第三步：服务行为分析</strong></span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 如果确认是某个具体服务</span></span>\n<span class="line"><span>$serviceName = &quot;wuauserv&quot;  # 示例</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 1. 查看服务配置</span></span>\n<span class="line"><span>sc qc $serviceName</span></span>\n<span class="line"><span>sc queryex $serviceName</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 2. 查看服务依赖</span></span>\n<span class="line"><span>Get-Service $serviceName -DependentServices</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 3. 查看服务触发器（可能定时触发）</span></span>\n<span class="line"><span>sc qtriggerinfo $serviceName</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-恶意svchost利用手法与检测" tabindex="-1"><a class="header-anchor" href="#_3-恶意svchost利用手法与检测"><span>3. <strong>恶意svchost利用手法与检测</strong></span></a></h3><h4 id="​常见攻击手法" tabindex="-1"><a class="header-anchor" href="#​常见攻击手法"><span>​<strong>常见攻击手法</strong>：</span></a></h4><ol><li><p><strong>服务劫持</strong>：修改合法服务配置</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 检测：检查服务二进制路径</span></span>\n<span class="line"><span>Get-WmiObject Win32_Service | </span></span>\n<span class="line"><span>  Where-Object {$_.PathName -match &quot;svchost&quot;} |</span></span>\n<span class="line"><span>  Select-Object Name, PathName</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>DLL劫持</strong>：利用服务DLL加载顺序</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 检测：使用Process Explorer查看加载的DLL</span></span>\n<span class="line"><span># 或使用：Get-Process -Id 1112 -Module</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>内存注入</strong>：无文件攻击</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 检测：检查内存区域异常</span></span>\n<span class="line"><span>.\\Sysinternals\\VMMap.exe -p 1112</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>隐藏服务</strong>：注册表隐藏</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 检测：比较services.exe和注册表的差异</span></span>\n<span class="line"><span>Get-Service | Select-Object Name | Out-File services.txt</span></span>\n<span class="line"><span>reg query &quot;HKLM\\SYSTEM\\CurrentControlSet\\Services&quot; /s</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="_4-实战分析示例-dns请求追踪" tabindex="-1"><a class="header-anchor" href="#_4-实战分析示例-dns请求追踪"><span>4. <strong>实战分析示例：DNS请求追踪</strong></span></a></h3><p>基于您的案例，建议分析流程：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># 1. 确认是哪个服务</span></span>\n<span class="line"><span>$services = Get-WmiObject Win32_Service | Where-Object {</span></span>\n<span class="line"><span>    $_.ProcessId -eq 1112</span></span>\n<span class="line"><span>}</span></span>\n<span class="line"><span>Write-Host &quot;PID 1112承载的服务:&quot; -ForegroundColor Yellow</span></span>\n<span class="line"><span>$services | Format-List Name, DisplayName, Description</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 2. 如果是wuauserv（Windows更新）</span></span>\n<span class="line"><span># 检查更新配置</span></span>\n<span class="line"><span>reg query &quot;HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate&quot;</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 3. 如果是BITS服务</span></span>\n<span class="line"><span># 检查传输队列</span></span>\n<span class="line"><span>Get-BitsTransfer</span></span>\n<span class="line"><span></span></span>\n<span class="line"><span># 4. 如果是计划任务服务</span></span>\n<span class="line"><span># 检查相关任务</span></span>\n<span class="line"><span>Get-ScheduledTask | Where-Object {</span></span>\n<span class="line"><span>    $_.TaskPath -match &quot;Update&quot; -or </span></span>\n<span class="line"><span>    $_.Actions -match &quot;7ycb&quot;</span></span>\n<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="四、总结与最佳实践" tabindex="-1"><a class="header-anchor" href="#四、总结与最佳实践"><span>四、总结与最佳实践</span></a></h2><h3 id="​应急响应检查清单" tabindex="-1"><a class="header-anchor" href="#​应急响应检查清单"><span>​<strong>应急响应检查清单</strong>：</span></a></h3><ol><li>✅ 进程链完整性（System → smss → wininit → services → svchost）</li><li>✅ 文件路径验证（System32目录）</li><li>✅ 数字签名验证（Microsoft签名）</li><li>✅ 命令行参数分析（-k参数分组）</li><li>✅ 网络连接审查（端口、协议、目标）</li><li>✅ 服务配置检查（注册表、依赖、触发器）</li><li>✅ 时间线分析（启动时间、请求频率）</li></ol><p>‍</p>',51)])])}]]),p=JSON.parse('{"path":"/ai/Windows%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E9%93%BE%E4%B8%8Esvchost%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90.html","title":"Windows核心系统进程链与svchost深度解析","lang":"zh-CN","frontmatter":{"title":"Windows核心系统进程链与svchost深度解析","tag":["AI对话笔记"],"category":["AI对话笔记"],"timeline":true,"isOriginal":false,"index":true,"description":"DNS外联恶意域名检测告警 1. 完整的Windows启动进程链 2. 各进程功能详解 (1) System (PID 4) - 系统内核空间进程 ​作用：Windows内核的化身，运行在核心态（Ring 0） ​功能：管理硬件抽象层（HAL）、驱动程序、内存分页池 ​特点：父进程为Idle进程（PID 0），所有用户态进程的最终源头 ​应急响应关注点...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Windows核心系统进程链与svchost深度解析\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-12-20T08:26:40.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"卷卷\\"}]}"],["meta",{"property":"og:url","content":"https://youze27.github.io/ai/Windows%E6%A0%B8%E5%BF%83%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E9%93%BE%E4%B8%8Esvchost%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90.html"}],["meta",{"property":"og:site_name","content":"卷卷"}],["meta",{"property":"og:title","content":"Windows核心系统进程链与svchost深度解析"}],["meta",{"property":"og:description","content":"DNS外联恶意域名检测告警 1. 完整的Windows启动进程链 2. 各进程功能详解 (1) System (PID 4) - 系统内核空间进程 ​作用：Windows内核的化身，运行在核心态（Ring 0） ​功能：管理硬件抽象层（HAL）、驱动程序、内存分页池 ​特点：父进程为Idle进程（PID 0），所有用户态进程的最终源头 ​应急响应关注点..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-12-20T08:26:40.000Z"}],["meta",{"property":"article:tag","content":"AI对话笔记"}],["meta",{"property":"article:modified_time","content":"2025-12-20T08:26:40.000Z"}]]},"git":{"createdTime":1766219200000,"updatedTime":1766219200000,"contributors":[{"name":"youze27","username":"youze27","email":"92211723+youze27@users.noreply.github.com","commits":1,"url":"https://github.com/youze27"}]},"readingTime":{"minutes":6.27,"words":1882},"filePathRelative":"ai/Windows核心系统进程链与svchost深度解析.md","excerpt":"<p>DNS外联恶意域名检测告警</p>\\n<div class=\\"language-bash line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"bash\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code class=\\"language-bash\\"><span class=\\"line\\"><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">   Image:</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> C:</span><span style=\\"--shiki-light:#0184BC;--shiki-dark:#56B6C2\\">\\\\W</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\">indows</span><span style=\\"--shiki-light:#0184BC;--shiki-dark:#56B6C2\\">\\\\S</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\">ystem32</span><span style=\\"--shiki-light:#0184BC;--shiki-dark:#56B6C2\\">\\\\s</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\">vchost.exe</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">   ProcessId:</span><span style=\\"--shiki-light:#986801;--shiki-dark:#D19A66\\"> 1112</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">   QueryName:</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\"> 7ycb.com</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\">  微步情报：远控</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\">  远程控制工具</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}')},24932(s,n){n.A=(s,n)=>{const a=s.__vccOpts||s;for(const[s,i]of n)a[s]=i;return a}}}]);